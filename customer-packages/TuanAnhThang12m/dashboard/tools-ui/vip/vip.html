<!-- Load Common CSS -->
<link rel="stylesheet" href="tools-ui/common.css">
<!-- Load VIP Tool Specific CSS -->
<link rel="stylesheet" href="tools-ui/vip/vip.css">
<!-- Load Shared JS -->
<script src="tools-ui/shared/shared.js"></script>
<!-- Load Profile Manager -->
<script src="core/profile-manager.js"></script>
<!-- Load API Key Manager -->
<script src="core/api-key-manager.js"></script>

<!-- Load VIP Config -->
<script>
    let vipConfig = null;
    let configLoaded = false;

    // Load config from server API (dynamic from vip-automation.js)
    async function loadVipConfig() {
        try {
            // First, try to load from server API to get dynamic config from vip-automation.js
            const categories = ['okvip', 'accOkvip', 'abcvip', 'jun88', '78win', 'jun88v2', 'kjc'];
            const sitesData = {};

            for (const category of categories) {
                try {
                    const response = await fetch(`/api/vip-automation/category/${category}`);
                    const result = await response.json();
                    if (result.success && result.data && result.data.sites) {
                        sitesData[category] = result.data.sites;
                        console.log(`‚úÖ Loaded ${result.data.sites.length} sites for ${category} from server`);
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è Failed to load ${category} from server, will use fallback`);
                }
            }

            // Build config with server data
            vipConfig = {
                categories: [
                    { id: 'okvip', icon: 'üé∞', name: 'OKVIP', color: '#ff6b35' },
                    { id: 'accOkvip', icon: 'üìù', name: 'AccOKVIP', color: '#ff8c42' },
                    { id: 'abcvip', icon: 'üé≤', name: 'ABCVIP', color: '#0066cc' },
                    { id: 'jun88', icon: 'üéØ', name: 'JUN88', color: '#00aa00' },
                    { id: '78win', icon: 'üéØ', name: '78WIN', color: '#ff9900' },
                    {
                        id: 'jun88v2', icon: 'ÔøΩ', name: 'JUN88V2', color: '#0099cc'
                    },
                    { id: 'kjc', icon: 'üé™', name: 'KJC', color: '#cc0000' }
                ],
                sites: sitesData
            };

            configLoaded = true;
            console.log('‚úÖ VIP Config loaded from server:', vipConfig);
            // Trigger any pending operations
            if (window.pendingCategoryLoad) {
                loadCategoryManagementContent(window.pendingCategoryLoad);
                window.pendingCategoryLoad = null;
            }
        } catch (error) {
            console.error('‚ùå Failed to load VIP config from server:', error);
            // Fallback to default config
            vipConfig = {
                categories: [
                    { id: 'okvip', icon: 'üé∞', name: 'OKVIP', color: '#ff6b35' },
                    { id: 'accOkvip', icon: 'üìù', name: 'AccOKVIP', color: '#ff8c42' },
                    { id: 'abcvip', icon: 'ÔøΩ,', name: 'ABCVIP', color: '#0066cc' },
                    { id: 'jun88', icon: 'üéØ', name: 'JUN88', color: '#00aa00' },
                    { id: '78win', icon: 'üéØ', name: '78WIN', color: '#ff9900' },
                    { id: 'jun88v2', icon: 'ÔøΩa', name: 'JUN88V2', color: '#0099cc' },
                    { id: 'kjc', icon: 'üé™', name: 'KJC', color: '#cc0000' }
                ],
                sites: {
                    'okvip': [
                        { name: 'Hi88', registerUrl: 'https://m.www-24h-com-vn-com.com/Account/Register', checkPromoUrl: 'https://tangqua88.com/?promo_id=KM58' },
                        { name: 'F8BET', registerUrl: 'https://m.jsdujkg8djjkuqw8czbm.com/Account/Register', checkPromoUrl: 'https://ttkm-f8bet01.pages.dev/?promo_id=KM68' },
                        { name: 'SHBET', registerUrl: 'https://m.djifshuie89shjdhsdxbvckrgio.com/Account/Register', checkPromoUrl: 'https://khuyenmai-shbet02.pages.dev/?promo_id=SH57K' },
                        { name: 'NEW88', registerUrl: 'https://m.dxiidnc84gkoopfcmbpwhsgf.com/Account/Register', checkPromoUrl: 'https://khuyenmai-new88okvip1.pages.dev/?promo_id=N58' },
                        { name: 'MB66', registerUrl: 'https://m.wtyurfuijkxcvklrhyli3imxjuuflegmgkiow3i.com/Account/Register', checkPromoUrl: 'https://ttkm-mb66okvip02.pages.dev/?promo_id=FREE66' },
                        { name: '789BET', registerUrl: 'https://m.hsdh99hjsbcnjiufkxuuwvg.com/Account/Register', checkPromoUrl: 'https://ttkm789bet04.pages.dev/khuyenmai/?promo_id=FR58K' }
                    ],
                    'accOkvip': [
                        { name: 'Hi88', registerUrl: 'https://m.www-24h-com-vn-com.com/Account/Register', checkPromoUrl: 'https://tangqua88.com/?promo_id=KM58' },
                        { name: 'F8BET', registerUrl: 'https://m.jsdujkg8djjkuqw8czbm.com/Account/Register', checkPromoUrl: 'https://ttkm-f8bet01.pages.dev/?promo_id=KM68' },
                        { name: 'SHBET', registerUrl: 'https://m.djifshuie89shjdhsdxbvckrgio.com/Account/Register', checkPromoUrl: 'https://khuyenmai-shbet02.pages.dev/?promo_id=SH57K' },
                        { name: 'NEW88', registerUrl: 'https://m.dxiidnc84gkoopfcmbpwhsgf.com/Account/Register', checkPromoUrl: 'https://khuyenmai-new88okvip1.pages.dev/?promo_id=N58' },
                        { name: 'MB66', registerUrl: 'https://m.wtyurfuijkxcvklrhyli3imxjuuflegmgkiow3i.com/Account/Register', checkPromoUrl: 'https://ttkm-mb66okvip02.pages.dev/?promo_id=FREE66' },
                        { name: '789BET', registerUrl: 'https://m.hsdh99hjsbcnjiufkxuuwvg.com/Account/Register', checkPromoUrl: 'https://ttkm789bet04.pages.dev/khuyenmai/?promo_id=FR58K' }
                    ],
                    'abcvip': [
                        { name: 'U888', registerUrl: 'https://m.u888at.link/?f=2551606&app=1/Account/Register', checkPromoUrl: 'https://88u888.club/' },
                        { name: 'J88', registerUrl: 'https://m.j859.xyz/?f=4556781&app=1/Account/Register', checkPromoUrl: 'https://j8j88.com/' },
                        { name: 'ABC8', registerUrl: 'https://m.abc11.link/?f=109114&app=1/Account/Register', checkPromoUrl: 'https://www.88abc8.cc/' },
                        { name: '888clb', registerUrl: 'https://88clb2jt.buzz/?f=889534&app=1/Account/Register', checkPromoUrl: 'https://88clb88.xyz/' }
                    ],
                    'jun88': [
                        { name: 'Jun881', registerUrl: 'https://sasa2.xn--8866-um1g.com/signup', checkPromoUrl: 'https://trungtam.khuyenmaijun881.win/?promo_id=FR58' }
                    ],
                    '78win': [
                        { name: '78WIN1', registerUrl: 'https://www.78win6.zone/signup', checkPromoUrl: 'https://daily78win.net/' }
                    ],
                    'kjc': [
                        { name: 'KJC1', registerUrl: 'https://kjc1.com/register', checkPromoUrl: 'https://kjc1.com/promo' },
                        { name: 'KJC2', registerUrl: 'https://kjc2.com/register', checkPromoUrl: 'https://kjc2.com/promo' },
                        { name: 'KJC3', registerUrl: 'https://kjc3.com/register', checkPromoUrl: 'https://kjc3.com/promo' }
                    ]
                }
            };
            configLoaded = true;
        }
    }

    // Load config immediately
    loadVipConfig();
</script>

<!-- VIP Auto Tool UI -->
<div class="vip-tool-container">

    <!-- Info Banner -->
    <div class="info-banner">
        <h3>üé≤ VIP Auto Tool</h3>
        <p>T·ª± ƒë·ªông ƒëƒÉng k√Ω, ƒëƒÉng nh·∫≠p, th√™m ng√¢n h√†ng v√† check khuy·∫øn m√£i cho c√°c trang VIP</p>
    </div>

    <!-- Results Full Width -->
    <div class="results-full-width">
        <!-- Header with START button -->
        <div class="results-header">
            <h2>üìä K·∫øt Qu·∫£ Automation</h2>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="refreshResults()">
                    üîÑ T·∫£i L·∫°i
                </button>
                <button class="btn btn-warning btn-sm" onclick="deleteSelectedResults()">
                    üóëÔ∏è X√≥a ƒê√£ Ch·ªçn
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteAllResults()"
                    style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none;">
                    üóëÔ∏è X√≥a T·∫•t C·∫£
                </button>
                <button class="btn btn-start" onclick="openFormModal()">
                    <span class="start-icon">‚ñ∂Ô∏è</span>
                    <span class="start-text">START</span>
                </button>

            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-table-wrapper">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"
                                    style="cursor: pointer; width: 18px; height: 18px;">
                            </th>
                            <th>Profile</th>
                            <th style="text-align: center;">Sites</th>
                            <th>T√†i Kho·∫£n</th>
                            <th style="text-align: center;">K·∫øt Qu·∫£</th>
                            <th>L√Ω Do</th>
                            <th>Th·ªùi Gian</th>
                            <th style="text-align: center;">H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr>
                            <td colspan="9" style="text-align: center; color: #a0aec0; padding: 40px;">
                                Ch∆∞a c√≥ k·∫øt qu·∫£. Ch·∫°y automation ƒë·ªÉ xem k·∫øt qu·∫£ ·ªü ƒë√¢y.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls" id="paginationControls">
                <div class="pagination-info">
                    Hi·ªÉn th·ªã <span id="pageStart">0</span>-<span id="pageEnd">0</span> / <span
                        id="totalResults">0</span>
                    k·∫øt qu·∫£
                </div>
                <div class="pagination-buttons">
                    <button class="btn btn-sm" onclick="goToFirstPage()" id="btnFirst">‚èÆÔ∏è ƒê·∫ßu</button>
                    <button class="btn btn-sm" onclick="goToPrevPage()" id="btnPrev">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="page-indicator">
                        Trang <span id="currentPage">1</span> / <span id="totalPages">1</span>
                    </span>
                    <button class="btn btn-sm" onclick="goToNextPage()" id="btnNext">Sau ‚ñ∂Ô∏è</button>
                    <button class="btn btn-sm" onclick="goToLastPage()" id="btnLast">Cu·ªëi ‚è≠Ô∏è</button>
                </div>
                <div class="pagination-size">
                    <span style="color: #6b7280; font-size: 13px;">
                        üìè 5 k·∫øt qu·∫£ m·ªói trang
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Modal -->
    <div class="form-modal" id="formModal">
        <div class="modal-content-form">
            <!-- Modal Header -->
            <div class="modal-header-form">
                <h2>üé≤ VIP Auto Tool</h2>
                <button class="modal-close-form" onclick="closeFormModal()">√ó</button>
            </div>

            <!-- Tabs in Modal -->
            <div class="modal-tabs">
                <div class="modal-tabs-left">
                    <div class="modal-tab active" data-tab="auto" onclick="switchModalTab('auto')">
                        ü§ñ T·ª± ƒê·ªông
                    </div>
                    <div class="modal-tab" data-tab="promo" onclick="switchModalTab('promo')">
                        üéÅ Check KM
                    </div>
                    <!-- Category Badge -->
                    <div id="categoryBadge"
                        style="margin-left: auto; padding: 6px 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                        <span id="categoryIcon">üé∞</span>
                        <span id="categoryName">OKVIP</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-warning btn-sm" onclick="clearAllRunningStatuses()"
                        title="Clear t·∫•t c·∫£ tr·∫°ng th√°i running" style="padding: 8px 12px; font-size: 12px;">
                        üîÑ Clear Running
                    </button>
                    <button class="btn-run-action" id="btnRunAction" onclick="runCurrentTabAction()">
                        üöÄ CH·∫†Y
                    </button>
                </div>
            </div>

            <!-- Warning Banner - Full Width -->
            <div
                style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; padding: 12px; border: 1px solid #f59e0b; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15); margin: 0 20px 12px 20px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <div style="font-size: 20px; line-height: 1; flex-shrink: 0;">üí°</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 4px;">Khuy·∫øn ngh·ªã
                            s·ª≠ d·ª•ng</div>
                        <div style="display: flex; flex-direction: column; gap: 3px; font-size: 11px; color: #78350f;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: #f59e0b;">‚óè</span>
                                <span>N√™n <strong>m·ªü profile c·∫ßn ch·∫°y</strong> trong Hidemium tr∆∞·ªõc khi s·ª≠ d·ª•ng
                                    tool</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: #f59e0b;">‚óè</span>
                                <span><strong>Song Song (3-5 sites)</strong>: Nhanh h∆°n, ph√π h·ª£p m√°y m·∫°nh</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: #f59e0b;">‚óè</span>
                                <span><strong>Tu·∫ßn T·ª±</strong>: ·ªîn ƒë·ªãnh h∆°n, ph√π h·ª£p m√°y y·∫øu ho·∫∑c m·∫°ng ch·∫≠m</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="modal-body-form" id="modalBodyForm">

                <!-- LEFT COLUMN: Sites Selection -->
                <div class="modal-sites-column">
                    <!-- Category Selection (VIP-specific) -->
                    <div id="categorySelector"
                        style="margin-bottom: 12px; padding: 8px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 6px 0; color: #4a5568; font-size: 12px; font-weight: 600;">üéØ Ch·ªçn
                            Category</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 8px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb; transition: all 0.2s;"
                                class="category-label">
                                <input type="radio" name="vipCategory" value="okvip" checked
                                    onchange="toggleCategorySites()"
                                    style="width: 14px; height: 14px; cursor: pointer;">
                                <span style="font-size: 11px; font-weight: 600;">üé∞ OKVIP</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 8px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb; transition: all 0.2s;"
                                class="category-label">
                                <input type="radio" name="vipCategory" value="accOkvip" onchange="toggleCategorySites()"
                                    style="width: 14px; height: 14px; cursor: pointer;">
                                <span style="font-size: 11px; font-weight: 600;">üìù AccOKVIP</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 8px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb; transition: all 0.2s;"
                                class="category-label">
                                <input type="radio" name="vipCategory" value="abcvip" onchange="toggleCategorySites()"
                                    style="width: 14px; height: 14px; cursor: pointer;">
                                <span style="font-size: 11px; font-weight: 600;">üé≤ ABCVIP</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 8px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb; transition: all 0.2s;"
                                class="category-label">
                                <input type="radio" name="vipCategory" value="jun88" onchange="toggleCategorySites()"
                                    style="width: 14px; height: 14px; cursor: pointer;">
                                <span style="font-size: 11px; font-weight: 600;">üéØ JUN88</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 8px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb; transition: all 0.2s;"
                                class="category-label">
                                <input type="radio" name="vipCategory" value="78win" onchange="toggleCategorySites()"
                                    style="width: 14px; height: 14px; cursor: pointer;">
                                <span style="font-size: 11px; font-weight: 600;">üéØ 78WIN</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 8px; background: #f3f4f6; border-radius: 6px; border: 2px solid #d1d5db; transition: all 0.2s;"
                                class="category-label" title="JUN88V2">
                                <input type="radio" name="vipCategory" value="jun88v2" onchange="toggleCategorySites()"
                                    style="width: 14px; height: 14px; cursor: pointer;">
                                <span style="font-size: 11px; font-weight: 600; color: #374151;">üéØ JUN88V2</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: not-allowed; padding: 6px 8px; background: #f3f4f6; border-radius: 6px; border: 2px solid #d1d5db; transition: all 0.2s; opacity: 0.5;"
                                class="category-label" title="B·∫£o tr√¨ - s·∫Ω b·∫≠t l·∫°i sau">
                                <input type="radio" name="vipCategory" value="kjc" onchange="toggleCategorySites()"
                                    style="width: 14px; height: 14px; cursor: not-allowed;" disabled>
                                <span style="font-size: 11px; font-weight: 600; color: #9ca3af;">üé™ KJC (B·∫£o tr√¨)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Sites Grid (will change based on category) -->
                    <div id="sitesGroup" style="margin-bottom: 12px;">
                        <h4 style="margin: 0 0 8px 0; color: #4a5568; font-size: 13px; font-weight: 600;">
                            üì± Ch·ªçn Sites
                        </h4>
                        <div class="sites-grid" id="vipSitesGrid"
                            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 10px;">
                            <!-- Sites will be loaded dynamically -->
                        </div>
                    </div>
                    <div class="site-actions"
                        style="gap: 8px; margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr;">
                        <button class="btn btn-sm" onclick="selectAllVipSites()"
                            style="padding: 10px 16px; font-size: 13px; font-weight: 700; height: 40px;">‚úÖ Ch·ªçn T·∫•t
                            C·∫£</button>
                        <button class="btn btn-sm" onclick="deselectAllVipSites()"
                            style="padding: 10px 16px; font-size: 13px; font-weight: 700; height: 40px;">‚ùå B·ªè
                            Ch·ªçn</button>
                    </div>

                    <!-- Execution Mode -->
                    <div
                        style="padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: #4a5568; font-size: 13px; font-weight: 600;">‚öôÔ∏è Ch·∫ø ƒê·ªô
                            Ch·∫°y</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; flex: 1;">
                                <input type="radio" name="executionMode" value="parallel" checked
                                    style="width: 16px; height: 16px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 12px; color: #2d3748;">üöÄ Song Song</div>
                                    <div style="font-size: 10px; color: #718096;">Nhanh h∆°n</div>
                                </div>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; flex: 1;">
                                <input type="radio" name="executionMode" value="sequential"
                                    style="width: 16px; height: 16px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 12px; color: #2d3748;">üìã Tu·∫ßn T·ª±</div>
                                    <div style="font-size: 10px; color: #718096;">·ªîn ƒë·ªãnh h∆°n</div>
                                </div>
                            </label>
                        </div>
                        <div id="parallelOptions" style="margin-top: 8px;">
                            <label
                                style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #4a5568;">
                                <span>S·ªë sites c√πng l√∫c:</span>
                                <select id="parallelCount"
                                    style="padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0; font-size: 12px;">
                                    <option value="0">T·∫•t c·∫£</option>
                                    <option value="3" selected>3</option>
                                    <option value="5">5</option>
                                    <option value="7">7</option>
                                </select>
                            </label>
                        </div>
                    </div>

                    <!-- Delay Captcha -->
                    <div
                        style="padding: 10px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe; margin-bottom: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 13px; font-weight: 600;">‚è±Ô∏è Delay
                            Captcha</h4>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #1e40af;">
                            <span>Ch·ªù tr∆∞·ªõc khi submit:</span>
                            <select id="autoCaptchaDelay"
                                style="padding: 6px 10px; border-radius: 6px; border: 1px solid #bfdbfe; font-size: 12px; background: white;">
                                <option value="0">Kh√¥ng delay (0s)</option>
                                <option value="5">5 gi√¢y</option>
                                <option value="10" selected>10 gi√¢y</option>
                                <option value="15">15 gi√¢y</option>
                                <option value="20">20 gi√¢y</option>
                                <option value="30">30 gi√¢y</option>
                            </select>
                        </label>
                        <div style="font-size: 11px; color: #1e40af; margin-top: 6px; font-style: italic;">
                            üí° Tr√°nh detect bot, ƒë·ªÉ tool t·ª± ƒë·ªông ch·∫°y
                        </div>
                    </div>


                </div>

                <!-- RIGHT COLUMN: Form Inputs -->
                <div class="modal-form-column">
                    <!-- Tab Content: Auto -->
                    <div class="tab-content active" id="tab-auto">
                        <!-- Profile Selection -->
                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üìã Ch·ªçn Profile</h3>
                                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()"
                                    title="T·∫£i l·∫°i profiles">üîÑ T·∫£i L·∫°i</button>
                            </div>
                            <div class="profile-carousel-wrapper">
                                <div class="profile-carousel-container">
                                    <button class="carousel-btn carousel-prev"
                                        onclick="scrollProfileCarousel('auto', -1)">‚Äπ</button>
                                    <div class="profile-carousel" id="autoProfileCarousel">
                                        <div class="profile-carousel-empty">
                                            <p>Click "T·∫£i L·∫°i" ƒë·ªÉ xem profiles</p>
                                        </div>
                                    </div>
                                    <button class="carousel-btn carousel-next"
                                        onclick="scrollProfileCarousel('auto', 1)">‚Ä∫</button>
                                </div>
                            </div>
                        </div>

                        <!-- Account Info -->
                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üë§ Th√¥ng Tin T√†i Kho·∫£n</h3>
                                <div style="display: flex; gap: 8px;">
                                    <select id="simMode" class="form-input"
                                        style="width: auto; padding: 6px 10px; font-size: 12px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;"
                                        title="Ch·ªçn c√°ch l·∫•y s·ªë ƒëi·ªán tho·∫°i cho AccOKVIP">
                                        <option value="api">üì± API SIM</option>
                                        <option value="manual">‚úèÔ∏è ƒêi·ªÅn SƒêT</option>
                                    </select>
                                    <button class="btn btn-secondary btn-sm" onclick="randomAllForm()"
                                        title="Random to√†n b·ªô form">üé≤
                                        Random</button>
                                    <button class="btn btn-secondary btn-sm" onclick="resetFormInputs()"
                                        title="Reset form v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu">üîÑ
                                        Reset</button>
                                </div>
                            </div>
                            <div class="form-grid">
                                <input type="text" id="autoUsername" placeholder="T√™n t√†i kho·∫£n" class="form-input">
                                <input type="text" id="autoFullname" placeholder="H·ªç v√† T√™n (IN HOA)"
                                    class="form-input">
                                <input type="text" id="autoPassword" placeholder="M·∫≠t kh·∫©u" class="form-input">
                                <input type="text" id="autoWithdrawPassword" placeholder="M·∫≠t kh·∫©u r√∫t ti·ªÅn"
                                    class="form-input">
                                <input type="email" id="autoEmail" placeholder="Email" class="form-input">
                                <input type="tel" id="autoPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i (10-11 ch·ªØ s·ªë)"
                                    class="form-input">
                                <select id="autoBankName" class="form-input">
                                    <option value="">-- Ch·ªçn ng√¢n h√†ng --</option>
                                    <option value="VIETINBANK">VIETINBANK</option>
                                    <option value="TECHCOMBANK">TECHCOMBANK</option>
                                    <option value="BIDV">BIDV</option>
                                    <option value="VIETCOMBANK">VIETCOMBANK</option>
                                    <option value="MBBANK">MBBANK</option>
                                    <option value="TPBANK">TPBANK</option>
                                    <option value="VPBANK">VPBANK</option>
                                    <option value="SACOMBANK">SACOMBANK</option>
                                    <option value="ACB">ACB</option>
                                </select>
                                <input type="text" id="autoAccountNumber" placeholder="S·ªë t√†i kho·∫£n ng√¢n h√†ng"
                                    class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Check Promo -->
                    <div class="tab-content" id="tab-promo">
                        <div class="form-section">
                            <h3>üìã Ch·ªçn Profile</h3>
                            <div class="profile-carousel-wrapper">
                                <div class="profile-carousel-container">
                                    <button class="carousel-btn carousel-prev"
                                        onclick="scrollProfileCarousel('promo', -1)">‚Äπ</button>
                                    <div class="profile-carousel" id="promoProfileCarousel">
                                        <div class="profile-carousel-empty">
                                            <p>Click "T·∫£i L·∫°i" ƒë·ªÉ xem profiles</p>
                                        </div>
                                    </div>
                                    <button class="carousel-btn carousel-next"
                                        onclick="scrollProfileCarousel('promo', 1)">‚Ä∫</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üë§ Th√¥ng Tin Check</h3>
                            <div class="form-grid">
                                <input type="text" id="promoUsername" placeholder="T√™n t√†i kho·∫£n ƒë√£ ƒëƒÉng k√Ω"
                                    class="form-input">
                                <input type="text" id="promoApiKey" placeholder="API Key t·ª´ autocaptcha.pro"
                                    class="form-input">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Form Modal -->

    <!-- Account Info Modal -->
    <div id="vipAccountInfoModal" class="screenshots-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeVipAccountInfoModal()"></div>
        <div class="modal-content-large">
            <div class="modal-header">
                <h3 id="vipAccountInfoTitle">üìã Th√¥ng Tin T√†i Kho·∫£n</h3>
                <button class="modal-close" onclick="closeVipAccountInfoModal()">√ó</button>
            </div>
            <div class="modal-body" id="vipAccountInfoContent" style="padding: 20px;">
                <!-- Account info will be loaded here -->
            </div>
        </div>
    </div>



    <!-- Category Management Modal - Full Screen -->
    <div id="categoryManagementModal" class="screenshots-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeCategoryManagementModal()"></div>
        <div
            style="position: relative; background: white; width: 95vw; height: 95vh; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); z-index: 1; display: flex; flex-direction: column;">
            <!-- Header -->
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: white; flex-shrink: 0;">
                <h2 style="margin: 0; font-size: 22px; font-weight: 700; color: #111827;">‚öôÔ∏è Qu·∫£n L√Ω Category & Sites
                </h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn btn-secondary btn-sm" onclick="downloadConfigFile()"
                        style="padding: 8px 16px; font-size: 13px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        üíæ T·∫£i Config
                    </button>
                    <button class="modal-close" onclick="closeCategoryManagementModal()"
                        style="width: 36px; height: 36px; border: none; background: #f3f4f6; border-radius: 50%; font-size: 24px; color: #6b7280; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">√ó</button>
                </div>
            </div>

            <!-- Tabs -->
            <div
                style="display: flex; gap: 8px; padding: 16px 24px; border-bottom: 2px solid #e5e7eb; background: #f9fafb; flex-shrink: 0; overflow-x: auto;">
                <button class="category-tab active" data-category="okvip" onclick="switchCategoryTab('okvip')"
                    style="padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s;">
                    üé∞ OKVIP
                </button>
                <button class="category-tab" data-category="abcvip" onclick="switchCategoryTab('abcvip')"
                    style="padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s;">
                    üé≤ ABCVIP
                </button>
                <button class="category-tab" data-category="jun88" onclick="switchCategoryTab('jun88')"
                    style="padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s;">
                    üéØ JUN88
                </button>
                <button class="category-tab" data-category="kjc" onclick="switchCategoryTab('kjc')"
                    style="padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s;">
                    ÔøΩ KJC
                </button>

            </div>

            <!-- Content -->
            <div style="flex: 1; overflow-y: auto; padding: 20px 24px;">
                <div id="categoryManagementContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Helper function to disable button until server responds
    function disableButton(button) {
        if (!button) return;

        button.disabled = true;
        button.style.opacity = '0.5';
        button.style.cursor = 'not-allowed';
        button.style.pointerEvents = 'none';
    }

    // Helper function to enable button after server responds
    function enableButton(button) {
        if (!button) return;

        button.disabled = false;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
        button.style.pointerEvents = 'auto';
    }

    // Helper function to disable button for 0.5s to prevent double-click (deprecated, use disableButton/enableButton instead)
    function disableButtonTemporarily(button, duration = 500) {
        if (!button) return;

        const originalOpacity = button.style.opacity;
        const originalCursor = button.style.cursor;
        const originalPointerEvents = button.style.pointerEvents;

        button.disabled = true;
        button.style.opacity = '0.5';
        button.style.cursor = 'not-allowed';
        button.style.pointerEvents = 'none';

        setTimeout(() => {
            button.disabled = false;
            button.style.opacity = originalOpacity || '1';
            button.style.cursor = originalCursor || 'pointer';
            button.style.pointerEvents = originalPointerEvents || 'auto';
        }, duration);
    }

    // Update category badge
    function updateCategoryBadge(category) {
        if (!configLoaded || !vipConfig) return;

        const categoryInfo = vipConfig.categories.find(c => c.id === category);
        if (!categoryInfo) return;

        const badge = document.getElementById('categoryBadge');
        const icon = document.getElementById('categoryIcon');
        const name = document.getElementById('categoryName');

        if (badge && icon && name) {
            icon.textContent = categoryInfo.icon;
            name.textContent = categoryInfo.name;
            badge.style.background = `linear-gradient(135deg, ${categoryInfo.color}, ${categoryInfo.color}dd)`;
        }
    }

    // Initialize VIP sites based on category
    async function toggleCategorySites() {
        const category = document.querySelector('input[name="vipCategory"]:checked').value;
        const sitesGrid = document.getElementById('vipSitesGrid');

        // Update badge
        updateCategoryBadge(category);

        try {
            // Wait for config to load if not ready yet
            if (!configLoaded || !vipConfig) {
                console.warn('Config not loaded yet, waiting...');
                // Wait up to 5 seconds for config to load
                for (let i = 0; i < 50; i++) {
                    if (configLoaded && vipConfig) break;
                    await new Promise(r => setTimeout(r, 100));
                }
                if (!configLoaded || !vipConfig) {
                    console.error('Config failed to load');
                    return;
                }
            }

            // Get category info from config
            const categoryInfo = vipConfig.categories.find(c => c.id === category);
            if (!categoryInfo) {
                console.error('Category not found in config');
                return;
            }

            const sites = vipConfig.sites[category] || [];
            const color = categoryInfo.color;

            // Icon mapping for all sites
            const iconMap = {
                // OKVIP sites
                'OKVip1': 'okvip1.jpg',
                'OKVip2': 'okvip2.jpg',
                'Hi88': 'hi88.jpg',
                'F8BET': 'f8bet.jpg',
                'SHBET': 'shbet.jpg',
                'TigerStorm7ff': 'tigerstorm.jpg',
                'NEW88': 'new88.jpg',
                'MB66': 'mb66.jpg',
                '789BET': '789bet.jpg',
                // ABCVIP sites
                'U888': 'u888.jpg',
                'J88': 'j88.jpg',
                'ABC8': 'abc8.jpg',
                '888clb': '888clb.jpg'
            };

            let sitesHtml = sites.map((site, index) => {
                const iconFile = iconMap[site.name] || null;
                const iconHtml = iconFile
                    ? `<img src="tools-ui/vip/icons/${iconFile}" alt="${site.name}" class="site-icon-img" title="${site.name}" style="width: 40px; height: 40px;">`
                    : `<div class="site-icon" style="width: 40px; height: 40px; font-size: 9px; background-color: ${color};" title="${site.name}">${site.name.substring(0, 3).toUpperCase()}</div>`;

                return `
<label class="site-card" style="position: relative;">
    <input type="checkbox" class="site-check" data-name="${site.name}" style="display: none;" onchange="updateSiteCardStyle(this)">
    <div style="position: relative;">
        ${iconHtml}
        <div class="site-check-mark" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">‚úì</div>
    </div>
</label>
`;
            }).join('');



            sitesGrid.innerHTML = sitesHtml;

            console.log(`‚úÖ Loaded ${sites.length} sites for ${category}`);
        } catch (error) {
            console.error('‚ùå Error loading category sites:', error);
            // Fallback: show empty grid
            sitesGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #a0aec0;">Kh√¥ng th·ªÉ t·∫£i danh s√°ch sites</p>';
        }
    }

    function updateSiteCardStyle(checkbox) {
        // Trigger change event to update UI
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
    }

    function selectAllVipSites() {
        document.querySelectorAll('#vipSitesGrid .site-check').forEach(cb => {
            cb.checked = true;
            updateSiteCardStyle(cb);
        });
    }

    function deselectAllVipSites() {
        document.querySelectorAll('#vipSitesGrid .site-check').forEach(cb => {
            cb.checked = false;
            updateSiteCardStyle(cb);
        });
    }

    function openFormModal() {
        const btn = event?.target;
        if (btn) disableButtonTemporarily(btn);

        document.getElementById('formModal').style.display = 'flex';
        toggleCategorySites(); // Initialize sites
        loadProfilesCarousel(); // Auto load profiles when opening modal
        loadBanksForTool(); // Load banks from vietQR API
    }

    function closeFormModal() {
        document.getElementById('formModal').style.display = 'none';
    }

    function resetFormInputs() {
        // Clear ALL form inputs - Auto tab
        document.getElementById('autoUsername').value = '';
        document.getElementById('autoPassword').value = '';
        document.getElementById('autoWithdrawPassword').value = '';
        document.getElementById('autoFullname').value = '';
        document.getElementById('autoEmail').value = '';
        document.getElementById('autoPhone').value = '';
        document.getElementById('autoBankName').value = '';
        document.getElementById('autoAccountNumber').value = '';

        // Clear Promo tab
        document.getElementById('promoUsername').value = '';

        // Uncheck all site checkboxes
        document.querySelectorAll('#vipSitesGrid .site-check').forEach(cb => cb.checked = false);

        // Reset category selection to first one
        const firstCategory = document.querySelector('input[name="vipCategory"]');
        if (firstCategory) {
            firstCategory.checked = true;
            toggleCategorySites();
        }

        console.log('‚úÖ Form reset completed');
    }

    function switchModalTab(tab) {
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
        document.getElementById(`tab-${tab}`).style.display = 'block';

        // Load profiles for promo tab
        if (tab === 'promo') {
            renderProfileCarousel('promo');
        }
    }

    async function runCurrentTabAction() {
        const btn = document.getElementById('btnRunAction');
        if (btn) disableButton(btn);

        const activeTab = document.querySelector('.modal-tab.active');
        const tabName = activeTab?.getAttribute('data-tab');

        // Get selected profile early to mark as running
        const selectedProfile = profileManager.getSelected();
        if (!selectedProfile) {
            showToast('warning', 'Ch∆∞a ch·ªçn', 'Vui l√≤ng ch·ªçn profile');
            if (btn) enableButton(btn);
            return;
        }

        // Mark profile as running IMMEDIATELY
        profileManager.runningProfiles.add(selectedProfile.uuid);
        if (!profileManager.runningStartTimes) {
            profileManager.runningStartTimes = new Map();
        }
        profileManager.runningStartTimes.set(selectedProfile.uuid, Date.now());
        profileManager.saveRunningProfiles();

        // Refresh carousel to show running status immediately
        const activeTab2 = document.querySelector('.modal-tab.active')?.getAttribute('data-tab') || 'auto';
        await loadProfilesCarousel();
        renderProfileCarousel(activeTab2);

        // Enable button immediately after marking as running
        if (btn) enableButton(btn);

        if (tabName === 'auto') {
            await runAutoAutomation();
        } else if (tabName === 'promo') {
            await runCheckPromo();
        }
    }

    // Helper: Send running status to server immediately
    async function sendRunningStatusToServer(profileId, profileName, username, sites, mode = 'auto', category = 'okvip') {
        try {
            const dashboardPort = window.location.port || 3000;
            const response = await fetch(`http://localhost:${dashboardPort}/api/automation/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    profileId: profileId,
                    profileName: profileName,
                    username: username,
                    status: 'running',
                    category: category, // üî• Add category to running status
                    sites: sites.map(s => ({ name: s })),
                    mode: mode,
                    timestamp: Date.now()
                })
            });

            if (response.ok) {
                console.log('üì§ Sent running status to server');
            } else {
                console.warn('‚ö†Ô∏è Failed to send running status:', response.status);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Error sending running status:', error.message);
        }
    }

    async function runAutoAutomation() {
        // Get button reference
        const btnRunAction = document.getElementById('btnRunAction');

        // üî• DISABLE button immediately to prevent double-click
        if (btnRunAction) {
            btnRunAction.disabled = true;
            btnRunAction.style.opacity = '0.5';
            btnRunAction.style.cursor = 'not-allowed';
        }

        // Get selected category
        const category = document.querySelector('input[name="vipCategory"]:checked').value;

        // Get selected sites
        const selectedSites = Array.from(document.querySelectorAll('#vipSitesGrid .site-check:checked'))
            .map(cb => cb.getAttribute('data-name'));

        if (selectedSites.length === 0) {
            showToast('warning', 'Ch∆∞a ch·ªçn', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 site');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Get profile data
        const selectedProfile = profileManager.getSelected();
        if (!selectedProfile) {
            showToast('warning', 'Ch∆∞a ch·ªçn', 'Vui l√≤ng ch·ªçn profile');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Check if profile is already running
        if (profileManager.isRunning(selectedProfile.uuid)) {
            showToast('warning', 'Profile ƒëang ch·∫°y', 'Profile n√†y ƒëang ch·∫°y automation, vui l√≤ng ch·ªçn profile kh√°c');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Show notification
        showToast('info', 'ƒêang ch·∫°y', `Automation ƒëang ch·∫°y cho ${selectedSites.length} site(s)...`);

        // Get form data
        const apiKey = typeof apiKeyManager !== 'undefined' ? apiKeyManager.get() :
            localStorage.getItem('hidemium_global_api_key') || '';

        const viotpToken = typeof apiKeyManager !== 'undefined' ? apiKeyManager.getSimApiKey() :
            localStorage.getItem('hidemium_sim_api_key') || '';

        const profileData = {
            profileId: selectedProfile?.uuid || selectedProfile?.id,
            username: document.getElementById('autoUsername').value.trim(),
            password: document.getElementById('autoPassword').value.trim(),
            withdrawPassword: document.getElementById('autoWithdrawPassword').value.trim(),
            fullname: document.getElementById('autoFullname').value.trim(),
            email: document.getElementById('autoEmail').value.trim(),
            phone: document.getElementById('autoPhone').value.trim(),
            bankName: document.getElementById('autoBankName').value.trim(),
            accountNumber: document.getElementById('autoAccountNumber').value.trim(),
            apiKey: apiKey,
            viotpToken: viotpToken,
            simMode: document.getElementById('simMode')?.value || 'api' // üì± SIM mode: 'api' or 'manual'
        };

        // Validate form data
        if (!profileData.username || !profileData.password) {
            showToast('warning', 'Thi·∫øu th√¥ng tin', 'Vui l√≤ng nh·∫≠p username v√† password');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Validate phone number if provided (10-11 digits)
        if (profileData.phone && !/^\d{10,11}$/.test(profileData.phone)) {
            showToast('warning', 'SƒêT kh√¥ng h·ª£p l·ªá', 'SƒêT ph·∫£i c√≥ 10-11 ch·ªØ s·ªë');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Validate bank info
        if (!profileData.bankName || profileData.bankName === '') {
            showToast('warning', 'Thi·∫øu th√¥ng tin', 'Vui l√≤ng ch·ªçn ng√¢n h√†ng');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        if (!profileData.accountNumber || profileData.accountNumber === '') {
            showToast('warning', 'Thi·∫øu th√¥ng tin', 'Vui l√≤ng nh·∫≠p s·ªë t√†i kho·∫£n ng√¢n h√†ng');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Validate account number (must be numbers only)
        if (!/^\d+$/.test(profileData.accountNumber)) {
            showToast('warning', 'S·ªë t√†i kho·∫£n kh√¥ng h·ª£p l·ªá', 'S·ªë t√†i kho·∫£n ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ s·ªë');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Validate API key
        if (!profileData.apiKey || profileData.apiKey.trim() === '') {
            showToast('error', 'Thi·∫øu API Key', 'Vui l√≤ng th√™m Captcha API Key ·ªü sidebar b√™n tr√°i');
            // Re-enable button on error
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Get execution mode
        const executionMode = document.querySelector('input[name="executionMode"]:checked').value;
        const parallelCount = executionMode === 'parallel' ? parseInt(document.getElementById('parallelCount').value) : 1;

        console.log('üöÄ Starting VIP Automation:', {
            category,
            sites: selectedSites,
            profile: selectedProfile.name,
            mode: executionMode,
            parallelCount
        });

        // üî• Mark profile as running BEFORE sending to server
        profileManager.runningProfiles.add(selectedProfile.uuid);
        profileManager.runningStartTimes = profileManager.runningStartTimes || new Map();
        profileManager.runningStartTimes.set(selectedProfile.uuid, Date.now());
        profileManager.saveRunningProfiles();

        // üî• Send running status to server IMMEDIATELY (before sending automation request)
        await sendRunningStatusToServer(selectedProfile.uuid, selectedProfile.name, profileData.username, selectedSites, 'auto', category);

        // üî• ENABLE button after marking as running (so user can run other profiles)
        if (btnRunAction) enableButton(btnRunAction);

        // Refresh results table immediately to show running status
        loadResultsFromAPI();

        // Send to backend
        try {
            const response = await fetch('/api/vip-automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category,
                    sites: selectedSites,
                    profile: selectedProfile,
                    profileId: selectedProfile?.uuid || selectedProfile?.id,
                    profileData,
                    mode: 'auto',
                    executionMode,
                    parallelCount
                })
            });

            const result = await response.json();

            if (result.success) {
                // Wait for server to actually start automation
                const waitResult = await waitForServerStart(profileData.username, 30000);

                if (waitResult.success) {
                    showToast('success', 'Ho√†n th√†nh', `Automation completed for ${selectedSites.length} sites`);
                } else {
                    showToast('success', 'ƒê√£ g·ª≠i', `Automation ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi server`);
                }
                // Modal will stay open - user must close manually

                // Add results
                if (result.results && Array.isArray(result.results)) {
                    result.results.forEach(res => {
                        addResult({
                            profile: selectedProfile.name,
                            category: category,
                            site: res.site,
                            username: profileData.username,
                            register: res.register,
                            login: res.login || { success: true },
                            addBank: res.addBank,
                            checkPromo: res.checkPromo
                        });
                    });
                }

                // Refresh results table again after automation completes
                loadResultsFromAPI();
            } else {
                showToast('error', 'L·ªói', result.error);
            }
        } catch (error) {
            console.error('‚ùå Automation Error:', error);
            showToast('error', 'L·ªói', error.message);
            // Unmark on error
            profileManager.runningProfiles.delete(selectedProfile.uuid);
            if (profileManager.runningStartTimes) {
                profileManager.runningStartTimes.delete(selectedProfile.uuid);
            }
            profileManager.saveRunningProfiles();
            await loadProfilesCarousel();
        } finally {
            // Note: Profile will be unmarked by polling (loadVipAutomationStatuses) when automation completes on server
        }
    }

    async function runCheckPromo() {
        const btnRunAction = document.getElementById('btnRunAction');

        // üî• DISABLE button immediately to prevent double-click
        if (btnRunAction) {
            btnRunAction.disabled = true;
            btnRunAction.style.opacity = '0.5';
            btnRunAction.style.cursor = 'not-allowed';
        }

        const category = document.querySelector('input[name="vipCategory"]:checked').value;
        const selectedSites = Array.from(document.querySelectorAll('#vipSitesGrid .site-check:checked'))
            .map(cb => cb.getAttribute('data-name'));
        const username = document.getElementById('promoUsername').value;

        if (selectedSites.length === 0) {
            showToast('warning', 'Ch∆∞a ch·ªçn', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 site');
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        if (!username || username.trim() === '') {
            showToast('warning', 'Thi·∫øu th√¥ng tin', 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p');
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        const selectedProfile = profileManager.getSelected();
        if (!selectedProfile) {
            showToast('warning', 'Ch∆∞a ch·ªçn', 'Vui l√≤ng ch·ªçn profile');
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Check if profile is already running
        if (profileManager.isRunning(selectedProfile.uuid)) {
            showToast('warning', 'Profile ƒëang ch·∫°y', 'Profile n√†y ƒëang ch·∫°y automation, vui l√≤ng ch·ªçn profile kh√°c');
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        // Get API key
        const apiKey = typeof apiKeyManager !== 'undefined' ? apiKeyManager.get() :
            localStorage.getItem('hidemium_global_api_key') || '';

        // Validate API key
        if (!apiKey || apiKey.trim() === '') {
            showToast('error', 'Thi·∫øu API Key', 'Vui l√≤ng th√™m Captcha API Key ·ªü sidebar b√™n tr√°i');
            if (btnRunAction) enableButton(btnRunAction);
            return;
        }

        console.log('üéÅ Starting Check Promo:', { category, sites: selectedSites, username });

        // üî• Mark profile as running BEFORE sending to server
        profileManager.runningProfiles.add(selectedProfile.uuid);
        profileManager.runningStartTimes = profileManager.runningStartTimes || new Map();
        profileManager.runningStartTimes.set(selectedProfile.uuid, Date.now());
        profileManager.saveRunningProfiles();

        // üî• Send running status to server IMMEDIATELY (before sending automation request)
        await sendRunningStatusToServer(selectedProfile.uuid, selectedProfile.name, username, selectedSites, 'promo', category);

        // üî• ENABLE button after marking as running (so user can run other profiles)
        if (btnRunAction) enableButton(btnRunAction);

        // Refresh results table immediately to show running status
        loadResultsFromAPI();

        try {
            const response = await fetch('/api/vip-automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category,
                    sites: selectedSites,
                    profile: selectedProfile,
                    profileId: selectedProfile?.uuid || selectedProfile?.id,
                    profileData: { username, apiKey },
                    mode: 'promo'
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast('success', 'Ho√†n th√†nh', `Check promo completed for ${selectedSites.length} sites`);

                // Refresh results table again after automation completes
                loadResultsFromAPI();
            } else {
                showToast('error', 'L·ªói', result.error);
            }
        } catch (error) {
            console.error('‚ùå Check Promo Error:', error);
            showToast('error', 'L·ªói', error.message);
            // Unmark on error
            profileManager.runningProfiles.delete(selectedProfile.uuid);
            if (profileManager.runningStartTimes) {
                profileManager.runningStartTimes.delete(selectedProfile.uuid);
            }
            profileManager.saveRunningProfiles();
            await loadProfilesCarousel();
        } finally {
            // Note: Profile will be unmarked by polling (loadVipAutomationStatuses) when automation completes on server
        }
    }

    async function clearAllRunningStatuses() {
        const count = profileManager.runningProfiles.size;

        if (count === 0) {
            showToast('info', 'Kh√¥ng c√≥ g√¨', 'Kh√¥ng c√≥ profile n√†o ƒëang marked running');
            return;
        }

        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën clear ${count} profile(s) ƒëang running?`)) {
            return;
        }

        // Clear all running profiles
        profileManager.runningProfiles.clear();
        if (profileManager.runningStartTimes) {
            profileManager.runningStartTimes.clear();
        }
        profileManager.saveRunningProfiles();

        // Refresh carousel to update UI
        const activeTab = document.querySelector('.modal-tab.active')?.getAttribute('data-tab') || 'auto';
        await loadProfilesCarousel();
        renderProfileCarousel(activeTab);

        showToast('success', 'ƒê√£ clear', `ƒê√£ clear ${count} profiles`);
        console.log(`‚úÖ Cleared ${count} running profiles`);
    }

    // Load banks from vietQR API
    async function loadBanksForTool() {
        const selectId = 'autoBankName';
        try {
            const response = await fetch('https://api.vietqr.io/v2/banks');
            const data = await response.json();
            if (data.code === '00' && data.data) {
                const sortedBanks = data.data.sort((a, b) => a.shortName.localeCompare(b.shortName));
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Ch·ªçn ng√¢n h√†ng...</option>';
                    sortedBanks.forEach(bank => {
                        const option = document.createElement('option');
                        option.value = bank.shortName;
                        option.textContent = `${bank.shortName} - ${bank.name}`;
                        select.appendChild(option);
                    });
                }
                console.log(`‚úÖ Loaded ${sortedBanks.length} banks`);
            }
        } catch (error) {
            console.error('‚ùå Failed to load banks:', error);
        }
    }

    // Random username generator
    const uniqueWords = {
        prefixes: ['Sky', 'Moon', 'Star', 'Fire', 'Dragon', 'Phoenix', 'Tiger', 'Wolf', 'Eagle', 'Lion'],
        suffixes: ['Blade', 'Strike', 'Storm', 'Fire', 'Bolt', 'Flash', 'Fury', 'Soul', 'Power'],
        numbers: ['', '1', '7', '9', '88', '99', '777', '888']
    };

    function generateRandomUsername() {
        const prefix = uniqueWords.prefixes[Math.floor(Math.random() * uniqueWords.prefixes.length)];
        const suffix = uniqueWords.suffixes[Math.floor(Math.random() * uniqueWords.suffixes.length)];
        const number = uniqueWords.numbers[Math.floor(Math.random() * uniqueWords.numbers.length)];
        return prefix + suffix + number;
    }

    // Random to√†n b·ªô form
    function randomAllForm() {
        // Random username (lowercase only, max 7 characters)
        const usernameLength = 5 + Math.floor(Math.random() * 3); // 5-7 chars
        const lowerChars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let username = '';
        for (let i = 0; i < usernameLength; i++) {
            username += lowerChars[Math.floor(Math.random() * lowerChars.length)];
        }
        document.getElementById('autoUsername').value = username;

        // Random fullname (Vietnamese names)
        const firstNames = ['NGUYEN', 'TRAN', 'LE', 'PHAM', 'HOANG', 'PHAN', 'VU', 'VO', 'DANG', 'BUI'];
        const middleNames = ['VAN', 'THI', 'DUC', 'MINH', 'HOANG', 'QUANG', 'ANH', 'THANH'];
        const lastNames = ['AN', 'BINH', 'CUONG', 'DUNG', 'HAI', 'HUNG', 'KHANH', 'LINH', 'MINH', 'NAM', 'PHONG', 'QUAN', 'TAM',
            'TUAN', 'VINH'];

        const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
        const middleName = middleNames[Math.floor(Math.random() * middleNames.length)];
        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
        const fullname = `${firstName} ${middleName} ${lastName}`;
        document.getElementById('autoFullname').value = fullname;

        // Random password (8-12 characters)
        const passwordLength = 8 + Math.floor(Math.random() * 5);
        const letters = 'abcdefghijklmnopqrstuvwxyz';
        const numbers = '0123456789';

        let password = '';
        password += letters[Math.floor(Math.random() * letters.length)];
        password += letters[Math.floor(Math.random() * letters.length)];
        password += numbers[Math.floor(Math.random() * numbers.length)];
        password += numbers[Math.floor(Math.random() * numbers.length)];

        const allChars = letters + numbers;
        for (let i = 4; i < passwordLength; i++) { password += allChars[Math.floor(Math.random() * allChars.length)]; }
        password = password.split('').sort(() => Math.random() - 0.5).join('');
        document.getElementById('autoPassword').value = password;

        // Random withdraw password (6 digits)
        const withdrawPassword = Math.floor(100000 + Math.random() * 900000).toString();
        document.getElementById('autoWithdrawPassword').value = withdrawPassword;

        // Random email (lowercase only, max 7 chars before @)
        const emailLength = 5 + Math.floor(Math.random() * 3); // 5-7 chars
        let email = '';
        for (let i = 0; i < emailLength; i++) {
            email += lowerChars[Math.floor(Math.random() * lowerChars.length)];
        }
        email += '@gmail.com';
        document.getElementById('autoEmail').value = email;

        // Random phone
        const phone = '09' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0');
        document.getElementById('autoPhone').value = phone;

        // Random bank
        const bankSelect = document.getElementById('autoBankName');
        if (bankSelect && bankSelect.options.length > 1) {
            const randomIndex = 1 + Math.floor(Math.random() * (bankSelect.options.length - 1));
            bankSelect.selectedIndex = randomIndex;
        }

        // Random account number (10-14 digits)
        const accountLength = 10 + Math.floor(Math.random() * 5);
        let accountNumber = '';
        for (let i = 0; i < accountLength; i++) { accountNumber += Math.floor(Math.random() * 10); }
        document.getElementById('autoAccountNumber').value = accountNumber;

        // Visual feedback
        const inputs = ['autoUsername', 'autoFullname', 'autoPassword', 'autoWithdrawPassword', 'autoEmail', 'autoPhone', 'autoBankName', 'autoAccountNumber'];
        inputs.forEach(id => {
            const input = document.getElementById(id);
            if (input && input.value) {
                input.style.background = 'linear-gradient(135deg, #ebf4ff, #e0e7ff)';
                setTimeout(() => { input.style.background = ''; }, 1000);
            }
        });

        console.log('‚úÖ Random form completed');
    }

    // Profile Management
    let availableProfiles = [];

    // Wait for server to actually start automation (check if it's in running status)
    async function waitForServerStart(username, maxWaitTime = 30000) {
        const startTime = Date.now();
        const checkInterval = 500; // Check every 500ms

        console.log(`‚è≥ Waiting for server to start automation for ${username}...`);

        while (Date.now() - startTime < maxWaitTime) {
            try {
                const response = await fetch('/api/vip-automation/statuses');
                const data = await response.json();

                if (data.success && data.statuses) {
                    // Check if this username is in running status
                    const isRunning = data.statuses.some(status =>
                        status.username === username && status.status === 'running'
                    );

                    if (isRunning) {
                        console.log(`‚úÖ Server confirmed automation started for ${username}`);
                        return { success: true, waitTime: Date.now() - startTime };
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error checking server status:', error.message);
            }

            // Wait before next check
            await new Promise(resolve => setTimeout(resolve, checkInterval));
        }

        console.warn(`‚ö†Ô∏è Server start confirmation timeout after ${maxWaitTime}ms`);
        return { success: false, timeout: true, waitTime: Date.now() - startTime };
    }

    async function loadProfilesCarousel() {
        try {
            console.log('üìÇ Loading profiles from Hidemium...');

            // Use profileManager t·ª´ core/profile-manager.js
            if (typeof profileManager !== 'undefined') {
                const result = await profileManager.loadAll();

                if (result.success && result.profiles && result.profiles.length > 0) {
                    // Log first profile to see structure
                    console.log('üìã First profile structure:', result.profiles[0]);

                    // Use profiles directly like nohu does
                    availableProfiles = result.profiles;
                    console.log('‚úÖ Loaded profiles:', availableProfiles);
                    renderProfileCarousel();
                } else {
                    throw new Error(result.error || 'No profiles found');
                }
            } else {
                throw new Error('profileManager not available');
            }
        } catch (error) {
            console.error('‚ùå Error loading profiles:', error);

            // No fallback - show empty carousel
            availableProfiles = [];
            renderProfileCarousel();
        }
    }

    function renderProfileCarousel(tabId = 'auto') {
        const carouselId = tabId === 'promo' ? 'promoProfileCarousel' : 'autoProfileCarousel';
        const carousel = document.getElementById(carouselId);
        if (!carousel) return;

        carousel.innerHTML = '';

        if (availableProfiles.length === 0) {
            carousel.innerHTML = '<div class="profile-carousel-empty"><p>Kh√¥ng c√≥ profiles. Vui l√≤ng m·ªü Hidemium tr∆∞·ªõc.</p></div>';
            return;
        }

        availableProfiles.forEach(profile => {
            const isRunning = profileManager.isRunning(profile.uuid);
            const isSelected = profileManager.selectedProfileId === profile.uuid;

            // Extract proxy IP
            let proxyIP = 'No proxy';
            if (profile.proxy && typeof profile.proxy === 'object' && profile.proxy.ip) {
                proxyIP = profile.proxy.ip;
            } else if (profile.proxy && typeof profile.proxy === 'string') {
                const parts = profile.proxy.split('|');
                if (parts.length >= 2 && parts[1]) {
                    proxyIP = parts[1];
                }
            }

            // OS & Browser icons
            const osIcons = { 'win': 'ü™ü', 'windows': 'ü™ü', 'mac': 'üçé', 'macos': 'üçé', 'linux': 'üêß', 'android': 'ü§ñ', 'ios': 'üì±' };
            const browserIcons = { 'chrome': 'üåê', 'firefox': 'ü¶ä', 'edge': 'üî∑', 'opera': 'üî¥', 'brave': 'ü¶Å', 'safari': 'üß≠' };
            const osIcon = osIcons[profile.os?.toLowerCase()] || 'üíª';
            const browserIcon = browserIcons[profile.browser?.toLowerCase()] || 'üåê';

            const card = document.createElement('div');
            card.className = `profile-carousel-card ${isSelected ? 'selected' : ''} ${isRunning ? 'running' : ''}`;
            card.setAttribute('data-uuid', profile.uuid);

            card.innerHTML = `
                <div class="profile-card-header">
                    <div class="profile-avatar">
                        ${profile.name ? profile.name.substring(0, 2).toUpperCase() : 'PR'}
                    </div>
                    ${isRunning ? '<span class="running-badge">‚óè Running</span>' : ''}
                    ${isSelected ? '<span class="selected-badge">‚úì Selected</span>' : ''}
                </div>
                <div class="profile-card-body">
                    <div class="profile-card-name">${profile.name || 'Unnamed Profile'}</div>
                    <div class="profile-card-info">
                        <div class="info-item">
                            <span class="info-icon">${osIcon}</span>
                            <span class="info-text">${profile.os || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">${browserIcon}</span>
                            <span class="info-text">${profile.browser || 'chrome'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üåç</span>
                            <span class="info-text">${proxyIP}</span>
                        </div>
                    </div>
                </div>
                <div class="profile-card-footer">
                    <div class="profile-status-text ${isRunning ? 'running' : (isSelected ? 'selected' : 'available')}">
                        ${isRunning ? 'üî¥ ƒêang Ch·∫°y' : (isSelected ? '‚úì ƒê√£ Ch·ªçn' : 'üëÜ Click ƒë·ªÉ ch·ªçn')}
                    </div>
                </div>
            `;

            // Add click event listener
            if (!isRunning) {
                card.style.cursor = 'pointer';
                card.addEventListener('click', () => {
                    selectProfileVip(profile.uuid);
                });
            } else {
                card.style.cursor = 'not-allowed';
                card.addEventListener('click', () => {
                    showToast('warning', 'Profile ƒëang ch·∫°y', 'Kh√¥ng th·ªÉ ch·ªçn profile ƒëang ch·∫°y automation');
                });
            }

            carousel.appendChild(card);
        });
    }

    function selectProfileVip(uuid) {
        // Check if profile is running
        if (profileManager.isRunning(uuid)) {
            showToast('warning', 'Profile ƒëang ch·∫°y', 'Kh√¥ng th·ªÉ ch·ªçn profile ƒëang ch·∫°y automation');
            return;
        }

        // Select in manager
        profileManager.select(uuid);

        // Update all carousels to show selected state
        const carousels = ['auto', 'promo'];
        carousels.forEach(tabId => {
            const carouselId = tabId === 'promo' ? 'promoProfileCarousel' : 'autoProfileCarousel';
            const carousel = document.getElementById(carouselId);
            if (carousel) {
                // Remove selected class from all cards
                carousel.querySelectorAll('.profile-carousel-card').forEach(card => {
                    card.classList.remove('selected');
                    const statusText = card.querySelector('.profile-status-text');
                    const selectedBadge = card.querySelector('.selected-badge');

                    if (statusText) {
                        const cardUuid = card.getAttribute('data-uuid');
                        const isRunning = profileManager.isRunning(cardUuid);

                        if (isRunning) {
                            statusText.textContent = 'üî¥ ƒêang Ch·∫°y';
                            statusText.className = 'profile-status-text running';
                        } else {
                            statusText.textContent = 'üëÜ Click ƒë·ªÉ ch·ªçn';
                            statusText.className = 'profile-status-text available';
                        }
                    }

                    // Remove selected badge
                    if (selectedBadge) {
                        selectedBadge.remove();
                    }
                });

                // Add selected class to clicked card
                const selectedCard = carousel.querySelector(`[data-uuid="${uuid}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    const statusText = selectedCard.querySelector('.profile-status-text');
                    if (statusText) {
                        statusText.textContent = '‚úì ƒê√£ Ch·ªçn';
                        statusText.className = 'profile-status-text selected';
                    }

                    // Add selected badge
                    const header = selectedCard.querySelector('.profile-card-header');
                    if (header && !header.querySelector('.selected-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'selected-badge';
                        badge.textContent = '‚úì Selected';
                        header.appendChild(badge);
                    }
                }
            }
        });

        showToast('success', 'Profile ƒë√£ ch·ªçn', profileManager.getSelected()?.name || 'Unknown');
    }

    function scrollProfileCarousel(tab, direction) {
        const carouselId = tab === 'promo' ? 'promoProfileCarousel' : 'autoProfileCarousel';
        const carousel = document.getElementById(carouselId);
        const scrollAmount = 300;
        carousel.scrollBy({
            left: direction * scrollAmount,
            behavior: 'smooth'
        });
    }

    // Touch/Swipe support for profile carousel
    function initCarouselSwipe() {
        const carousels = document.querySelectorAll('.profile-carousel');

        carousels.forEach(carousel => {
            let startX = 0;
            let scrollLeft = 0;
            let isDown = false;

            carousel.addEventListener('mousedown', (e) => {
                isDown = true;
                startX = e.pageX - carousel.offsetLeft;
                scrollLeft = carousel.scrollLeft;
                carousel.style.cursor = 'grabbing';
            });

            carousel.addEventListener('mouseleave', () => {
                isDown = false;
                carousel.style.cursor = 'grab';
            });

            carousel.addEventListener('mouseup', () => {
                isDown = false;
                carousel.style.cursor = 'grab';
            });

            carousel.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - carousel.offsetLeft;
                const walk = (x - startX) * 1.5; // Multiply for faster scroll
                carousel.scrollLeft = scrollLeft - walk;
            });

            // Touch support for mobile
            carousel.addEventListener('touchstart', (e) => {
                startX = e.touches[0].pageX - carousel.offsetLeft;
                scrollLeft = carousel.scrollLeft;
            });

            carousel.addEventListener('touchmove', (e) => {
                const x = e.touches[0].pageX - carousel.offsetLeft;
                const walk = (x - startX) * 1.5;
                carousel.scrollLeft = scrollLeft - walk;
            });

            // Smooth scroll on wheel
            carousel.addEventListener('wheel', (e) => {
                e.preventDefault();
                carousel.scrollBy({
                    left: e.deltaY < 0 ? -100 : 100, behavior: 'smooth'
                });
            });
        });
    }

    // Initialize swipe when profiles are loaded
    const originalLoadProfiles = loadProfilesCarousel;
    loadProfilesCarousel = async function () {
        await originalLoadProfiles.call(this);
        setTimeout(initCarouselSwipe, 100);
    };

    function startCheckPromo() {
        runCheckPromo();
    }

    // Results Management
    let vipResults = [];
    const RESULTS_PER_PAGE = 5;
    let currentPage = 1;
    function addResult(result) {
        vipResults.unshift({
            id: Date.now(), profile: result.profile || 'N/A',
            category: result.category || 'N/A', site: result.site || 'N/A', username: result.username || 'N/A',
            password: result.password || 'N/A', withdrawPassword: result.withdrawPassword || 'N/A', fullname:
                result.fullname || 'N/A', bankName: result.bankName || 'N/A', accountNumber: result.accountNumber
                    || 'N/A', register: result.register || { success: false }, login: result.login || { success: false },
            addBank: result.addBank || { success: false }, checkPromo: result.checkPromo || { success: false },
            timestamp: new Date().toLocaleString('vi-VN'), checked: false
        }); updateResultsTable();
    } function
        getStatusBadge(status) {
        if (status === true || (status && status.success === true)) {
            return '<span class="status-badge status-success">‚úÖ Th√†nh C√¥ng</span>';
        } else if (status === false ||
            (status && status.success === false)) {
            return '<span class="status-badge status-failed">‚ùå Th·∫•t B·∫°i</span>';
        } else {
            return '<span class="status-badge status-pending">‚è≥ Ch·ªù</span>';
        }
    } function
        getCategoryBadge(category) {
        const categoryMap = {
            'okvip': 'category-okvip', 'abcvip'
                : 'category-abcvip', 'jun88': 'category-jun88', 'kjc': 'category-kjc'
        }; const
            className = categoryMap[category] || ''; return `<span class="category-badge ${className}">
                ${category.toUpperCase()}</span>`;
    }

    function updateResultsTable() {
        const tbody = document.getElementById('resultsTableBody');

        if (vipResults.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #a0aec0; padding: 40px;">
                        Ch∆∞a c√≥ k·∫øt qu·∫£. Ch·∫°y automation ƒë·ªÉ xem k·∫øt qu·∫£ ·ªü ƒë√¢y.
                    </td>
                </tr>
                `;
            updatePagination();
            return;
        }

        // Calculate pagination
        const totalPages = Math.ceil(vipResults.length / RESULTS_PER_PAGE);
        const startIdx = (currentPage - 1) * RESULTS_PER_PAGE;
        const endIdx = startIdx + RESULTS_PER_PAGE;
        const pageResults = vipResults.slice(startIdx, endIdx);

        // Build table rows
        tbody.innerHTML = pageResults.map(result => {
            // Determine overall status and reason
            let statusIcon = '‚úÖ';
            let statusReason = 'Ho√†n th√†nh';
            let statusClass = 'status-success';

            if (!result.register?.success) {
                statusIcon = '‚ùå';
                statusReason = result.register?.error || 'ƒêƒÉng k√Ω th·∫•t b·∫°i';
                statusClass = 'status-failed';
            } else if (!result.addBank?.success && !result.addBank?.skipped) {
                statusIcon = '‚ùå';
                statusReason = result.addBank?.error || 'Th√™m bank th·∫•t b·∫°i';
                statusClass = 'status-failed';
            } else if (!result.checkPromo?.success && result.checkPromo?.skipped !== true) {
                statusIcon = '‚ùå';
                statusReason = result.checkPromo?.error || 'Check KM th·∫•t b·∫°i';
                statusClass = 'status-failed';
            }

            return `
                <tr>
                    <td style="width: 40px;">
                        <input type="checkbox" class="result-checkbox" data-id="${result.id}"
                            onchange="updateSelectAll()" style="cursor: pointer; width: 18px; height: 18px;">
                    </td>
                    <td><strong>${result.profile}</strong></td>
                    <td style="text-align: center; display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap;"
                        title="${Array.isArray(result.sites) ? result.sites.join(', ') : result.sites}">
                        ${(() => {
                    const sites = Array.isArray(result.sites) ? result.sites : [result.sites];
                    return sites.map(site => {
                        return `<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                            ${site}
                        </span>`;
                    }).join('');
                })()}
                    </td>
                    <td>${result.username}</td>
                    <td style="text-align: center; font-size: 18px; font-weight: bold;" title="${statusReason}">${statusIcon}</td>
                    <td style="font-size: 12px; color: #6b7280; max-width: 250px; word-break: break-word;">${statusReason}</td>
                    <td style="font-size: 12px; color: #6b7280;">${result.timestamp}</td>
                    <td style="text-align: center; display: flex; gap: 8px; justify-content: center; align-items: center;">
                        ${statusIcon === '‚úÖ'
                    ? `<button class="action-btn action-btn-small"
                            onclick="openVipAccountInfoModal('${result.username}', '${result.category}', '${(result.sites || []).join(',')}')"
                            title="Xem th√¥ng tin t√†i kho·∫£n"
                            style="font-size: 16px; padding: 6px 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìã
                        </button>`
                    : ''
                }
                        <button class="action-btn action-btn-small" onclick="deleteResult(${result.id})" title="X√≥a"
                            style="font-size: 16px; padding: 6px 10px; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
                `;
        }).join('');

        updatePagination();
    }

    function updatePagination() {
        const totalResults = vipResults.length;
        const totalPages = Math.ceil(totalResults / RESULTS_PER_PAGE);
        const startIdx = (currentPage - 1) * RESULTS_PER_PAGE + 1;
        const endIdx = Math.min(currentPage * RESULTS_PER_PAGE, totalResults);

        document.getElementById('pageStart').textContent = totalResults > 0 ? startIdx : 0;
        document.getElementById('pageEnd').textContent = endIdx;
        document.getElementById('totalResults').textContent = totalResults;
        document.getElementById('currentPage').textContent = totalResults > 0 ? currentPage : 1;
        document.getElementById('totalPages').textContent = totalPages > 0 ? totalPages : 1;

        // Update button states
        document.getElementById('btnFirst').disabled = currentPage === 1;
        document.getElementById('btnPrev').disabled = currentPage === 1;
        document.getElementById('btnNext').disabled = currentPage >= totalPages;
        document.getElementById('btnLast').disabled = currentPage >= totalPages;
    }

    function goToFirstPage() {
        currentPage = 1;
        updateResultsTable();
    }

    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateResultsTable();
        }
    }

    function goToNextPage() {
        const totalPages = Math.ceil(vipResults.length / RESULTS_PER_PAGE);
        if (currentPage < totalPages) { currentPage++; updateResultsTable(); }
    } function goToLastPage() {
        currentPage = Math.ceil(vipResults.length / RESULTS_PER_PAGE); updateResultsTable();
    } function
        toggleSelectAll(checkbox) {
        document.querySelectorAll('.result-checkbox').forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    function updateSelectAll() {
        const allChecked = document.querySelectorAll('.result-checkbox:checked').length;
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        selectAllCheckbox.checked = allChecked > 0;
    }

    async function deleteSelectedResults() {
        const btn = event?.target;
        if (btn) disableButtonTemporarily(btn);

        const selectedIds = Array.from(document.querySelectorAll('.result-checkbox:checked'))
            .map(cb => parseInt(cb.dataset.id));

        if (selectedIds.length === 0) {
            alert('Vui l√≤ng ch·ªçn k·∫øt qu·∫£ ƒë·ªÉ x√≥a');
            return;
        }

        if (confirm(`X√≥a ${selectedIds.length} k·∫øt qu·∫£?`)) {
            try {
                // Get selected results
                const selectedResults = vipResults.filter(r => selectedIds.includes(r.id));

                // Call API to delete results
                const response = await fetch('/api/results/clear-selected', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessions: selectedResults.map(r => ({
                            username: r.username,
                            sessionId: r.sessionId,
                            toolId: 'vip-tool'
                        }))
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('success', 'ƒê√£ x√≥a', `${selectedIds.length} k·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng`);
                    // Reload results from API
                    await loadResultsFromAPI();
                } else {
                    showToast('error', 'L·ªói', data.error || 'Kh√¥ng th·ªÉ x√≥a k·∫øt qu·∫£');
                }
            } catch (error) {
                console.error('Error deleting results:', error);
                showToast('error', 'L·ªói', error.message);
            }
        }
    }

    async function deleteAllResults() {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ k·∫øt qu·∫£?')) {
            return;
        }

        try {
            showToast('info', 'ƒêang x√≥a...', 'ƒêang x√≥a t·∫•t c·∫£ k·∫øt qu·∫£...');

            // Call API to delete all results for VIP tool
            const response = await fetch('/api/results/clear', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toolId: 'vip-tool' })
            });

            const data = await response.json();
            if (data.success) {
                vipResults = [];
                updateResultsTable();
                showToast('success', 'ƒê√£ x√≥a', `ƒê√£ x√≥a ${data.deletedFiles || 0} file k·∫øt qu·∫£`);
            } else {
                showToast('error', 'L·ªói', data.error || 'Kh√¥ng th·ªÉ x√≥a k·∫øt qu·∫£');
            }
        } catch (error) {
            console.error('Error deleting all results:', error);
            showToast('error', 'L·ªói', error.message);
        }
    }

    async function deleteResult(id) {
        const btn = event?.target;
        if (btn) disableButtonTemporarily(btn);

        const result = vipResults.find(r => r.id === id);
        if (!result) return;

        if (confirm(`X√≥a k·∫øt qu·∫£ automation c·ªßa ${result.profile}?`)) {
            try {
                // Call API to delete results
                const response = await fetch('/api/results/clear-selected', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessions: [{
                            username: result.username,
                            sessionId: result.sessionId,
                            toolId: 'vip-tool'
                        }]
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('success', 'ƒê√£ x√≥a', 'K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng');
                    // Reload results from API
                    await loadResultsFromAPI();
                } else {
                    showToast('error', 'L·ªói', data.error || 'Kh√¥ng th·ªÉ x√≥a k·∫øt qu·∫£');
                }
            } catch (error) {
                console.error('Error deleting result:', error);
                showToast('error', 'L·ªói', error.message);
            }
        }
    }

    async function showAccountInfo(id) {
        const result = vipResults.find(r => r.id === id);
        if (!result) return;

        // Only show if register was successful
        if (!result.register?.success) {
            showToast('warning', 'Kh√¥ng c√≥ th√¥ng tin', 'T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω th√†nh c√¥ng');
            return;
        }

        // Show loading modal
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><span style="font-size: 24px;">‚è≥</span><br>ƒêang t·∫£i...</div>';
        tempDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); z-index: 10000; max-width: 600px;';

        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999;';
        overlay.onclick = () => {
            document.body.removeChild(overlay);
            document.body.removeChild(tempDiv);
        };

        document.body.appendChild(overlay);
        document.body.appendChild(tempDiv);

        try {
            // Fetch account info from API
            const url = `/api/accounts/vip/${result.username}`;
            console.log(`üì° Fetching account info from: ${url}`);
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.account) {
                const acc = data.account;
                const accountHTML = `
                    <div style="background: #f7fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0 0 15px 0; color: #2d3748; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">üë§</span> Th√¥ng Tin T√†i Kho·∫£n
                            <span
                                style="background: #e2e8f0; color: #4a5568; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${(acc.category || 'VIP').toUpperCase()}
                            </span>
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                            <div>
                                <strong style="color: #4a5568;">üë§ T√™n ƒëƒÉng nh·∫≠p:</strong><br>
                                <span
                                    style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${acc.username}</span>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">üîë M·∫≠t kh·∫©u:</strong><br>
                                <span
                                    style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${acc.password}</span>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">üí∞ MK r√∫t ti·ªÅn:</strong><br>
                                <span
                                    style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${acc.withdrawPassword
                    || 'N/A'}</span>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">üìù H·ªç v√† t√™n:</strong><br>
                                <span style="color: #2d3748;">${acc.fullname || 'N/A'}</span>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">üè¶ Ng√¢n h√†ng:</strong><br>
                                <span style="color: #2d3748;">${acc.bankName || 'N/A'}</span>
                            </div>
                            <div>
                                <strong style="color: #4a5568;">üè¢ Chi nh√°nh:</strong><br>
                                <span style="color: #2d3748;">${acc.bankBranch || 'N/A'}</span>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <strong style="color: #4a5568;">üí≥ S·ªë t√†i kho·∫£n:</strong><br>
                                <span
                                    style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${acc.accountNumber
                    || 'N/A'}</span>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <strong style="color: #4a5568;">üìÖ Ng√†y ƒëƒÉng k√Ω:</strong><br>
                                <span style="color: #718096;">${new
                        Date(acc.registeredAt).toLocaleString('vi-VN')}</span>
                            </div>
                        </div>
                        <div
                            style="margin-top: 15px; padding: 12px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38b2ac;">
                            <p style="margin: 0; color: #234e52; font-size: 13px;">
                                <strong>‚ÑπÔ∏è L∆∞u √Ω:</strong> T√†i kho·∫£n n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng cho t·∫•t c·∫£ site trong category
                                <strong>${(acc.category || 'VIP').toUpperCase()}</strong>.
                            </p>
                        </div>
                    </div>
                    `;
                tempDiv.innerHTML = accountHTML;
            } else {
                tempDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #f59e0b;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th√¥ng tin t√†i kho·∫£n</div>';
            }
        } catch (error) {
            console.error('Error fetching account info:', error);
            tempDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">‚ùå L·ªói: ' + error.message + '</div>';
        }

        tempDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); z-index: 10000; max-width: 600px; max-height: 80vh; overflow-y: auto;';
    }

    function viewResultDetails(id) {
        const result = vipResults.find(r => r.id === id);
        if (!result) return;

        const details = `
                    Profile: ${result.profile}
                    Category: ${result.category}
                    Site: ${result.site}
                    T√†i Kho·∫£n: ${result.username}

                    ƒêƒÉng K√Ω: ${result.register.success ? '‚úÖ Th√†nh C√¥ng' : '‚ùå Th·∫•t B·∫°i'}
                    ƒêƒÉng Nh·∫≠p: ${result.login.success ? '‚úÖ Th√†nh C√¥ng' : '‚ùå Th·∫•t B·∫°i'}
                    Th√™m Bank: ${result.addBank.success ? '‚úÖ Th√†nh C√¥ng' : '‚ùå Th·∫•t B·∫°i'}
                    Check KM: ${result.checkPromo.success ? '‚úÖ Th√†nh C√¥ng' : '‚ùå Th·∫•t B·∫°i'}

                    Th·ªùi Gian: ${result.timestamp}
                    `;

        alert(details);
    }

    async function refreshResults() {
        const btn = event?.target;
        if (btn) disableButtonTemporarily(btn);
        await loadResultsFromAPI();
        updateResultsTable();
    }

    // Test: Add sample result
    function addSampleResult() {
        addResult({
            profile: 'Profile 1',
            category: 'okvip',
            site: 'OKVip1',
            username: 'testuser123',
            register: { success: true },
            login: { success: true },
            addBank: { success: true },
            checkPromo: { success: false }
        });
    }

    // Load results from API (scan screenshots folder)
    async function loadResultsFromAPI() {
        console.log('üîÑ loadResultsFromAPI() called');
        try {
            // Show loading state immediately
            const tbody = document.getElementById('resultsTableBody');
            console.log('üìã tbody element:', tbody);
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #6366f1; padding: 40px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <div
                                    style="width: 20px; height: 20px; border: 2px solid #6366f1; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;">
                                </div>
                                ƒêang t·∫£i k·∫øt qu·∫£ VIP Auto Tool...
                            </div>
                        </td>
                    </tr>
                    `;
            }

            const response = await fetch('/api/automation/results?tool=vip-tool');
            const data = await response.json();

            console.log('üì° API Response:', data);

            if (data.success && data.results && data.results.length > 0) {
                // Group results by sessionId (same automation run)
                const groupedBySession = {};

                data.results.forEach(result => {
                    const sessionId = result.sessionId || result.timestamp;
                    if (!groupedBySession[sessionId]) {
                        groupedBySession[sessionId] = {
                            profileName: result.profileName || 'Profile',
                            username: result.username || 'Unknown',
                            category: result.category || 'okvip', // üî• Add category
                            timestamp: result.timestamp,
                            sites: [],
                            register: result.register || { success: true },
                            addBank: result.addBank || { success: true },
                            checkPromo: result.checkPromo || { success: true }
                        };
                    }
                    groupedBySession[sessionId].sites.push(result.siteName || 'Unknown');
                    // Update result data from latest result (in case multiple sites in same session)
                    if (result.register) groupedBySession[sessionId].register = result.register;
                    if (result.addBank) groupedBySession[sessionId].addBank = result.addBank;
                    if (result.checkPromo) groupedBySession[sessionId].checkPromo = result.checkPromo;
                });

                // Convert grouped results to vipResults format
                vipResults = Object.entries(groupedBySession).map(([sessionId, group], index) => ({
                    id: index,
                    sessionId: sessionId,
                    profile: group.profileName,
                    category: group.category, // üî• Add category to result
                    sites: group.sites,
                    username: group.username,
                    timestamp: new Date(group.timestamp).toLocaleString('vi-VN'),
                    register: group.register || { success: true },
                    addBank: group.addBank || { success: true },
                    checkPromo: group.checkPromo || { success: true }
                }));

                console.log(`‚úÖ Loaded ${vipResults.length} automation runs from API`);
            } else {
                vipResults = [];
                console.log('‚ÑπÔ∏è No results found');
            }

            updateResultsTable();
        } catch (error) {
            console.warn('‚ö†Ô∏è Could not load results from API:', error.message);
            vipResults = [];
            updateResultsTable();
        }
    }

    // Initialize tool UI (called by dashboard.js when tool is loaded)
    window.initToolUI = async function (tool) {
        console.log('üöÄ VIP Tool initToolUI called');
        toggleCategorySites();
        await loadResultsFromAPI();
    };

    // Refresh all data (called by dashboard.js)
    window.refreshAllData = async function () {
        console.log('üîÑ VIP Tool refreshAllData called');
        await loadResultsFromAPI();
    };

    // Initialize on load (for direct page load)
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('üöÄ VIP Tool DOMContentLoaded');

        // Load results first (show loading spinner)
        await loadResultsFromAPI();

        // Then do other initialization
        toggleCategorySites();

        console.log('‚úÖ VIP Tool initialized');
    });

    // ============================================
    // AUTO-CLEAR RUNNING STATUS (Polling)
    // ============================================

    // Load automation statuses (running automations) - similar to Nohu
    async function loadVipAutomationStatuses() {
        try {
            const response = await fetch('/api/automation/statuses');
            const data = await response.json();

            if (data.success && data.statuses) {
                // Track which usernames are currently running
                const currentlyRunning = new Set();
                let needsRefresh = false;

                for (const status of data.statuses) {
                    if (status.status === 'running') {
                        currentlyRunning.add(status.username);

                        // Mark profile as running if not already marked
                        if (typeof profileManager !== 'undefined') {
                            const profile = availableProfiles.find(p => p.name === status.username);
                            if (profile && !profileManager.runningProfiles.has(profile.uuid)) {
                                profileManager.runningProfiles.add(profile.uuid);
                                profileManager.runningStartTimes = profileManager.runningStartTimes || new Map();
                                profileManager.runningStartTimes.set(profile.uuid, Date.now());
                                profileManager.saveRunningProfiles();
                                needsRefresh = true;
                                console.log(`‚úÖ Marked profile as running: ${profile.name}`);
                            }
                        }
                    } else if (status.status === 'completed' || status.status === 'error') {
                        // Clear running flag for profile when automation completes
                        if (typeof profileManager !== 'undefined') {
                            const profile = availableProfiles.find(p => p.name === status.username);
                            if (profile && profileManager.runningProfiles.has(profile.uuid)) {
                                profileManager.runningProfiles.delete(profile.uuid);

                                // Cleanup start time tracking
                                if (profileManager.runningStartTimes) {
                                    profileManager.runningStartTimes.delete(profile.uuid);
                                }

                                profileManager.saveRunningProfiles();
                                console.log(`‚úÖ Cleared running flag for profile: ${profile.name} (automation ${status.status})`);

                                // Refresh carousel to update UI
                                const activeTab = document.querySelector('.modal-tab.active')?.getAttribute('data-tab') || 'auto';
                                await loadProfilesCarousel();
                                renderProfileCarousel(activeTab);
                            }
                        }
                    }
                }

                // Sync profileManager.runningProfiles with server state
                const profilesToRemove = [];
                for (const profileId of profileManager.runningProfiles) {
                    const profile = availableProfiles.find(p => p.uuid === profileId);
                    if (profile && !currentlyRunning.has(profile.name)) {
                        // Check if this profile has been marked as running recently (within 30 seconds)
                        const runningStartTime = profileManager.runningStartTimes?.get(profileId) || 0;
                        const timeSinceStart = Date.now() - runningStartTime;

                        // Only remove if it's been more than 30 seconds since marked as running
                        if (timeSinceStart > 30000) {
                            profilesToRemove.push(profileId);
                        }
                    }
                }

                if (profilesToRemove.length > 0) {
                    profilesToRemove.forEach(profileId => {
                        profileManager.runningProfiles.delete(profileId);
                        if (profileManager.runningStartTimes) {
                            profileManager.runningStartTimes.delete(profileId);
                        }
                        console.log(`‚úÖ Synced: Removed running flag for profile ${profileId}`);
                    });
                    profileManager.saveRunningProfiles();
                    needsRefresh = true;
                }

                // Refresh carousel if any changes detected
                if (needsRefresh) {
                    const activeTab = document.querySelector('.modal-tab.active')?.getAttribute('data-tab') || 'auto';
                    await loadProfilesCarousel();
                    renderProfileCarousel(activeTab);
                }
            }
        } catch (error) {
            console.error('Failed to load VIP automation statuses:', error);
        }
    }

    // Start polling automation statuses every 5 seconds (same as nohu)
    setInterval(() => {
        loadVipAutomationStatuses();
    }, 5000);

    // Auto-refresh results table when automation is running
    let lastVipResultsRefresh = 0;
    setInterval(() => {
        const now = Date.now();
        // Only refresh if there are running profiles and it's been at least 5 seconds since last refresh
        if (typeof profileManager !== 'undefined' &&
            profileManager.runningProfiles &&
            profileManager.runningProfiles.size > 0 &&
            now - lastVipResultsRefresh > 5000) {
            lastVipResultsRefresh = now;
            console.log('üîÑ Auto-refreshing VIP results table (automation running)...');
            loadResultsFromAPI();
        }
    }, 5000); // Check every 5 seconds

    // Also check on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadVipAutomationStatuses();
    });

    // Open VIP account info modal
    async function openVipAccountInfoModal(username, category, resultSitesStr = '') {
        const btn = event?.target;
        if (btn) disableButtonTemporarily(btn);

        const modal = document.getElementById('vipAccountInfoModal');
        const title = document.getElementById('vipAccountInfoTitle');
        const content = document.getElementById('vipAccountInfoContent');

        title.textContent = `üìã Th√¥ng Tin T√†i Kho·∫£n - ${username}`;

        try {
            // Parse sites from string
            const resultSites = resultSitesStr ? resultSitesStr.split(',').filter(s => s.trim()) : [];
            console.log('üîç Fetching VIP account info:', { username, category, resultSites });

            let response = null;
            let data = null;

            // üî• FIX: If category is undefined, try all categories
            if (category && category !== 'undefined' && category !== 'N/A') {
                // Try specific category first - use /api/accounts/vip/{category}/{username}
                response = await fetch(`/api/accounts/vip/${category}/${username}`);
                if (response.ok) {
                    data = await response.json();
                    console.log(`üì° Response for ${category}:`, response.status, data);
                }
            }

            // If not found or category is undefined, try all categories
            if (!data || !data.success) {
                console.log('üîç Category not found or undefined, trying all categories...');
                const categories = ['okvip', 'accOkvip', 'abcvip', 'jun88', '78win', 'jun88v2', 'kjc'];

                for (const cat of categories) {
                    response = await fetch(`/api/accounts/vip/${cat}/${username}`);
                    if (response.ok) {
                        data = await response.json();
                        console.log(`üì° Trying ${cat}:`, response.status, data.success);

                        if (data.success) {
                            category = cat; // Update category to the one found
                            console.log(`‚úÖ Found account in category: ${cat}`);
                            break;
                        }
                    }
                }
            }

            if (!data || !data.success) {
                throw new Error(`Account not found for ${username}`);
            }

            const acc = data.account;
            // Use sites from result if available, otherwise use from account data
            const sitesToDisplay = resultSites && resultSites.length > 0 ? resultSites : (acc.sites || []);

            content.innerHTML = `
                <div style="background: #f7fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">üë§</span> Th√¥ng Tin T√†i Kho·∫£n
                        <span
                            style="background: #e2e8f0; color: #4a5568; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${(category || 'VIP').toUpperCase()}
                        </span>
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                        <div>
                            <strong style="color: #4a5568;">üë§ T√™n ƒëƒÉng nh·∫≠p:</strong><br>
                            <span
                                style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${acc.username || 'N/A'}</span>
                        </div>
                        <div>
                            <strong style="color: #4a5568;">üîë M·∫≠t kh·∫©u:</strong><br>
                            <span
                                style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${acc.password || 'N/A'}</span>
                        </div>
                        <div>
                            <strong style="color: #4a5568;">üí∞ MK r√∫t ti·ªÅn:</strong><br>
                            <span
                                style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${acc.withdrawPassword
                || 'N/A'}</span>
                        </div>
                        <div>
                            <strong style="color: #4a5568;">üìù H·ªç v√† t√™n:</strong><br>
                            <span style="color: #2d3748;">${acc.fullname || 'N/A'}</span>
                        </div>
                        <div>
                            <strong style="color: #4a5568;">üè¶ Ng√¢n h√†ng:</strong><br>
                            <span style="color: #2d3748;">${(acc.bank?.name || acc.bankName) || 'N/A'}</span>
                        </div>
                        <div>
                            <strong style="color: #4a5568;">üè¢ Chi nh√°nh:</strong><br>
                            <span style="color: #2d3748;">${(acc.bank?.branch || acc.bankBranch) || 'N/A'}</span>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #4a5568;">üí≥ S·ªë t√†i kho·∫£n:</strong><br>
                            <span
                                style="color: #2d3748; font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${(acc.bank?.accountNumber || acc.accountNumber)
                || 'N/A'}</span>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #4a5568;">üìÖ Ng√†y ƒëƒÉng k√Ω:</strong><br>
                            <span style="color: #718096;">${acc.registeredAt ? new
                    Date(acc.registeredAt).toLocaleString('vi-VN') : 'N/A'}</span>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #4a5568;">üì± C√°c trang ƒë∆∞·ª£c ƒëƒÉng k√Ω:</strong><br>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                                ${sitesToDisplay && sitesToDisplay.length > 0
                    ? sitesToDisplay.map(site => `
                                <span
                                    style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    ${site}
                                </span>
                                `).join('')
                    : '<span style="color: #718096; font-style: italic;">Kh√¥ng c√≥ th√¥ng tin</span>'
                }
                            </div>
                        </div>
                    </div>
                    <div
                        style="margin-top: 15px; padding: 12px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38b2ac;">
                        <p style="margin: 0; color: #234e52; font-size: 13px;">
                            <strong>‚ÑπÔ∏è L∆∞u √Ω:</strong> Th√¥ng tin n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng chung cho t·∫•t c·∫£ trang web trong
                            session n√†y.
                        </p>
                    </div>
                </div>
                `;

            modal.style.display = 'flex';
        } catch (error) {
            console.error('Error loading VIP account info:', error);
            const errorMsg = error.message || 'Unknown error';
            content.innerHTML = `
                    <div style="background: #fff5f5; border-radius: 12px; padding: 20px; border: 1px solid #feb2b2;">
                        <h4 style="margin: 0; color: #c53030;">‚ùå L·ªói t·∫£i th√¥ng tin t√†i kho·∫£n</h4>
                        <p style="margin: 10px 0 0 0; color: #742a2a; font-size: 13px;">
                            <strong>Chi ti·∫øt:</strong> ${errorMsg}<br>
                            <strong>Username:</strong> ${username}<br>
                            <strong>Category:</strong> ${category || 'undefined'}
                        </p>
                        <div
                            style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 6px; font-size: 12px; color: #4a5568;">
                            üí° <strong>C√≥ th·ªÉ do:</strong><br>
                            ‚Ä¢ T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c l∆∞u trong database<br>
                            ‚Ä¢ L·ªói k·∫øt n·ªëi m·∫°ng<br>
                            ‚Ä¢ Th∆∞ m·ª•c accounts ch∆∞a ƒë∆∞·ª£c t·∫°o
                        </div>
                    </div>
                    `;
            modal.style.display = 'flex';
        }
    }

    // Close VIP account info modal
    function closeVipAccountInfoModal() {
        const modal = document.getElementById('vipAccountInfoModal');
        modal.style.display = 'none';
    }



    // Auto-detect category from URL
    function autoDetectCategoryFromUrl(url) {
        try {
            const urlObj = new URL(url);
            const domain = urlObj.hostname.toLowerCase();

            // OKVIP sites
            if (domain.includes('okvip') || domain.includes('ok-vip') ||
                domain.includes('hi88') || domain.includes('f8bet') ||
                domain.includes('shbet') || domain.includes('tigerstorm') ||
                domain.includes('new88') || domain.includes('mb66') ||
                domain.includes('789bet')) {
                return 'okvip';
            }

            // ABCVIP sites
            if (domain.includes('abcvip') || domain.includes('abc-vip') ||
                domain.includes('u888') || domain.includes('j88') ||
                domain.includes('abc8') || domain.includes('888clb')) {
                return 'abcvip';
            }

            // JUN88 sites
            if (domain.includes('jun88') || domain.includes('jun-88')) {
                return 'jun88';
            }

            // KJC sites
            if (domain.includes('kjc') || domain.includes('k-jc')) {
                return 'kjc';
            }

            return null; // Could not detect
        } catch (error) {
            console.error('Error auto-detecting category:', error);
            return null;
        }
    }





    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeVipAccountInfoModal();
        }
    });
</script>