<!-- Load HAI2VIP Tool CSS -->
<link rel="stylesheet" href="tools-ui/hai2vip-tool.css">

<!-- HAI2VIP Auto Tool UI -->
<div class="hai2vip-tool-container">

    <!-- Info Banner -->
    <div class="info-banner">
        <h3>ğŸ° HAI2VIP Auto Tool</h3>
        <p>Tá»± Ä‘á»™ng Ä‘Äƒng kÃ½, Ä‘Äƒng nháº­p, thÃªm ngÃ¢n hÃ ng vÃ  nháº­n khuyáº¿n mÃ£i cho cÃ¡c trang 22vip</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="auto">ğŸ¤– Tá»± Äá»™ng</div>
        <div class="tab" data-tab="register">ğŸ“ ÄÄƒng KÃ½</div>
        <div class="tab" data-tab="login">ğŸ” ÄÄƒng Nháº­p</div>
        <div class="tab" data-tab="withdraw">ğŸ’° RÃºt Tiá»n</div>
        <div class="tab" data-tab="phone">ğŸ“± XÃ¡c Thá»±c SÄT</div>
        <div class="tab" data-tab="promo">ğŸ Khuyáº¿n MÃ£i</div>
    </div>

    <!-- Sites Selection (Shared) -->
    <div class="form-section">
        <h3>ğŸ¯ Chá»n Trang</h3>
        <div class="sites-grid">
            <label class="site-card">
                <input type="checkbox" class="site-check" data-name="28bet"
                    data-register="https://2899bb.com/home/register" data-login="https://2899bb.com/home/login"
                    data-promo="https://2899bb.com/home/event/detail?current=1&template=1&eventId=118">
                <div class="site-icon site-28">28</div>
                <div class="site-name">28bet</div>
            </label>
            <label class="site-card">
                <input type="checkbox" class="site-check" data-name="888vi"
                    data-register="https://888vi8.com/home/register?id=486645938"
                    data-login="https://888vi8.com/home/login"
                    data-promo="https://888vi8.com/home/event/detail?current=1&template=1&eventId=4">
                <div class="site-icon site-888">888</div>
                <div class="site-name">888vi</div>
            </label>
            <label class="site-card">
                <input type="checkbox" class="site-check" data-name="TV88"
                    data-register="https://tv88vip.com/home/register" data-login="https://tv88vip.com/home/login"
                    data-promo="https://tv88vip.com/home/event/detail?current=1&template=1&eventId=443">
                <div class="site-icon site-tv">TV</div>
                <div class="site-name">TV88</div>
            </label>
            <label class="site-card">
                <input type="checkbox" class="site-check" data-name="888now"
                    data-register="https://888now333.com/home/register?id=122472500"
                    data-login="https://888now333.com/home/login"
                    data-promo="https://888now333.com/home/event/detail?current=1&template=1&eventId=1">
                <div class="site-icon site-now">now</div>
                <div class="site-name">888now</div>
            </label>
            <label class="site-card">
                <input type="checkbox" class="site-check" data-name="888new"
                    data-register="https://888new10.com/home/register" data-login="https://888new10.com/home/login"
                    data-promo="https://888new10.com/home/event/detail?current=1&template=1&eventId=248">
                <div class="site-icon site-new">888</div>
                <div class="site-name">888new</div>
            </label>
            <label class="site-card">
                <input type="checkbox" class="site-check" data-name="Win678"
                    data-register="https://m.win678oo.com/home/register" data-login="https://m.win678oo.com/home/login"
                    data-promo="https://m.win678oo.com/home/event/detail?current=1&template=1&eventId=589">
                <div class="site-icon site-678">678</div>
                <div class="site-name">Win678</div>
            </label>
            <label class="site-card">
                <input type="checkbox" class="site-check" data-name="888p"
                    data-register="https://m.888p28.com/?fixed.iswebclip=2" data-login="https://m.888p28.com/home/login"
                    data-promo="https://m.888p28.com/home/event/detail?current=1&template=1&eventId=990">
                <div class="site-icon site-888p">888</div>
                <div class="site-name">888p</div>
            </label>
        </div>
        <div class="site-actions">
            <button class="btn btn-sm" onclick="selectAllSites()">âœ… Chá»n Táº¥t Cáº£</button>
            <button class="btn btn-sm" onclick="deselectAllSites()">âŒ Bá» Chá»n</button>
        </div>
    </div>

    <!-- Tab Content: Auto -->
    <div class="tab-content active" id="tab-auto">
        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“‹ Chá»n Profile</h3>
                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()" title="Táº£i láº¡i profiles">ğŸ”„
                    Táº£i Láº¡i</button>
            </div>

            <!-- Profile Carousel -->
            <div class="profile-carousel-wrapper">
                <div class="profile-carousel-container">
                    <button class="carousel-btn carousel-prev" onclick="scrollProfileCarousel('auto', -1)">â€¹</button>
                    <div class="profile-carousel" id="autoProfileCarousel">
                        <div class="profile-carousel-empty">
                            <p>Click "Táº£i Láº¡i" Ä‘á»ƒ xem profiles</p>
                        </div>
                    </div>
                    <button class="carousel-btn carousel-next" onclick="scrollProfileCarousel('auto', 1)">â€º</button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ‘¤ ThÃ´ng Tin TÃ i Khoáº£n</h3>
            <div class="form-grid">
                <div class="input-with-button">
                    <input type="text" id="autoUsername" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i/TÃªn tÃ i khoáº£n">
                    <button class="btn-icon" onclick="generateUsername('autoUsername')" title="Random">ğŸ²</button>
                </div>
                <input type="text" id="autoFullname" placeholder="Há» vÃ  TÃªn (IN HOA)">
                <input type="password" id="autoPassword" placeholder="Máº­t kháº©u">
                <input type="password" id="autoWithdrawPassword" placeholder="MK rÃºt tiá»n (6 sá»‘)" maxlength="6">
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ’³ ThÃ´ng Tin NgÃ¢n HÃ ng</h3>
            <div class="form-grid">
                <select id="autoBankName">
                    <option value="">Chá»n ngÃ¢n hÃ ng...</option>
                </select>
                <input type="text" id="autoAccountNumber" placeholder="Sá»‘ tÃ i khoáº£n">
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ“± API Key SIM</h3>
            <div style="background: #e0e7ff; padding: 12px; border-radius: 8px; font-size: 13px; color: #4a5568;">
                â„¹ï¸ SIM API Key Ä‘Æ°á»£c quáº£n lÃ½ táº­p trung á»Ÿ sidebar bÃªn trÃ¡i
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary btn-large" onclick="hai2vipRunAutoSequence()">
                ğŸš€ CHáº Y Tá»° Äá»˜NG (ÄÄƒng KÃ½ â†’ ÄÄƒng Nháº­p â†’ RÃºt Tiá»n â†’ XÃ¡c Thá»±c â†’ KM)
            </button>
        </div>
    </div>

    <!-- Tab Content: Register -->
    <div class="tab-content" id="tab-register">
        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“‹ Chá»n Profile</h3>
                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()" title="Táº£i láº¡i profiles">ğŸ”„
                    Táº£i Láº¡i</button>
            </div>

            <div class="profile-carousel-wrapper">
                <div class="profile-carousel-container">
                    <button class="carousel-btn carousel-prev" onclick="scrollProfileCarousel('reg', -1)">â€¹</button>
                    <div class="profile-carousel" id="regProfileCarousel">
                        <div class="profile-carousel-empty">
                            <p>Click "Táº£i Láº¡i" Ä‘á»ƒ xem profiles</p>
                        </div>
                    </div>
                    <button class="carousel-btn carousel-next" onclick="scrollProfileCarousel('reg', 1)">â€º</button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ‘¤ ThÃ´ng Tin ÄÄƒng KÃ½</h3>
            <div class="form-grid">
                <div class="input-with-button">
                    <input type="text" id="regUsername" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i/TÃªn tÃ i khoáº£n">
                    <button class="btn-icon" onclick="generateUsername('regUsername')" title="Random">ğŸ²</button>
                </div>
                <input type="text" id="regFullname" placeholder="Há» vÃ  TÃªn (IN HOA)">
                <input type="password" id="regPassword" placeholder="Máº­t kháº©u">
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary btn-large" onclick="hai2vipRunRegisterOnly()">
                ğŸ“ ÄÄƒng KÃ½
            </button>
        </div>
    </div>

    <!-- Tab Content: Login -->
    <div class="tab-content" id="tab-login">
        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“‹ Chá»n Profile</h3>
                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()" title="Táº£i láº¡i profiles">ğŸ”„
                    Táº£i Láº¡i</button>
            </div>

            <div class="profile-carousel-wrapper">
                <div class="profile-carousel-container">
                    <button class="carousel-btn carousel-prev" onclick="scrollProfileCarousel('login', -1)">â€¹</button>
                    <div class="profile-carousel" id="loginProfileCarousel">
                        <div class="profile-carousel-empty">
                            <p>Click "Táº£i Láº¡i" Ä‘á»ƒ xem profiles</p>
                        </div>
                    </div>
                    <button class="carousel-btn carousel-next" onclick="scrollProfileCarousel('login', 1)">â€º</button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ” ThÃ´ng Tin ÄÄƒng Nháº­p</h3>
            <div class="form-grid">
                <input type="text" id="loginUsername" placeholder="TÃªn tÃ i khoáº£n">
                <input type="password" id="loginPassword" placeholder="Máº­t kháº©u">
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary btn-large" onclick="hai2vipRunLoginOnly()">
                ğŸ” ÄÄƒng Nháº­p
            </button>
        </div>
    </div>

    <!-- Tab Content: Withdraw -->
    <div class="tab-content" id="tab-withdraw">
        <div class="warning-banner">
            <strong>âš ï¸ LÆ°u Ã½:</strong> Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c vÃ o cÃ¡c trang trÆ°á»›c khi sá»­ dá»¥ng chá»©c nÄƒng nÃ y.
        </div>

        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“‹ Chá»n Profile</h3>
                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()" title="Táº£i láº¡i profiles">ğŸ”„
                    Táº£i Láº¡i</button>
            </div>

            <div class="profile-carousel-wrapper">
                <div class="profile-carousel-container">
                    <button class="carousel-btn carousel-prev"
                        onclick="scrollProfileCarousel('withdraw', -1)">â€¹</button>
                    <div class="profile-carousel" id="withdrawProfileCarousel">
                        <div class="profile-carousel-empty">
                            <p>Click "Táº£i Láº¡i" Ä‘á»ƒ xem profiles</p>
                        </div>
                    </div>
                    <button class="carousel-btn carousel-next" onclick="scrollProfileCarousel('withdraw', 1)">â€º</button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ’³ ThÃ´ng Tin NgÃ¢n HÃ ng</h3>
            <div class="form-grid">
                <select id="withdrawBankName">
                    <option value="">Chá»n ngÃ¢n hÃ ng...</option>
                </select>
                <input type="text" id="withdrawAccountNumber" placeholder="Sá»‘ tÃ i khoáº£n">
                <input type="password" id="withdrawWithdrawPassword" placeholder="Máº­t kháº©u rÃºt tiá»n (6 sá»‘)"
                    maxlength="6">
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary btn-large" onclick="hai2vipRunWithdrawOnly()"></button>
            ğŸ’° Thiáº¿t Láº­p RÃºt Tiá»n & ThÃªm Bank
            </button>
        </div>
    </div>

    <!-- Tab Content: Phone Verify -->
    <div class="tab-content" id="tab-phone">
        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“‹ Chá»n Profile</h3>
                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()" title="Táº£i láº¡i profiles">ğŸ”„
                    Táº£i Láº¡i</button>
            </div>

            <div class="profile-carousel-wrapper">
                <div class="profile-carousel-container">
                    <button class="carousel-btn carousel-prev" onclick="scrollProfileCarousel('phone', -1)">â€¹</button>
                    <div class="profile-carousel" id="phoneProfileCarousel">
                        <div class="profile-carousel-empty">
                            <p>Click "Táº£i Láº¡i" Ä‘á»ƒ xem profiles</p>
                        </div>
                    </div>
                    <button class="carousel-btn carousel-next" onclick="scrollProfileCarousel('phone', 1)">â€º</button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ“± API Key SIM</h3>
            <div style="background: #e0e7ff; padding: 12px; border-radius: 8px; font-size: 13px; color: #4a5568;">
                â„¹ï¸ SIM API Key Ä‘Æ°á»£c quáº£n lÃ½ táº­p trung á»Ÿ sidebar bÃªn trÃ¡i
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary btn-large" onclick="hai2vipRunPhoneVerify()"></button>
            ğŸ“± XÃ¡c Thá»±c Sá»‘ Äiá»‡n Thoáº¡i
            </button>
        </div>
    </div>

    <!-- Tab Content: Promo -->
    <div class="tab-content" id="tab-promo">
        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“‹ Chá»n Profile</h3>
                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()" title="Táº£i láº¡i profiles">ğŸ”„
                    Táº£i Láº¡i</button>
            </div>

            <div class="profile-carousel-wrapper">
                <div class="profile-carousel-container">
                    <button class="carousel-btn carousel-prev" onclick="scrollProfileCarousel('promo', -1)">â€¹</button>
                    <div class="profile-carousel" id="promoProfileCarousel">
                        <div class="profile-carousel-empty">
                            <p>Click "Táº£i Láº¡i" Ä‘á»ƒ xem profiles</p>
                        </div>
                    </div>
                    <button class="carousel-btn carousel-next" onclick="scrollProfileCarousel('promo', 1)">â€º</button>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary btn-large" onclick="hai2vipRunCheckPromo()">
                ğŸ Nháº­n Khuyáº¿n MÃ£i
            </button>
        </div>
    </div>

</div>

<!-- HAI2VIP Tool JavaScript -->
<script>
    // Initialize tool when loaded
    window.initToolUI = function (tool) {
        console.log('ğŸ° Initializing HAI2VIP Tool UI...', tool);

        // Initialize tab switching
        initTabSwitching();

        // Load banks
        loadBanksForTool();

        // Load profiles for carousel
        loadProfilesCarousel();

        console.log('âœ… HAI2VIP Tool initialized');
    };

    // Tab switching
    function initTabSwitching() {
        const tabs = document.querySelectorAll('.hai2vip-tool-container .tab');
        console.log('Found tabs:', tabs.length);

        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                const tabName = this.getAttribute('data-tab');
                console.log('Tab clicked:', tabName);

                // Remove active from all
                document.querySelectorAll('.hai2vip-tool-container .tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.hai2vip-tool-container .tab-content').forEach(c => c.classList.remove('active'));

                // Add active to clicked
                this.classList.add('active');
                const content = document.getElementById(`tab-${tabName}`);
                if (content) {
                    content.classList.add('active');
                    console.log('Switched to tab:', tabName);
                } else {
                    console.error('Tab content not found:', `tab-${tabName}`);
                }
            });
        });

        console.log('âœ… Tab switching initialized');
    }

    // Site selection
    function selectAllSites() {
        document.querySelectorAll('.site-check').forEach(cb => cb.checked = true);
    }

    function deselectAllSites() {
        document.querySelectorAll('.site-check').forEach(cb => cb.checked = false);
    }

    function getSelectedSites(action) {
        const sites = [];
        document.querySelectorAll('.site-check:checked').forEach(checkbox => {
            const name = checkbox.getAttribute('data-name');
            const url = checkbox.getAttribute(`data-${action}`);
            if (url) sites.push({ name, url });
        });
        return sites;
    }

    // Load banks
    async function loadBanksForTool() {
        const selects = ['autoBankName', 'withdrawBankName'];
        try {
            const response = await fetch('https://api.vietqr.io/v2/banks');
            const data = await response.json();
            if (data.code === '00' && data.data) {
                const sortedBanks = data.data.sort((a, b) => a.shortName.localeCompare(b.shortName));
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Chá»n ngÃ¢n hÃ ng...</option>';
                        sortedBanks.forEach(bank => {
                            const option = document.createElement('option');
                            option.value = bank.shortName;
                            option.textContent = `${bank.shortName} - ${bank.name}`;
                            select.appendChild(option);
                        });
                    }
                });
                console.log(`âœ… Loaded ${sortedBanks.length} banks`);
            }
        } catch (error) {
            console.error('âŒ Failed to load banks:', error);
        }
    }

    // Random username generator
    const hai2vipUniqueWords = {
        prefixes: ['Sky', 'Moon', 'Star', 'Fire', 'Dragon', 'Phoenix', 'Tiger', 'Wolf', 'Eagle', 'Lion'],
        suffixes: ['Blade', 'Strike', 'Storm', 'Fire', 'Bolt', 'Flash', 'Fury', 'Soul', 'Power'],
        numbers: ['', '1', '7', '9', '88', '99', '777', '888']
    };

    function generateRandomUsername() {
        const prefix = hai2vipUniqueWords.prefixes[Math.floor(Math.random() * hai2vipUniqueWords.prefixes.length)];
        const suffix = hai2vipUniqueWords.suffixes[Math.floor(Math.random() * hai2vipUniqueWords.suffixes.length)];
        const number = hai2vipUniqueWords.numbers[Math.floor(Math.random() * hai2vipUniqueWords.numbers.length)];
        return prefix + suffix + number;
    }

    function generateUsername(inputId) {
        const username = generateRandomUsername();
        const input = document.getElementById(inputId);
        if (input) {
            input.value = username;
            input.style.background = 'linear-gradient(135deg, #ebf4ff, #e0e7ff)';
            setTimeout(() => { input.style.background = ''; }, 1000);
        }
    }

    // Automation functions
    async function hai2vipRunAutoSequence() {
        console.log('ğŸš€ HAI2VIP runAutoSequence called');
        console.log('Selected Profile ID:', profileManager.selectedProfileId);

        if (!profileManager.selectedProfileId) {
            showToast('warning', 'ChÆ°a chá»n profile', 'Vui lÃ²ng chá»n profile tá»« carousel');
            return;
        }

        // Sync profile status from Hidemium before running
        console.log('ğŸ”„ Syncing profile status from Hidemium...');
        await profileManager.loadAll();
        await loadProfilesCarousel();

        // Check if profile is already running
        if (profileManager.isRunning(profileManager.selectedProfileId)) {
            showToast('warning', 'Profile Ä‘ang cháº¡y', 'Profile nÃ y Ä‘ang cháº¡y automation, vui lÃ²ng chá»n profile khÃ¡c');
            return;
        }

        const sites = getSelectedSites('register');
        console.log('Selected sites:', sites);

        if (sites.length === 0) {
            showToast('warning', 'ChÆ°a chá»n trang', 'Vui lÃ²ng chá»n Ã­t nháº¥t 1 trang');
            return;
        }

        const config = {
            username: document.getElementById('autoUsername')?.value || '',
            fullname: document.getElementById('autoFullname')?.value || '',
            password: document.getElementById('autoPassword')?.value || '',
            withdrawPassword: document.getElementById('autoWithdrawPassword')?.value || '',
            bankName: document.getElementById('autoBankName')?.value || '',
            accountNumber: document.getElementById('autoAccountNumber')?.value || '',
            apiKey: simApiManager.get(),
            sites: sites
        };

        console.log('Config:', config);

        if (!config.username || !config.password) {
            showToast('warning', 'Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng Ä‘iá»n username vÃ  password');
            return;
        }

        const currentProfileId = profileManager.selectedProfileId;

        // Mark profile as running
        profileManager.runningProfiles.add(currentProfileId);
        profileManager.saveRunningProfiles();

        // Refresh carousel to show running status
        await loadProfilesCarousel();

        showToast('info', 'Äang cháº¡y', `Automation Ä‘ang cháº¡y trÃªn ${sites.length} trang...`);

        try {
            console.log('Sending request to server...');
            // Use relative URL to automatically use current port
            const response = await fetch('/api/automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toolId: 'hai2vip-tool', profileId: currentProfileId, config: config })
            });

            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);

            if (data.success) {
                showToast('success', 'ÄÃ£ khá»Ÿi Ä‘á»™ng', 'Automation Ä‘ang cháº¡y trong background...', 7000);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            console.error('âŒ Error:', error);
            showToast('error', 'Lá»—i', error.message);
            // Unmark on error
            profileManager.runningProfiles.delete(currentProfileId);
            profileManager.saveRunningProfiles();
            await loadProfilesCarousel();
        }
    }

    async function hai2vipRunRegisterOnly() {
        if (!profileManager.selectedProfileId) {
            showToast('warning', 'ChÆ°a chá»n profile', 'Vui lÃ²ng chá»n profile tá»« carousel');
            return;
        }
        const sites = getSelectedSites('register');
        if (sites.length === 0) {
            showToast('warning', 'ChÆ°a chá»n trang', 'Vui lÃ²ng chá»n Ã­t nháº¥t 1 trang');
            return;
        }
        const config = {
            action: 'register',
            username: document.getElementById('regUsername')?.value || '',
            fullname: document.getElementById('regFullname')?.value || '',
            password: document.getElementById('regPassword')?.value || '',
            sites: sites
        };
        if (!config.username || !config.password) {
            showToast('warning', 'Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');
            return;
        }
        showToast('info', 'Äang Ä‘Äƒng kÃ½', `Äang Ä‘Äƒng kÃ½ trÃªn ${sites.length} trang...`);
        try {
            // Use relative URL to automatically use current port
            const response = await fetch('/api/automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toolId: 'hai2vip-tool', profileId: profileManager.selectedProfileId, config: config })
            });
            const data = await response.json();
            if (data.success) {
                showToast('success', 'ÄÃ£ khá»Ÿi Ä‘á»™ng', 'ÄÄƒng kÃ½ Ä‘ang cháº¡y...', 5000);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            showToast('error', 'Lá»—i', error.message);
        }
    }

    async function hai2vipRunLoginOnly() {
        if (!profileManager.selectedProfileId) {
            showToast('warning', 'ChÆ°a chá»n profile', 'Vui lÃ²ng chá»n profile tá»« carousel');
            return;
        }
        const sites = getSelectedSites('login');
        if (sites.length === 0) {
            showToast('warning', 'ChÆ°a chá»n trang', 'Vui lÃ²ng chá»n Ã­t nháº¥t 1 trang');
            return;
        }
        const config = {
            action: 'login',
            username: document.getElementById('loginUsername')?.value || '',
            password: document.getElementById('loginPassword')?.value || '',
            sites: sites
        };
        if (!config.username || !config.password) {
            showToast('warning', 'Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');
            return;
        }
        showToast('info', 'Äang Ä‘Äƒng nháº­p', `Äang Ä‘Äƒng nháº­p vÃ o ${sites.length} trang...`);
        try {
            // Use relative URL to automatically use current port
            const response = await fetch('/api/automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toolId: 'hai2vip-tool', profileId: profileManager.selectedProfileId, config: config })
            });
            const data = await response.json();
            if (data.success) {
                showToast('success', 'ÄÃ£ khá»Ÿi Ä‘á»™ng', 'ÄÄƒng nháº­p Ä‘ang cháº¡y...', 5000);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            showToast('error', 'Lá»—i', error.message);
        }
    }

    async function hai2vipRunWithdrawOnly() {
        if (!profileManager.selectedProfileId) {
            showToast('warning', 'ChÆ°a chá»n profile', 'Vui lÃ²ng chá»n profile tá»« carousel');
            return;
        }
        const sites = getSelectedSites('login');
        if (sites.length === 0) {
            showToast('warning', 'ChÆ°a chá»n trang', 'Vui lÃ²ng chá»n Ã­t nháº¥t 1 trang');
            return;
        }
        const config = {
            action: 'withdraw',
            withdrawPassword: document.getElementById('withdrawWithdrawPassword')?.value || '',
            accountNumber: document.getElementById('withdrawAccountNumber')?.value || '',
            bankName: document.getElementById('withdrawBankName')?.value || '',
            sites: sites
        };
        if (!config.withdrawPassword || !config.accountNumber || !config.bankName) {
            showToast('warning', 'Thiáº¿u thÃ´ng tin', 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin ngÃ¢n hÃ ng');
            return;
        }
        showToast('info', 'Äang thiáº¿t láº­p', `Äang thiáº¿t láº­p rÃºt tiá»n trÃªn ${sites.length} trang...`);
        try {
            // Use relative URL to automatically use current port
            const response = await fetch('/api/automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toolId: 'hai2vip-tool', profileId: profileManager.selectedProfileId, config: config })
            });
            const data = await response.json();
            if (data.success) {
                showToast('success', 'ÄÃ£ khá»Ÿi Ä‘á»™ng', 'Thiáº¿t láº­p rÃºt tiá»n Ä‘ang cháº¡y...', 5000);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            showToast('error', 'Lá»—i', error.message);
        }
    }

    async function hai2vipRunPhoneVerify() {
        if (!profileManager.selectedProfileId) {
            showToast('warning', 'ChÆ°a chá»n profile', 'Vui lÃ²ng chá»n profile tá»« carousel');
            return;
        }
        const sites = getSelectedSites('login');
        if (sites.length === 0) {
            showToast('warning', 'ChÆ°a chá»n trang', 'Vui lÃ²ng chá»n Ã­t nháº¥t 1 trang');
            return;
        }
        const apiKey = simApiManager.get();
        if (!apiKey) {
            showToast('warning', 'Thiáº¿u SIM API Key', 'Vui lÃ²ng nháº­p SIM API Key á»Ÿ sidebar');
            return;
        }
        const config = {
            action: 'phone',
            apiKey: apiKey,
            sites: sites
        };
        showToast('info', 'Äang xÃ¡c thá»±c', `Äang xÃ¡c thá»±c SÄT trÃªn ${sites.length} trang...`);
        try {
            // Use relative URL to automatically use current port
            const response = await fetch('/api/automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toolId: 'hai2vip-tool', profileId: profileManager.selectedProfileId, config: config })
            });
            const data = await response.json();
            if (data.success) {
                showToast('success', 'ÄÃ£ khá»Ÿi Ä‘á»™ng', 'XÃ¡c thá»±c SÄT Ä‘ang cháº¡y...', 5000);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            showToast('error', 'Lá»—i', error.message);
        }
    }

    async function hai2vipRunCheckPromo() {
        if (!profileManager.selectedProfileId) {
            showToast('warning', 'ChÆ°a chá»n profile', 'Vui lÃ²ng chá»n profile tá»« carousel');
            return;
        }
        const sites = getSelectedSites('promo');
        if (sites.length === 0) {
            showToast('warning', 'ChÆ°a chá»n trang', 'Vui lÃ²ng chá»n Ã­t nháº¥t 1 trang');
            return;
        }
        const config = {
            action: 'promo',
            sites: sites
        };
        showToast('info', 'Äang nháº­n KM', `Äang nháº­n khuyáº¿n mÃ£i trÃªn ${sites.length} trang...`);
        try {
            // Use relative URL to automatically use current port
            const response = await fetch('/api/automation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toolId: 'hai2vip-tool', profileId: profileManager.selectedProfileId, config: config })
            });
            const data = await response.json();
            if (data.success) {
                showToast('success', 'ÄÃ£ khá»Ÿi Ä‘á»™ng', 'Nháº­n khuyáº¿n mÃ£i Ä‘ang cháº¡y...', 5000);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            showToast('error', 'Lá»—i', error.message);
        }
    }

    // Profile Carousel
    let allProfilesData = [];

    async function loadProfilesCarousel() {
        const result = await profileManager.loadAll();

        if (result.success && result.profiles) {
            allProfilesData = result.profiles;

            // Update all carousels
            const carousels = ['auto', 'reg', 'login', 'withdraw', 'phone', 'promo'];

            carousels.forEach(tabPrefix => {
                displayProfilesInCarousel(tabPrefix, allProfilesData);
            });

            showToast('success', 'ÄÃ£ táº£i profiles', `${allProfilesData.length} profiles`);
            console.log(`âœ… Loaded ${allProfilesData.length} profiles into carousels`);
        } else {
            showToast('error', 'Lá»—i táº£i profiles', result.error);
            console.error('âŒ Failed to load profiles:', result.error);
        }
    }

    function displayProfilesInCarousel(tabPrefix, profiles) {
        const carousel = document.getElementById(`${tabPrefix}ProfileCarousel`);
        if (!carousel) return;

        carousel.innerHTML = '';

        if (profiles.length === 0) {
            carousel.innerHTML = '<div class="profile-carousel-empty"><p>ChÆ°a cÃ³ profiles</p></div>';
            return;
        }

        profiles.forEach(profile => {
            const isRunning = profileManager.isRunning(profile.uuid);
            const isSelected = profileManager.selectedProfileId === profile.uuid;

            // Extract proxy IP
            let proxyIP = 'No proxy';
            if (profile.proxy && typeof profile.proxy === 'object' && profile.proxy.ip) {
                proxyIP = profile.proxy.ip;
            } else if (profile.proxy && typeof profile.proxy === 'string') {
                const parts = profile.proxy.split('|');
                if (parts.length >= 2 && parts[1]) {
                    proxyIP = parts[1];
                }
            }

            // OS & Browser icons
            const osIcons = { 'win': 'ğŸªŸ', 'windows': 'ğŸªŸ', 'mac': 'ğŸ', 'macos': 'ğŸ', 'linux': 'ğŸ§', 'android': 'ğŸ¤–', 'ios': 'ğŸ“±' };
            const browserIcons = { 'chrome': 'ğŸŒ', 'firefox': 'ğŸ¦Š', 'edge': 'ğŸ”·', 'opera': 'ğŸ”´', 'brave': 'ğŸ¦', 'safari': 'ğŸ§­' };
            const osIcon = osIcons[profile.os?.toLowerCase()] || 'ğŸ’»';
            const browserIcon = browserIcons[profile.browser?.toLowerCase()] || 'ğŸŒ';

            const card = document.createElement('div');
            card.className = `profile-carousel-card ${isSelected ? 'selected' : ''} ${isRunning ? 'running' : ''}`;
            card.setAttribute('data-uuid', profile.uuid);
            card.setAttribute('data-tab', tabPrefix);

            card.innerHTML = `
                <div class="profile-card-header">
                    <div class="profile-avatar">
                        ${profile.name ? profile.name.substring(0, 2).toUpperCase() : 'PR'}
                    </div>
                    ${isRunning ? '<span class="running-badge">â— Running</span>' : ''}
                    ${isSelected ? '<span class="selected-badge">âœ“ Selected</span>' : ''}
                </div>
                <div class="profile-card-body">
                    <div class="profile-card-name">${profile.name || 'Unnamed Profile'}</div>
                    <div class="profile-card-info">
                        <div class="info-item">
                            <span class="info-icon">${osIcon}</span>
                            <span class="info-text">${profile.os || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">${browserIcon}</span>
                            <span class="info-text">${profile.browser || 'chrome'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">ğŸŒ</span>
                            <span class="info-text">${proxyIP}</span>
                        </div>
                    </div>
                </div>
                <div class="profile-card-footer">
                    <button class="btn-select-profile ${isRunning ? 'disabled' : ''}" 
                            onclick="selectProfileFromCarousel('${tabPrefix}', '${profile.uuid}')"
                            ${isRunning ? 'disabled' : ''}>
                        ${isRunning ? 'ğŸ”´ Äang Cháº¡y' : (isSelected ? 'âœ“ ÄÃ£ Chá»n' : 'Chá»n Profile')}
                    </button>
                </div>
            `;

            carousel.appendChild(card);
        });
    }

    function selectProfileFromCarousel(tabPrefix, uuid) {
        // Check if profile is running
        if (profileManager.isRunning(uuid)) {
            showToast('warning', 'Profile Ä‘ang cháº¡y', 'KhÃ´ng thá»ƒ chá»n profile Ä‘ang cháº¡y automation');
            return;
        }

        // Select in manager
        profileManager.select(uuid);

        // Update all carousels to show selected state
        const carousels = ['auto', 'reg', 'login', 'withdraw', 'phone', 'promo'];
        carousels.forEach(prefix => {
            const carousel = document.getElementById(`${prefix}ProfileCarousel`);
            if (carousel) {
                // Remove selected class from all cards
                carousel.querySelectorAll('.profile-carousel-card').forEach(card => {
                    card.classList.remove('selected');
                    const btn = card.querySelector('.btn-select-profile');
                    if (btn) {
                        const cardUuid = card.getAttribute('data-uuid');
                        const isRunning = profileManager.isRunning(cardUuid);
                        btn.textContent = isRunning ? 'ğŸ”´ Äang Cháº¡y' : 'Chá»n Profile';
                    }
                });

                // Add selected class to the selected card
                const selectedCard = carousel.querySelector(`[data-uuid="${uuid}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    const btn = selectedCard.querySelector('.btn-select-profile');
                    if (btn) btn.textContent = 'âœ“ ÄÃ£ Chá»n';
                }
            }
        });

        const profile = profileManager.getSelected();
        showToast('success', 'Profile Ä‘Ã£ chá»n', profile?.name || 'Unknown');
    }

    function scrollProfileCarousel(tabPrefix, direction) {
        const carousel = document.getElementById(`${tabPrefix}ProfileCarousel`);
        console.log('Scroll carousel:', tabPrefix, direction, carousel);

        if (!carousel) {
            console.error('Carousel not found:', `${tabPrefix}ProfileCarousel`);
            return;
        }

        const cardWidth = 350; // 320px card + 30px gap
        const scrollAmount = cardWidth * direction;

        console.log('Scrolling by:', scrollAmount);

        carousel.scrollBy({
            left: scrollAmount,
            behavior: 'smooth'
        });

        // Update card states after scroll
        setTimeout(() => updateCarouselCardStates(tabPrefix), 400);
    }

    function updateCarouselCardStates(tabPrefix) {
        const carousel = document.getElementById(`${tabPrefix}ProfileCarousel`);
        if (!carousel) return;

        const cards = carousel.querySelectorAll('.profile-carousel-card');
        const carouselRect = carousel.getBoundingClientRect();
        const carouselCenter = carouselRect.left + carouselRect.width / 2;

        cards.forEach(card => {
            const cardRect = card.getBoundingClientRect();
            const cardCenter = cardRect.left + cardRect.width / 2;
            const distance = Math.abs(carouselCenter - cardCenter);

            // Card is in center view if distance is small
            if (distance < 200) {
                card.classList.add('in-view');
            } else {
                card.classList.remove('in-view');
            }
        });
    }

    // Drag to scroll
    function enableDragScroll(carousel) {
        let isDown = false;
        let startX;
        let scrollLeft;

        carousel.addEventListener('mousedown', (e) => {
            // Don't drag if clicking on button
            if (e.target.closest('.btn-select-profile')) return;

            isDown = true;
            carousel.style.cursor = 'grabbing';
            carousel.style.userSelect = 'none';
            startX = e.pageX - carousel.offsetLeft;
            scrollLeft = carousel.scrollLeft;
        });

        carousel.addEventListener('mouseleave', () => {
            isDown = false;
            carousel.style.cursor = 'grab';
        });

        carousel.addEventListener('mouseup', () => {
            isDown = false;
            carousel.style.cursor = 'grab';
        });

        carousel.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - carousel.offsetLeft;
            const walk = (x - startX) * 2; // Scroll speed
            carousel.scrollLeft = scrollLeft - walk;
        });

        // Set initial cursor
        carousel.style.cursor = 'grab';
    }

    // Update card states on scroll and enable drag
    document.addEventListener('DOMContentLoaded', () => {
        const carousels = ['auto', 'reg', 'login', 'withdraw', 'phone', 'promo'];
        carousels.forEach(prefix => {
            const carousel = document.getElementById(`${prefix}ProfileCarousel`);
            if (carousel) {
                // Enable scroll update
                carousel.addEventListener('scroll', () => {
                    updateCarouselCardStates(prefix);
                });

                // Enable drag to scroll
                enableDragScroll(carousel);
            }
        });
    });

    console.log('âœ… HAI2VIP Tool JavaScript loaded');
</script>