<!-- Load Common CSS -->
<link rel="stylesheet" href="tools-ui/common.css">
<!-- Load SMS Tool Specific CSS -->
<link rel="stylesheet" href="tools-ui/sms/sms.css">
<!-- Load Shared JS (drag-to-scroll, etc.) -->
<script src="tools-ui/shared/shared.js"></script>

<!-- Load Core Managers -->
<script src="../core/profile-manager.js"></script>
<script src="../core/api-key-manager.js"></script>

<!-- Inline Critical CSS for immediate rendering -->
<style>
    .sms-tool-container {
        padding: 0;
        width: 100%;
    }

    .form-section {
        background: #f7fafc;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
    }

    .results-table-wrapper {
        overflow-x: auto;
        overflow-y: auto;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        flex: 1 1 auto;
        min-height: 200px;
        max-height: calc(100vh - 400px);
        border: 1px solid #e5e7eb;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
    }

    .results-table thead {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .results-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
    }

    .results-table td {
        padding: 15px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
        color: #2d3748;
    }

    /* Check times badge */
    .check-times-badge {
        display: inline-block;
        padding: 4px 12px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
    }

    /* Warning button */
    .btn-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    /* Warning Banner Important */
    .warning-banner-important {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        animation: pulseWarning 2s ease-in-out infinite;
    }

    .warning-icon {
        font-size: 24px;
        flex-shrink: 0;
    }

    .warning-content {
        color: #92400e;
        font-size: 14px;
        line-height: 1.5;
        font-weight: 500;
    }

    .warning-content strong {
        color: #78350f;
        font-weight: 700;
    }

    @keyframes pulseWarning {

        0%,
        100% {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        50% {
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
    }

    /* Screenshot grid hover effects */
    .screenshot-item:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
    }

    .screenshot-item:hover img {
        transform: scale(1.02) !important;
    }

    /* Hide scrollbar but keep scroll functionality */
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }

    /* Apply to ALL scroll areas - hide scrollbar everywhere */
    .modal-body,
    .results-table-wrapper,
    .screenshots-grid,
    .profile-carousel,
    .modal-sites-column,
    .modal-form-column,
    .modal-tabs-left,
    .tab-content {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .modal-body::-webkit-scrollbar,
    .results-table-wrapper::-webkit-scrollbar,
    .screenshots-grid::-webkit-scrollbar,
    .profile-carousel::-webkit-scrollbar,
    .modal-sites-column::-webkit-scrollbar,
    .modal-form-column::-webkit-scrollbar,
    .modal-tabs-left::-webkit-scrollbar,
    .tab-content::-webkit-scrollbar {
        display: none;
    }

    /* Force grid layout - 3 columns with larger images */
    .screenshots-grid {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 20px !important;
        padding: 20px !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }

    .screenshot-item {
        width: auto !important;
        max-width: 100% !important;
        min-width: 0 !important;
        display: block !important;
    }

    /* Responsive grid adjustments */
    @media (max-width: 768px) {
        .screenshots-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
            gap: 10px !important;
            padding: 15px !important;
        }
    }

    @media (min-width: 1200px) {
        .screenshots-grid {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
        }
    }

    /* FreeLXB Style Input Groups */
    .inputGroup {
        position: relative;
        margin-bottom: 20px;
    }

    .inputGroup input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        transition: all 0.3s ease;
        outline: none;
    }

    .inputGroup input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .inputGroup input:focus+label,
    .inputGroup input:not(:placeholder-shown)+label {
        top: -8px;
        left: 12px;
        font-size: 12px;
        color: #667eea;
        background: white;
        padding: 0 4px;
    }

    .inputGroup label {
        position: absolute;
        top: 50%;
        left: 16px;
        transform: translateY(-50%);
        font-size: 14px;
        color: #6b7280;
        pointer-events: none;
        transition: all 0.3s ease;
        background: transparent;
    }

    .inputGroup .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #6b7280;
        transition: color 0.3s ease;
    }

    .inputGroup .password-toggle:hover {
        color: #667eea;
    }

    .inputGroup .password-toggle svg {
        width: 20px;
        height: 20px;
    }

    /* Gmail hint overlay */
    .inputGroup.has-hint {
        position: relative;
    }

    .hint-overlay {
        position: absolute;
        top: 50%;
        right: 16px;
        transform: translateY(-50%);
        pointer-events: none;
        z-index: 1;
        display: flex;
        align-items: center;
    }

    .hint-text {
        color: #9ca3af;
        font-size: 14px;
    }

    .mirror-text {
        color: transparent;
        font-size: 14px;
    }

    /* Button Container */
    .button-container {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .save-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Site Config Modal Styles */
    #siteConfigModal .modal-content {
        background: white;
        border-radius: 12px;
        overflow: hidden;
    }

    #siteConfigModal .modal-header {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #siteConfigModal .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    #siteConfigModal .modal-footer {
        border-top: 1px solid #e5e7eb;
        background: #f8fafc;
    }

    /* Site Config Table Styles */
    #siteConfigTable {
        background: white;
    }

    #siteConfigTable th {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    #siteConfigTable td {
        vertical-align: middle;
    }

    #siteConfigTable input[type="url"] {
        transition: all 0.2s ease;
    }

    #siteConfigTable input[type="url"]:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    /* Import Modal Styles */
    #importModal .modal-content {
        background: white;
        border-radius: 12px;
    }

    #importModal .modal-header {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #importModal .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    #importModal .modal-body {
        padding: 20px;
    }

    #importModal .modal-footer {
        padding: 20px;
        border-top: 1px solid #e5e7eb;
        background: #f8fafc;
        display: flex;
        justify-content: flex-end;
    }
</style>

<!-- SMS Auto Tool UI -->
<div class="sms-tool-container">

    <!-- Info Banner -->
    <div class="info-banner">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3>üì± SMS Auto Tool</h3>
                <p>T·ª± ƒë·ªông ƒëƒÉng k√Ω, ƒëƒÉng nh·∫≠p, th√™m bank, check khuy·∫øn m√£i cho c√°c trang game nh√† okvip, abcvip</p>
            </div>
            <button onclick="openSiteConfigModal()" class="btn"
                style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; font-size: 14px;">
                ‚öôÔ∏è C·∫•u h√¨nh Sites
            </button>
        </div>
    </div>

    <!-- Results Full Width -->
    <div class="results-full-width">
        <!-- Header with START button -->
        <div class="results-header">
            <h2>üìä K·∫øt Qu·∫£ Automation</h2>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="refreshResults()">
                    üîÑ T·∫£i L·∫°i
                </button>
                <button class="btn btn-warning btn-sm" onclick="deleteSelectedResults()">
                    üóëÔ∏è X√≥a ƒê√£ Ch·ªçn
                </button>
                <button class="btn btn-start" onclick="openFormModal()">
                    <span class="start-icon">‚ñ∂Ô∏è</span>
                    <span class="start-text">START</span>
                </button>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-table-wrapper">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"
                                    style="cursor: pointer; width: 18px; height: 18px;">
                            </th>
                            <th>Profile</th>
                            <th>T√†i Kho·∫£n</th>
                            <th>L·∫ßn Ch·∫°y</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>K·∫øt Qu·∫£</th>
                            <th>Th·ªùi Gian</th>
                            <th>SMS Check</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #a0aec0; padding: 40px;">
                                Ch∆∞a c√≥ k·∫øt qu·∫£. Ch·∫°y automation ƒë·ªÉ xem k·∫øt qu·∫£ ·ªü ƒë√¢y.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls" id="paginationControls">
                <div class="pagination-info">
                    Hi·ªÉn th·ªã <span id="pageStart">0</span>-<span id="pageEnd">0</span> / <span
                        id="totalResults">0</span>
                    k·∫øt qu·∫£
                </div>
                <div class="pagination-buttons">
                    <button class="btn btn-sm" onclick="goToFirstPage()" id="btnFirst">‚èÆÔ∏è ƒê·∫ßu</button>
                    <button class="btn btn-sm" onclick="goToPrevPage()" id="btnPrev">‚óÄÔ∏è Tr∆∞·ªõc</button>
                    <span class="page-indicator">
                        Trang <span id="currentPage">1</span> / <span id="totalPages">1</span>
                    </span>
                    <button class="btn btn-sm" onclick="goToNextPage()" id="btnNext">Sau ‚ñ∂Ô∏è</button>
                    <button class="btn btn-sm" onclick="goToLastPage()" id="btnLast">Cu·ªëi ‚è≠Ô∏è</button>
                </div>
                <div class="pagination-size">
                    <span style="color: #6b7280; font-size: 13px;">
                        üìè 4 k·∫øt qu·∫£ m·ªói trang
                    </span>
                </div>
            </div>
        </div>

        <!-- Screenshots Modal -->
        <div id="screenshotsModal" class="screenshots-modal" style="display: none;">
            <div class="modal-overlay" onclick="closeScreenshotsModal()"></div>
            <div class="modal-content-fullscreen">
                <div class="modal-header">
                    <h3 id="modalTitle">üì∑ K·∫øt Qu·∫£</h3>
                    <button class="modal-close" onclick="closeScreenshotsModal()">√ó</button>
                </div>
                <div class="modal-body" id="modalScreenshotsGrid">
                    <!-- Screenshots will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Account Info Modal -->
        <div id="accountInfoModal" class="screenshots-modal" style="display: none;">
            <div class="modal-overlay" onclick="closeAccountInfoModal()"></div>
            <div class="modal-content-large">
                <div class="modal-header">
                    <h3 id="accountInfoTitle">üìã Th√¥ng Tin T√†i Kho·∫£n</h3>
                    <button class="modal-close" onclick="closeAccountInfoModal()">√ó</button>
                </div>
                <div class="modal-body" id="accountInfoContent" style="padding: 20px;">
                    <!-- Account info will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    <!-- End Results Section -->

    <!-- Form Modal -->
    <div class="form-modal" id="formModal">
        <div class="modal-content-form">
            <!-- Modal Header -->
            <div class="modal-header-form">
                <h2>üì± SMS Auto Tool</h2>
                <button class="modal-close-form" onclick="closeFormModal()">√ó</button>
            </div>

            <!-- Tabs in Modal -->
            <div class="modal-tabs">
                <div class="modal-tabs-left">
                    <div class="modal-tab active" data-tab="okvip" onclick="switchModalTab('okvip')">
                        üé∞ OKVIP
                    </div>
                    <div class="modal-tab" data-tab="abcvip" onclick="switchModalTab('abcvip')">
                        üé≤ ABCVIP
                    </div>
                    <div class="modal-tab" data-tab="kjc" onclick="switchModalTab('kjc')">
                        üÉè KJC
                    </div>
                    <div class="modal-tab" data-tab="78win" onclick="switchModalTab('78win')">
                        üéØ 78WIN
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-warning btn-sm" onclick="clearAllRunningStatuses()"
                        title="Clear t·∫•t c·∫£ tr·∫°ng th√°i running" style="padding: 8px 12px; font-size: 12px;">
                        üîÑ Clear Running
                    </button>
                    <button class="btn-run-action" id="btnRunAction" onclick="runCurrentTabAction()">
                        üöÄ CH·∫†Y
                    </button>
                </div>
            </div>

            <!-- Modal Body - 2 Column Layout -->
            <div class="modal-body-form" id="modalBodyForm">
                <!-- Warning Banner in Form -->
                <div class="warning-banner-important" style="grid-column: 1 / -1; margin-bottom: 15px;">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <strong>Khuy·∫øn ngh·ªã:</strong> N√™n <strong>m·ªü profile c·∫ßn ch·∫°y</strong> trong Hidemium
                        tr∆∞·ªõc khi s·ª≠ d·ª•ng tool ƒë·ªÉ tr√°nh l·ªói k·∫øt n·ªëi. Tool h·ªó tr·ª£ SMS verification t·ª± ƒë·ªông.
                    </div>
                </div>

                <!-- LEFT COLUMN: Sites Selection by Category -->
                <div class="modal-sites-column">
                    <!-- OKVIP Sites -->
                    <div id="okvip-sites" class="sites-category active" style="margin-bottom: 12px;">
                        <h4 style="margin: 0 0 8px 0; color: #4a5568; font-size: 13px; font-weight: 600;">
                            üé∞ OKVIP Sites
                        </h4>
                        <div class="sites-grid">
                            <label class="site-card">
                                <input type="checkbox" class="site-check okvip-check" data-name="SHBET"
                                    data-category="okvip">
                                <div class="site-icon" style="background: #c52828;">SH</div>
                                <div class="site-name">SHBET</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check okvip-check" data-name="F8BET"
                                    data-category="okvip">
                                <div class="site-icon" style="background: #1e40af;">F8</div>
                                <div class="site-name">F8BET</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check okvip-check" data-name="NEW88"
                                    data-category="okvip">
                                <div class="site-icon" style="background: #f97316;">N88</div>
                                <div class="site-name">NEW88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check okvip-check" data-name="HI88"
                                    data-category="okvip">
                                <div class="site-icon" style="background: #db2777;">HI</div>
                                <div class="site-name">HI88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check okvip-check" data-name="789BET"
                                    data-category="okvip">
                                <div class="site-icon" style="background: #16a34a;">789</div>
                                <div class="site-name">789BET</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check okvip-check" data-name="MB66"
                                    data-category="okvip">
                                <div class="site-icon" style="background: #ca8a04;">MB</div>
                                <div class="site-name">MB66</div>
                            </label>
                        </div>
                        <div class="site-actions">
                            <button class="btn btn-sm" onclick="selectCategorySites('okvip')">‚úÖ Ch·ªçn T·∫•t C·∫£</button>
                            <button class="btn btn-sm" onclick="deselectCategorySites('okvip')">‚ùå B·ªè Ch·ªçn</button>
                        </div>
                    </div>

                    <!-- ABCVIP Sites -->
                    <div id="abcvip-sites" class="sites-category" style="margin-bottom: 12px; display: none;">
                        <h4 style="margin: 0 0 8px 0; color: #4a5568; font-size: 13px; font-weight: 600;">
                            üé≤ ABCVIP Sites
                        </h4>
                        <div class="sites-grid">
                            <label class="site-card">
                                <input type="checkbox" class="site-check abcvip-check" data-name="J88"
                                    data-category="abcvip">
                                <div class="site-icon" style="background: #6d28d9;">J88</div>
                                <div class="site-name">J88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check abcvip-check" data-name="U888"
                                    data-category="abcvip">
                                <div class="site-icon" style="background: #0d9488;">U888</div>
                                <div class="site-name">U888</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check abcvip-check" data-name="ABC8"
                                    data-category="abcvip">
                                <div class="site-icon" style="background: #be185d;">ABC</div>
                                <div class="site-name">ABC8</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check abcvip-check" data-name="88CLB"
                                    data-category="abcvip">
                                <div class="site-icon" style="background: #0284c7;">88C</div>
                                <div class="site-name">88CLB</div>
                            </label>
                        </div>
                        <div class="site-actions">
                            <button class="btn btn-sm" onclick="selectCategorySites('abcvip')">‚úÖ Ch·ªçn T·∫•t C·∫£</button>
                            <button class="btn btn-sm" onclick="deselectCategorySites('abcvip')">‚ùå B·ªè Ch·ªçn</button>
                        </div>
                    </div>

                    <!-- KJC Sites -->
                    <div id="kjc-sites" class="sites-category" style="margin-bottom: 12px; display: none;">
                        <h4 style="margin: 0 0 8px 0; color: #4a5568; font-size: 13px; font-weight: 600;">
                            üÉè KJC Sites
                        </h4>
                        <div class="sites-grid">
                            <label class="site-card">
                                <input type="checkbox" class="site-check kjc-check" data-name="QQ88"
                                    data-category="kjc">
                                <div class="site-icon" style="background: #059669;">QQ</div>
                                <div class="site-name">QQ88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check kjc-check" data-name="RR88"
                                    data-category="kjc">
                                <div class="site-icon" style="background: #0891b2;">RR</div>
                                <div class="site-name">RR88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check kjc-check" data-name="XX88"
                                    data-category="kjc">
                                <div class="site-icon" style="background: #7c3aed;">XX</div>
                                <div class="site-name">XX88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check kjc-check" data-name="MM88"
                                    data-category="kjc">
                                <div class="site-icon" style="background: #dc2626;">MM</div>
                                <div class="site-name">MM88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check kjc-check" data-name="X88" data-category="kjc">
                                <div class="site-icon" style="background: #ea580c;">X88</div>
                                <div class="site-name">X88</div>
                            </label>
                        </div>
                        <div class="site-actions">
                            <button class="btn btn-sm" onclick="selectCategorySites('kjc')">‚úÖ Ch·ªçn T·∫•t C·∫£</button>
                            <button class="btn btn-sm" onclick="deselectCategorySites('kjc')">‚ùå B·ªè Ch·ªçn</button>
                        </div>
                    </div>

                    <!-- 78WIN Sites -->
                    <div id="78win-sites" class="sites-category" style="margin-bottom: 12px; display: none;">
                        <h4 style="margin: 0 0 8px 0; color: #4a5568; font-size: 13px; font-weight: 600;">
                            üéØ 78WIN Sites
                        </h4>
                        <div class="sites-grid">
                            <label class="site-card">
                                <input type="checkbox" class="site-check 78win-check" data-name="JUN88"
                                    data-category="78win">
                                <div class="site-icon" style="background: #8b5cf6;">JUN</div>
                                <div class="site-name">JUN88</div>
                            </label>
                            <label class="site-card">
                                <input type="checkbox" class="site-check 78win-check" data-name="78WIN"
                                    data-category="78win">
                                <div class="site-icon" style="background: #0891b2;">78W</div>
                                <div class="site-name">78WIN</div>
                            </label>
                        </div>
                        <div class="site-actions">
                            <button class="btn btn-sm" onclick="selectCategorySites('78win')">‚úÖ Ch·ªçn T·∫•t C·∫£</button>
                            <button class="btn btn-sm" onclick="deselectCategorySites('78win')">‚ùå B·ªè Ch·ªçn</button>
                        </div>
                    </div>


                </div>
                <!-- End LEFT COLUMN -->

                <!-- RIGHT COLUMN: Form Inputs -->
                <div class="modal-form-column">
                    <!-- Tab Content: OKVIP -->
                    <div class="tab-content active" id="tab-okvip">
                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üìã Ch·ªçn Profile</h3>
                                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()"
                                    title="T·∫£i l·∫°i profiles">üîÑ T·∫£i L·∫°i</button>
                            </div>

                            <!-- Profile Carousel -->
                            <div class="profile-carousel-wrapper">
                                <div class="profile-carousel-container">
                                    <button class="carousel-btn carousel-prev"
                                        onclick="scrollProfileCarousel('okvip', -1)">‚Äπ</button>
                                    <div class="profile-carousel" id="okvipProfileCarousel">
                                        <div class="profile-carousel-empty">
                                            <p>Click "T·∫£i L·∫°i" ƒë·ªÉ xem profiles</p>
                                        </div>
                                    </div>
                                    <button class="carousel-btn carousel-next"
                                        onclick="scrollProfileCarousel('okvip', 1)">‚Ä∫</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üë§ Th√¥ng Tin T√†i Kho·∫£n</h3>
                                <button class="btn btn-secondary btn-sm" onclick="randomAllForm()"
                                    title="Random to√†n b·ªô form">üé≤ Random</button>
                            </div>
                            <div class="form-grid">
                                <input type="text" id="okvipUsername" placeholder="T√™n t√†i kho·∫£n">
                                <input type="text" id="okvipFullname" placeholder="H·ªç v√† T√™n (IN HOA)">
                                <input type="password" id="okvipPassword" placeholder="M·∫≠t kh·∫©u">
                                <input type="password" id="okvipWithdrawPassword" placeholder="MK r√∫t ti·ªÅn">
                                <input type="email" id="okvipEmail" placeholder="Email">
                                <input type="text" id="okvipPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                            <div class="form-grid">
                                <select id="okvipBankName">
                                    <option value="">Ch·ªçn ng√¢n h√†ng...</option>
                                </select>
                                <input type="text" id="okvipBankBranch" placeholder="Chi nh√°nh">
                                <input type="text" id="okvipAccountNumber" placeholder="S·ªë t√†i kho·∫£n">
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: ABCVIP -->
                    <div class="tab-content" id="tab-abcvip">
                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üìã Ch·ªçn Profile</h3>
                                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()"
                                    title="T·∫£i l·∫°i profiles">üîÑ T·∫£i L·∫°i</button>
                            </div>

                            <!-- Profile Carousel -->
                            <div class="profile-carousel-wrapper">
                                <div class="profile-carousel-container">
                                    <button class="carousel-btn carousel-prev"
                                        onclick="scrollProfileCarousel('abcvip', -1)">‚Äπ</button>
                                    <div class="profile-carousel" id="abcvipProfileCarousel">
                                        <div class="profile-carousel-empty">
                                            <p>Click "T·∫£i L·∫°i" ƒë·ªÉ xem profiles</p>
                                        </div>
                                    </div>
                                    <button class="carousel-btn carousel-next"
                                        onclick="scrollProfileCarousel('abcvip', 1)">‚Ä∫</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üë§ Th√¥ng Tin T√†i Kho·∫£n</h3>
                                <button class="btn btn-secondary btn-sm" onclick="randomAllForm()"
                                    title="Random to√†n b·ªô form">üé≤ Random</button>
                            </div>
                            <div class="form-grid">
                                <input type="text" id="abcvipUsername" placeholder="T√™n t√†i kho·∫£n">
                                <input type="text" id="abcvipFullname" placeholder="H·ªç v√† T√™n (IN HOA)">
                                <input type="password" id="abcvipPassword" placeholder="M·∫≠t kh·∫©u">
                                <input type="password" id="abcvipWithdrawPassword" placeholder="MK r√∫t ti·ªÅn">
                                <input type="email" id="abcvipEmail" placeholder="Email">
                                <input type="text" id="abcvipPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                            <div class="form-grid">
                                <select id="abcvipBankName">
                                    <option value="">Ch·ªçn ng√¢n h√†ng...</option>
                                </select>
                                <input type="text" id="abcvipBankBranch" placeholder="Chi nh√°nh">
                                <input type="text" id="abcvipAccountNumber" placeholder="S·ªë t√†i kho·∫£n">
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: KJC -->
                    <div class="tab-content" id="tab-kjc">
                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üìã Ch·ªçn Profile</h3>
                                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()"
                                    title="T·∫£i l·∫°i profiles">üîÑ T·∫£i L·∫°i</button>
                            </div>

                            <!-- Profile Carousel -->
                            <div class="profile-carousel-wrapper">
                                <div class="profile-carousel-container">
                                    <button class="carousel-btn carousel-prev"
                                        onclick="scrollProfileCarousel('kjc', -1)">‚Äπ</button>
                                    <div class="profile-carousel" id="kjcProfileCarousel">
                                        <div class="profile-carousel-empty">
                                            <p>Click "T·∫£i L·∫°i" ƒë·ªÉ xem profiles</p>
                                        </div>
                                    </div>
                                    <button class="carousel-btn carousel-next"
                                        onclick="scrollProfileCarousel('kjc', 1)">‚Ä∫</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üë§ Th√¥ng Tin T√†i Kho·∫£n</h3>
                                <button class="btn btn-secondary btn-sm" onclick="randomAllForm()"
                                    title="Random to√†n b·ªô form">üé≤ Random</button>
                            </div>
                            <div class="form-grid">
                                <input type="text" id="kjcUsername" placeholder="T√™n t√†i kho·∫£n">
                                <input type="text" id="kjcFullname" placeholder="H·ªç v√† T√™n (IN HOA)">
                                <input type="password" id="kjcPassword" placeholder="M·∫≠t kh·∫©u">
                                <input type="password" id="kjcWithdrawPassword" placeholder="MK r√∫t ti·ªÅn">
                                <input type="email" id="kjcEmail" placeholder="Email">
                                <input type="text" id="kjcPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                            <div class="form-grid">
                                <select id="kjcBankName">
                                    <option value="">Ch·ªçn ng√¢n h√†ng...</option>
                                </select>
                                <input type="text" id="kjcBankBranch" placeholder="Chi nh√°nh">
                                <input type="text" id="kjcAccountNumber" placeholder="S·ªë t√†i kho·∫£n">
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: 78WIN -->
                    <div class="tab-content" id="tab-78win">
                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üìã Ch·ªçn Profile</h3>
                                <button class="btn btn-secondary btn-sm" onclick="loadProfilesCarousel()"
                                    title="T·∫£i l·∫°i profiles">üîÑ T·∫£i L·∫°i</button>
                            </div>

                            <!-- Profile Carousel -->
                            <div class="profile-carousel-wrapper">
                                <div class="profile-carousel-container">
                                    <button class="carousel-btn carousel-prev"
                                        onclick="scrollProfileCarousel('78win', -1)">‚Äπ</button>
                                    <div class="profile-carousel" id="78winProfileCarousel">
                                        <div class="profile-carousel-empty">
                                            <p>Click "T·∫£i L·∫°i" ƒë·ªÉ xem profiles</p>
                                        </div>
                                    </div>
                                    <button class="carousel-btn carousel-next"
                                        onclick="scrollProfileCarousel('78win', 1)">‚Ä∫</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üë§ Th√¥ng Tin T√†i Kho·∫£n</h3>
                                <button class="btn btn-secondary btn-sm" onclick="randomAllForm()"
                                    title="Random to√†n b·ªô form">üé≤ Random</button>
                            </div>
                            <div class="form-grid">
                                <input type="text" id="78winUsername" placeholder="T√™n t√†i kho·∫£n">
                                <input type="text" id="78winFullname" placeholder="H·ªç v√† T√™n (IN HOA)">
                                <input type="password" id="78winPassword" placeholder="M·∫≠t kh·∫©u">
                                <input type="password" id="78winWithdrawPassword" placeholder="MK r√∫t ti·ªÅn">
                                <input type="email" id="78winEmail" placeholder="Email">
                                <input type="text" id="78winPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                            <div class="form-grid">
                                <select id="78winBankName">
                                    <option value="">Ch·ªçn ng√¢n h√†ng...</option>
                                </select>
                                <input type="text" id="78winBankBranch" placeholder="Chi nh√°nh">
                                <input type="text" id="78winAccountNumber" placeholder="S·ªë t√†i kho·∫£n">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End RIGHT COLUMN -->
            </div>
            <!-- End modal-body-form -->
        </div>
    </div>
</div>

<!-- SMS Tool JavaScript -->
<script>
    // Initialize tool when loaded
    window.initToolUI = function (tool) {
        console.log('üì± Initializing SMS Auto Tool UI...', tool);

        // Clear any existing results data from previous tool
        Object.keys(resultsData).forEach(key => delete resultsData[key]);
        processedResults.clear();

        // Show loading state immediately
        const tbody = document.getElementById('resultsTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #f59e0b; padding: 40px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; border: 2px solid #f59e0b; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            ƒêang t·∫£i k·∫øt qu·∫£ SMS Tool...
                        </div>
                    </td>
                </tr>
            `;
        }

        // Initialize tab switching
        initTabSwitching();

        // Initialize ProfileManager if not available
        if (typeof profileManager === 'undefined') {
            console.log('üîß ProfileManager not found, creating new instance...');
            window.profileManager = new ProfileManager();
        }

        // Load banks
        loadBanksForTool();

        // Load profiles for carousel
        loadProfilesCarousel();

        // Auto-sync running profiles every 5 seconds
        setInterval(async () => {
            await syncRunningProfilesFromServer();
            // Only reload carousel if there were changes
            const currentRunningCount = profileManager.runningProfiles.size;
            if (window.lastRunningCount !== currentRunningCount) {
                window.lastRunningCount = currentRunningCount;
                loadProfilesCarousel();
            }
        }, 5000);

        // Load results from server
        loadResultsFromServer();



        console.log('‚úÖ SMS Auto Tool initialized');
    };

    // Tab switching
    function initTabSwitching() {
        console.log('‚úÖ Tab switching initialized for modal');
    }

    // Switch modal tabs (switches both site categories and form tabs)
    function switchModalTab(categoryName) {
        // Remove active class from all tabs
        document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));

        // Remove active class from all site categories
        document.querySelectorAll('.sites-category').forEach(category => {
            category.classList.remove('active');
            category.style.display = 'none';
        });

        // Remove active class from all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Add active class to selected tab
        document.querySelector(`[data-tab="${categoryName}"]`).classList.add('active');

        // Show selected category sites
        const categoryElement = document.getElementById(`${categoryName}-sites`);
        if (categoryElement) {
            categoryElement.classList.add('active');
            categoryElement.style.display = 'block';
        }

        // Show selected tab content
        const tabContent = document.getElementById(`tab-${categoryName}`);
        if (tabContent) {
            tabContent.classList.add('active');
        }

        console.log('Switched to category:', categoryName);
    }

    // Site selection functions by category
    function selectCategorySites(category) {
        document.querySelectorAll(`.${category}-check`).forEach(cb => cb.checked = true);
    }

    function deselectCategorySites(category) {
        document.querySelectorAll(`.${category}-check`).forEach(cb => cb.checked = false);
    }

    // Get selected sites by category
    function getSelectedSites() {
        const sites = [];
        document.querySelectorAll('.site-check:checked').forEach(checkbox => {
            const name = checkbox.getAttribute('data-name');
            const category = checkbox.getAttribute('data-category');
            sites.push({ name, category });
        });
        return sites;
    }

    // Get selected sites for current active category
    function getSelectedSitesForActiveCategory() {
        const activeTab = document.querySelector('.modal-tab.active');
        if (!activeTab) return [];

        const category = activeTab.getAttribute('data-tab');
        const sites = [];

        document.querySelectorAll(`.${category}-check:checked`).forEach(checkbox => {
            const name = checkbox.getAttribute('data-name');
            sites.push({ name, category });
        });

        return sites;
    }

    // Load banks
    async function loadBanksForTool() {
        const selects = ['okvipBankName', 'abcvipBankName', 'kjcBankName', '78winBankName'];
        try {
            const response = await fetch('https://api.vietqr.io/v2/banks');
            const data = await response.json();
            if (data.code === '00' && data.data) {
                const sortedBanks = data.data.sort((a, b) => a.shortName.localeCompare(b.shortName));
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Ch·ªçn ng√¢n h√†ng...</option>';
                        sortedBanks.forEach(bank => {
                            const option = document.createElement('option');
                            option.value = bank.shortName;
                            option.textContent = `${bank.shortName} - ${bank.name}`;
                            select.appendChild(option);
                        });
                    }
                });
                console.log(`‚úÖ Loaded ${sortedBanks.length} banks`);
            }
        } catch (error) {
            console.error('‚ùå Failed to load banks:', error);
        }
    }

    // Random form data for current active tab
    function randomAllForm() {
        // Get current active tab
        const activeTab = document.querySelector('.modal-tab.active');
        if (!activeTab) return;

        const tabName = activeTab.getAttribute('data-tab');

        // Random username
        const prefixes = ['SMS', 'VIP', 'Game', 'Auto', 'Pro', 'King', 'Star', 'Lucky'];
        const suffixes = ['2024', '88', '99', '777', '888', '999'];
        const username = prefixes[Math.floor(Math.random() * prefixes.length)] +
            suffixes[Math.floor(Math.random() * suffixes.length)];

        // Random fullname (Vietnamese names)
        const firstNames = ['NGUYEN', 'TRAN', 'LE', 'PHAM', 'HOANG', 'PHAN', 'VU', 'VO', 'DANG', 'BUI'];
        const middleNames = ['VAN', 'THI', 'DUC', 'MINH', 'HOANG', 'QUANG', 'ANH', 'THANH'];
        const lastNames = ['AN', 'BINH', 'CUONG', 'DUNG', 'HAI', 'HUNG', 'KHANH', 'LINH', 'MINH', 'NAM'];

        const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
        const middleName = middleNames[Math.floor(Math.random() * middleNames.length)];
        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
        const fullname = `${firstName} ${middleName} ${lastName}`;

        // Random password (8-12 characters, guaranteed mix of letters and numbers)
        const passwordLength = 8 + Math.floor(Math.random() * 5); // 8-12 chars
        const letters = 'abcdefghijklmnopqrstuvwxyz';
        const numbers = '0123456789';

        let password = '';
        // Ensure at least 2 letters and 2 numbers
        password += letters[Math.floor(Math.random() * letters.length)];
        password += letters[Math.floor(Math.random() * letters.length)];
        password += numbers[Math.floor(Math.random() * numbers.length)];
        password += numbers[Math.floor(Math.random() * numbers.length)];

        // Fill remaining positions with random mix
        const allChars = letters + numbers;
        for (let i = 4; i < passwordLength; i++) {
            password += allChars[Math.floor(Math.random() * allChars.length)];
        }

        // Shuffle the password to avoid predictable pattern
        password = password.split('').sort(() => Math.random() - 0.5).join('');

        // Random withdraw password (6 digits)
        const withdrawPassword = Math.floor(100000 + Math.random() * 900000).toString();

        // Random email
        const emailPrefixes = ['sms', 'vip', 'game', 'auto', 'pro', 'king', 'star', 'lucky'];
        const emailSuffix = Math.floor(1000 + Math.random() * 9000);
        const email = emailPrefixes[Math.floor(Math.random() * emailPrefixes.length)] + emailSuffix + '@gmail.com';

        // Random phone
        const phoneNumber = '0' + Math.floor(100000000 + Math.random() * 900000000);

        // Fill form fields for current tab
        const usernameField = document.getElementById(`${tabName}Username`);
        const fullnameField = document.getElementById(`${tabName}Fullname`);
        const passwordField = document.getElementById(`${tabName}Password`);
        const withdrawPasswordField = document.getElementById(`${tabName}WithdrawPassword`);
        const emailField = document.getElementById(`${tabName}Email`);
        const phoneField = document.getElementById(`${tabName}Phone`);
        const bankNameField = document.getElementById(`${tabName}BankName`);
        const bankBranchField = document.getElementById(`${tabName}BankBranch`);
        const accountNumberField = document.getElementById(`${tabName}AccountNumber`);

        if (usernameField) usernameField.value = username;
        if (fullnameField) fullnameField.value = fullname;
        if (passwordField) passwordField.value = password;
        if (withdrawPasswordField) withdrawPasswordField.value = withdrawPassword;
        if (emailField) emailField.value = email;
        if (phoneField) phoneField.value = phoneNumber;

        // Random bank
        if (bankNameField && bankNameField.options.length > 1) {
            const randomIndex = 1 + Math.floor(Math.random() * (bankNameField.options.length - 1));
            bankNameField.selectedIndex = randomIndex;
        }

        // Random bank branch
        const branches = ['HO CHI MINH', 'HA NOI', 'DA NANG', 'CAN THO'];
        if (bankBranchField) {
            bankBranchField.value = branches[Math.floor(Math.random() * branches.length)];
        }

        // Random account number
        const accountNumber = Math.floor(1000000000 + Math.random() * 9000000000).toString();
        if (accountNumberField) {
            accountNumberField.value = accountNumber;
        }

        showToast('success', 'Random th√†nh c√¥ng', `ƒê√£ random th√¥ng tin cho tab ${tabName.toUpperCase()}`);
    }

    // FreeLXB Style Functions
    function initFreeLXBStyle() {
        // Password toggle functionality
        document.querySelectorAll('.password-toggle').forEach(button => {
            button.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                const isPassword = input.type === 'password';

                input.type = isPassword ? 'text' : 'password';

                // Toggle icon (simplified)
                const eyeIcon = this.querySelector('.icon-eye');
                if (eyeIcon) {
                    eyeIcon.style.display = isPassword ? 'none' : 'block';
                }
            });
        });

        // Gmail hint functionality
        const gmailInput = document.getElementById('f_gmail');
        if (gmailInput) {
            gmailInput.addEventListener('input', updateGmailHint);
        }
    }

    function updateGmailHint() {
        const gmailInput = document.getElementById('f_gmail');
        const mirrorText = document.querySelector('#gmailHint .mirror-text');

        if (gmailInput && mirrorText) {
            mirrorText.textContent = gmailInput.value;
        }
    }

    // Profile carousel functions (integrated with dashboard)
    let allProfilesData = [];

    function displayProfilesInCarousel(tabPrefix, profiles) {
        const carousel = document.getElementById(`${tabPrefix}ProfileCarousel`);
        if (!carousel) return;

        carousel.innerHTML = '';

        if (profiles.length === 0) {
            carousel.innerHTML = '<div class="profile-carousel-empty"><p>Ch∆∞a c√≥ profiles</p></div>';
            return;
        }

        profiles.forEach(profile => {
            const isRunning = profileManager.isRunning(profile.uuid);
            const isSelected = profileManager.selectedProfileId === profile.uuid;

            // Extract proxy IP
            let proxyIP = 'No proxy';
            if (profile.proxy && typeof profile.proxy === 'object' && profile.proxy.ip) {
                proxyIP = profile.proxy.ip;
            } else if (profile.proxy && typeof profile.proxy === 'string') {
                const parts = profile.proxy.split('|');
                if (parts.length >= 2 && parts[1]) {
                    proxyIP = parts[1];
                }
            }

            // OS & Browser icons
            const osIcons = { 'win': 'ü™ü', 'windows': 'ü™ü', 'mac': 'üçé', 'macos': 'üçé', 'linux': 'üêß', 'android': 'ü§ñ', 'ios': 'üì±' };
            const browserIcons = { 'chrome': 'üåê', 'firefox': 'ü¶ä', 'edge': 'üî∑', 'opera': 'üî¥', 'brave': 'ü¶Å', 'safari': 'üß≠' };
            const osIcon = osIcons[profile.os?.toLowerCase()] || 'üíª';
            const browserIcon = browserIcons[profile.browser?.toLowerCase()] || 'üåê';

            const card = document.createElement('div');
            card.className = `profile-carousel-card ${isSelected ? 'selected' : ''} ${isRunning ? 'running' : ''}`;
            card.setAttribute('data-uuid', profile.uuid);
            card.setAttribute('data-tab', tabPrefix);

            card.innerHTML = `
                <div class="profile-card-header">
                    <div class="profile-avatar">
                        ${profile.name ? profile.name.substring(0, 2).toUpperCase() : 'PR'}
                    </div>
                    ${isRunning ? '<span class="running-badge">‚óè Running</span>' : ''}
                    ${isSelected ? '<span class="selected-badge">‚úì Selected</span>' : ''}
                </div>
                <div class="profile-card-body">
                    <div class="profile-card-name">${profile.name || 'Unnamed Profile'}</div>
                    <div class="profile-card-info">
                        <div class="info-item">
                            <span class="info-icon">${osIcon}</span>
                            <span class="info-text">${profile.os || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">${browserIcon}</span>
                            <span class="info-text">${profile.browser || 'chrome'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üåç</span>
                            <span class="info-text">${proxyIP}</span>
                        </div>
                    </div>
                </div>
                <div class="profile-card-footer">
                    <div class="profile-status-text ${isRunning ? 'running' : (isSelected ? 'selected' : 'available')}">
                        ${isRunning ? 'üî¥ ƒêang Ch·∫°y' : (isSelected ? '‚úì ƒê√£ Ch·ªçn' : 'üëÜ Click ƒë·ªÉ ch·ªçn')}
                    </div>
                </div>
            `;

            // Add click event listener to entire card
            if (!isRunning) {
                card.style.cursor = 'pointer';
                card.addEventListener('click', () => {
                    selectProfileFromCarousel(tabPrefix, profile.uuid);
                });
            } else {
                card.style.cursor = 'not-allowed';
                card.addEventListener('click', () => {
                    showToast('warning', 'Profile ƒëang ch·∫°y', 'Kh√¥ng th·ªÉ ch·ªçn profile ƒëang ch·∫°y automation');
                });
            }

            carousel.appendChild(card);
        });
    }

    // Sync running profiles from server to frontend
    async function syncRunningProfilesFromServer() {
        try {
            console.log('üîÑ Syncing running profiles from server...');

            const response = await fetch('/api/profiles/running');
            const data = await response.json();

            if (data.success) {
                // Clear frontend running profiles
                profileManager.runningProfiles.clear();

                // Add server running profiles to frontend
                data.runningProfiles.forEach(profile => {
                    profileManager.runningProfiles.add(profile.profileId);
                });

                // Save to localStorage
                profileManager.saveRunningProfiles();

                console.log(`‚úÖ Synced ${data.runningProfiles.length} running profiles from server`);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Failed to sync running profiles from server:', error);
        }
    }

    // Load profiles for all carousels
    async function loadProfilesCarousel() {
        try {
            console.log('üîÑ Loading profiles for SMS tool...');

            if (typeof profileManager === 'undefined') {
                console.error('‚ùå ProfileManager not available');
                showToast('error', 'L·ªói ProfileManager', 'ProfileManager ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
                return;
            }

            // Sync running profiles from server
            await syncRunningProfilesFromServer();

            const result = await profileManager.loadAll();
            console.log('üìä ProfileManager result:', result);

            if (result.success && result.profiles) {
                allProfilesData = result.profiles;

                // Update all carousels
                const tabs = ['okvip', 'abcvip', 'kjc', '78win'];
                tabs.forEach(tab => {
                    displayProfilesInCarousel(tab, allProfilesData);
                });

                showToast('success', 'ƒê√£ t·∫£i l·∫°i', `${allProfilesData.length} profiles`);
                console.log(`‚úÖ Loaded ${allProfilesData.length} profiles into all carousels`);
            } else {
                showToast('error', 'L·ªói t·∫£i profiles', result.error || 'Unknown error');
                console.error('‚ùå Failed to load profiles:', result);
            }
        } catch (error) {
            console.error('üí• Error in loadProfilesCarousel:', error);
            showToast('error', 'L·ªói t·∫£i profiles', error.message);
        }
    }

    function selectProfileFromCarousel(tabPrefix, uuid) {
        // Check if profile is running
        if (profileManager.isRunning(uuid)) {
            showToast('warning', 'Profile ƒëang ch·∫°y', 'Kh√¥ng th·ªÉ ch·ªçn profile ƒëang ch·∫°y automation');
            return;
        }

        // Select in manager
        profileManager.select(uuid);

        // Update carousel to show selected state
        const carousel = document.getElementById(`${tabPrefix}ProfileCarousel`);
        if (carousel) {
            // Remove selected class from all cards and update status text
            carousel.querySelectorAll('.profile-carousel-card').forEach(card => {
                card.classList.remove('selected');
                const statusText = card.querySelector('.profile-status-text');
                const selectedBadge = card.querySelector('.selected-badge');

                if (statusText) {
                    const cardUuid = card.getAttribute('data-uuid');
                    const isRunning = profileManager.isRunning(cardUuid);

                    if (isRunning) {
                        statusText.textContent = 'üî¥ ƒêang Ch·∫°y';
                        statusText.className = 'profile-status-text running';
                    } else {
                        statusText.textContent = 'üëÜ Click ƒë·ªÉ ch·ªçn';
                        statusText.className = 'profile-status-text available';
                    }
                }

                // Remove selected badge
                if (selectedBadge) {
                    selectedBadge.remove();
                }
            });

            // Add selected class to clicked card and update its status
            const selectedCard = carousel.querySelector(`[data-uuid="${uuid}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                const statusText = selectedCard.querySelector('.profile-status-text');
                if (statusText) {
                    statusText.textContent = '‚úì ƒê√£ Ch·ªçn';
                    statusText.className = 'profile-status-text selected';
                }

                // Add selected badge
                const header = selectedCard.querySelector('.profile-card-header');
                if (header && !header.querySelector('.selected-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'selected-badge';
                    badge.textContent = '‚úì Selected';
                    header.appendChild(badge);
                }
            }
        }

        const profile = profileManager.getSelected();
        showToast('success', 'Profile ƒë√£ ch·ªçn', profile?.name || 'Unknown');
    }

    function scrollProfileCarousel(tabPrefix, direction) {
        const carousel = document.getElementById(`${tabPrefix}ProfileCarousel`);
        if (!carousel) return;

        const cardWidth = 350;
        const scrollAmount = cardWidth * direction;
        carousel.scrollBy({
            left: scrollAmount,
            behavior: 'smooth'
        });
    }

    // Run action based on current active category
    function runCurrentTabAction() {
        // Check if profile is selected
        if (!profileManager.selectedProfileId) {
            showToast('warning', 'Ch∆∞a ch·ªçn profile', 'Vui l√≤ng ch·ªçn profile t·ª´ carousel');
            return;
        }

        // Sync profile status from Hidemium before running
        console.log('üîÑ Syncing profile status from Hidemium...');
        profileManager.loadAll().then(() => {
            loadProfilesCarousel();
        });

        // Check if profile is already running
        if (profileManager.isRunning(profileManager.selectedProfileId)) {
            showToast('warning', 'Profile ƒëang ch·∫°y', 'Profile n√†y ƒëang ch·∫°y automation, vui l√≤ng ch·ªçn profile kh√°c');
            return;
        }

        const activeTab = document.querySelector('.modal-tab.active');
        if (!activeTab) return;

        const categoryName = activeTab.getAttribute('data-tab');
        const selectedSites = getSelectedSitesForActiveCategory();

        console.log('Running action for category:', categoryName);
        console.log('Selected sites:', selectedSites);

        // Validate selectedSites
        if (!selectedSites || !Array.isArray(selectedSites) || selectedSites.length === 0) {
            showToast('warning', 'Ch∆∞a ch·ªçn trang', `Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 trang trong danh m·ª•c ${categoryName.toUpperCase()}`);
            return;
        }

        // Get form data from current active tab
        const formData = {
            profileId: profileManager.selectedProfileId,
            category: categoryName,
            sites: selectedSites,
            username: document.getElementById(`${categoryName}Username`).value,
            fullname: document.getElementById(`${categoryName}Fullname`).value,
            password: document.getElementById(`${categoryName}Password`).value,
            withdrawPassword: document.getElementById(`${categoryName}WithdrawPassword`).value,
            email: document.getElementById(`${categoryName}Email`).value,
            phone: document.getElementById(`${categoryName}Phone`).value,
            bankName: document.getElementById(`${categoryName}BankName`).value,
            bankBranch: document.getElementById(`${categoryName}BankBranch`).value,
            accountNumber: document.getElementById(`${categoryName}AccountNumber`).value
        };

        // Validate required fields
        if (!formData.username) {
            showToast('warning', 'Thi·∫øu th√¥ng tin', 'Vui l√≤ng nh·∫≠p t√™n t√†i kho·∫£n');
            return;
        }

        const selectedProfile = profileManager.getSelected();
        showToast('info', 'Ch·∫°y SMS Tool', `ƒêang ch·∫°y ${categoryName.toUpperCase()} tr√™n ${selectedSites.length} trang v·ªõi profile: ${selectedProfile?.name || 'Unknown'}`);

        // Call SMS automation API
        runSMSAutomation(formData);
    }

    // Run SMS Automation
    async function runSMSAutomation(formData) {
        console.log('üöÄ Starting SMS automation...', formData);

        try {
            // Validate API key (required for captcha solving during registration)
            const apiKey = apiKeyManager.get();
            if (!apiKey || apiKey.trim() === '') {
                showToast('error', 'Thi·∫øu API Key', '‚ö†Ô∏è Vui l√≤ng th√™m Captcha API Key ·ªü sidebar tr∆∞·ªõc khi ch·∫°y SMS Tool!\n\nüìù L·∫•y API key t·∫°i: autocaptcha.pro', 8000);
                return;
            }

            // Mark profile as running
            profileManager.runningProfiles.add(formData.profileId);
            profileManager.saveRunningProfiles();

            // Update UI to show running state
            loadProfilesCarousel();

            // Prepare automation config - CENTRALIZED CONFIG (C√°ch 1)
            // Ch·ªâ pass site name v√† category, URLs s·∫Ω ƒë∆∞·ª£c l·∫•y t·ª´ optimized-automation.js
            const config = {
                category: formData.category,
                username: formData.username,
                password: formData.password,
                withdrawPassword: formData.withdrawPassword,
                fullname: formData.fullname,
                email: formData.email,
                phone: formData.phone,
                bankName: formData.bankName,
                bankBranch: formData.bankBranch,
                accountNumber: formData.accountNumber,
                apiKey: apiKeyManager.get(), // Load API key t·ª´ core (gi·ªëng nohu tool)
                sites: (formData.sites || []).map(site => {
                    // CENTRALIZED CONFIG: Ch·ªâ pass name v√† category
                    // URLs s·∫Ω ƒë∆∞·ª£c l·∫•y t·ª´ optimized-automation.js site configs
                    return {
                        name: site.name,
                        category: site.category
                    };
                })
            };

            // Create automation request like nohu-tool
            const automationConfig = {
                toolId: 'tool-sms',
                profileId: formData.profileId,
                config: config
            };

            console.log('üì§ Sending automation config:', automationConfig);

            // Call automation API
            const response = await fetch('/api/automation/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(automationConfig)
            });

            const result = await response.json();

            if (result.success) {
                showToast('success', 'SMS Tool Started', result.message);
                console.log('‚úÖ SMS automation started successfully');

                // Close modal
                closeFormModal();

                // Refresh results after a delay
                setTimeout(() => {
                    loadResultsFromServer();
                }, 5000);
            } else {
                throw new Error(result.error || 'Unknown error');
            }

        } catch (error) {
            console.error('üí• SMS automation error:', error);
            showToast('error', 'SMS Tool Error', error.message);

            // Mark profile as not running
            profileManager.runningProfiles.delete(formData.profileId);
            profileManager.saveRunningProfiles();
            loadProfilesCarousel();
        }
    }

    // CENTRALIZED CONFIG: Site data ƒë∆∞·ª£c l·∫•y t·ª´ optimized-automation.js
    // Function getSiteDataFromCheckbox ƒë√£ ƒë∆∞·ª£c x√≥a v√¨ kh√¥ng c·∫ßn thi·∫øt

    // Modal functions
    function openFormModal() {
        document.getElementById('formModal').style.display = 'flex';
    }

    function closeFormModal() {
        document.getElementById('formModal').style.display = 'none';
    }

    // Results functions (placeholder)
    function refreshResults() {
        showToast('info', 'T·∫£i l·∫°i', 'ƒêang t·∫£i l·∫°i k·∫øt qu·∫£ SMS Tool...');
        loadResultsFromServer();
    }

    function deleteSelectedResults() {
        showToast('info', 'X√≥a', 'Ch·ª©c nƒÉng x√≥a ch∆∞a ƒë∆∞·ª£c implement');
    }

    // Load results from server API (filtered for SMS tool only)
    async function loadResultsFromServer() {
        try {
            // Use relative URL with tool filter
            const response = await fetch('/api/automation/results?tool=tool-sms');
            const data = await response.json();

            console.log('üîç SMS Tool API Response:', data); // Debug log
            console.log('üåê API URL called:', '/api/automation/results?tool=tool-sms'); // Debug URL

            if (data.success && data.results) {
                console.log(`üìä Raw results count: ${data.results.length}`);
                console.log('üìã Sample results:', data.results.slice(0, 3)); // Show first 3 results

                // Check toolId of results
                const toolIds = [...new Set(data.results.map(r => r.toolId))];
                console.log('üè∑Ô∏è Tool IDs in results:', toolIds);

                // Clear processed results tracking to allow re-processing
                processedResults.clear();

                // Clear and rebuild resultsData from server
                Object.keys(resultsData).forEach(key => delete resultsData[key]);

                // Set flag to indicate this is an auto-refresh
                window.isAutoRefreshInProgress = true;

                // Add all results
                data.results.forEach(result => {
                    console.log('‚ûï Adding result:', result.toolId, result.siteName);
                    addResultToTable(result);
                });

                // Clear the auto-refresh flag
                window.isAutoRefreshInProgress = false;

                console.log(`‚úÖ Loaded ${data.results.length} SMS tool results`);
                console.log('üìä Final resultsData:', Object.keys(resultsData));
            } else {
                console.warn('‚ö†Ô∏è No SMS tool results found');
                // Show empty table
                refreshResultsTable();
            }

            // If no results specifically for tool-sms, show appropriate message
            if (data.success && data.results.length === 0) {
                console.log('üì≠ No SMS tool data found - this is expected if SMS tool hasn\'t been run yet');
            }
        } catch (error) {
            console.error('‚ùå Error loading SMS tool results:', error);
            // Show empty table on error
            refreshResultsTable();
        }
    }

    // Pagination functions (placeholder)
    function goToFirstPage() { console.log('Go to first page'); }
    function goToPrevPage() { console.log('Go to prev page'); }
    function goToNextPage() { console.log('Go to next page'); }
    function goToLastPage() { console.log('Go to last page'); }

    // Clear running statuses
    function clearAllRunningStatuses() {
        showToast('info', 'Clear Running', 'ƒê√£ clear t·∫•t c·∫£ tr·∫°ng th√°i running');
    }

    // Close modal on background click
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('formModal');
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeFormModal();
                }
            });
        }
    });

    // ============================================
    // DRAG TO SCROLL
    // ============================================

    function enableDragScroll(carousel) {
        let isDown = false;
        let startX;
        let scrollLeft;

        carousel.addEventListener('mousedown', (e) => {
            // Don't drag if clicking on button
            if (e.target.closest('.btn-select-profile')) return;

            isDown = true;
            carousel.style.cursor = 'grabbing';
            carousel.style.userSelect = 'none';
            startX = e.pageX - carousel.offsetLeft;
            scrollLeft = carousel.scrollLeft;
        });

        carousel.addEventListener('mouseleave', () => {
            isDown = false;
            carousel.style.cursor = 'grab';
        });

        carousel.addEventListener('mouseup', () => {
            isDown = false;
            carousel.style.cursor = 'grab';
        });

        carousel.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - carousel.offsetLeft;
            const walk = (x - startX) * 2; // Scroll speed
            carousel.scrollLeft = scrollLeft - walk;
        });

        // Set initial cursor
        carousel.style.cursor = 'grab';
    }

    // Update card states on scroll and enable drag
    document.addEventListener('DOMContentLoaded', () => {
        const carousel = document.getElementById('mainProfileCarousel');
        if (carousel) {
            // Enable drag to scroll
            enableDragScroll(carousel);
        }
    });

    // ============================================
    // RESULTS TABLE MANAGEMENT - SMS TOOL
    // ============================================

    // Store results grouped by username
    const resultsData = {};

    // Track processed result IDs to avoid duplicates
    const processedResults = new Set();

    // Pagination state
    let currentPage = 1;
    let pageSize = 4; // Fixed: 4 rows per page
    let totalResults = 0;
    let allResultsKeys = []; // Store all sorted keys

    // Add result to table (grouped by username + sessionId)
    function addResultToTable(result) {
        // Create unique ID for this result
        const resultId = `${result.profileName}_${result.username}_${result.sessionId}_${result.siteName}_${result.timestamp}`;

        // Skip if already processed
        if (processedResults.has(resultId)) {
            return;
        }

        processedResults.add(resultId);
        const username = result.username || 'N/A';
        const sessionId = result.sessionId || 'default';
        const key = `${username}_${sessionId}`; // Group by username + sessionId

        // Initialize group if not exists
        if (!resultsData[key]) {
            resultsData[key] = {
                profileName: result.profileName,
                username: username,
                sessionId: sessionId,
                runNumber: result.runNumber || null,
                hasAccountInfo: result.hasAccountInfo !== false,
                sites: [],
                screenshots: [],
                checkTimes: [],
                firstTimestamp: result.timestamp || Date.now(),
                lastTimestamp: result.timestamp || Date.now()
            };
        }

        // Add site result
        resultsData[key].sites.push({
            name: result.siteName,
            status: result.status,
            screenshot: result.screenshot,
            timestamp: result.timestamp || Date.now()
        });

        // Add screenshot if exists
        if (result.screenshot) {
            resultsData[key].screenshots.push({
                site: result.siteName,
                url: result.screenshot,
                timestamp: result.timestamp || Date.now()
            });
        }

        // Track check times
        const checkDate = new Date(result.timestamp || Date.now()).toDateString();
        if (!resultsData[key].checkTimes.includes(checkDate)) {
            resultsData[key].checkTimes.push(checkDate);
        }

        // Update last timestamp
        resultsData[key].lastTimestamp = result.timestamp || Date.now();

        // Refresh table display
        refreshResultsTable();
    }

    // Refresh table display
    function refreshResultsTable() {
        const tbody = document.getElementById('resultsTableBody');
        if (!tbody) return;

        // Clear table
        tbody.innerHTML = '';

        // Check if empty
        if (Object.keys(resultsData).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #a0aec0; padding: 40px;">
                        Ch∆∞a c√≥ k·∫øt qu·∫£ SMS Tool. Ch·∫°y automation ƒë·ªÉ xem k·∫øt qu·∫£ ·ªü ƒë√¢y.
                    </td>
                </tr>
            `;
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }

        // Sort by last timestamp (newest first)
        const sortedKeys = Object.keys(resultsData).sort((a, b) => {
            return resultsData[b].lastTimestamp - resultsData[a].lastTimestamp;
        });

        // Store for pagination
        allResultsKeys = sortedKeys;
        totalResults = sortedKeys.length;

        // Calculate total pages
        const totalPages = Math.ceil(totalResults / pageSize);

        // Ensure currentPage is within valid range
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        if (currentPage < 1) {
            currentPage = 1;
        }

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalResults);

        // Get current page items
        const pageKeys = sortedKeys.slice(startIndex, endIndex);

        // Update pagination UI
        updatePaginationUI(startIndex, endIndex, totalPages);

        // Display each group (only current page)
        pageKeys.forEach(key => {
            const group = resultsData[key];
            const row = document.createElement('tr');

            // Count statuses
            const successCount = group.sites.filter(s => s.status === 'success').length;
            const errorCount = group.sites.filter(s => s.status === 'error').length;

            // Status summary
            let statusHtml = '';
            if (successCount > 0) statusHtml += `<span class="status-badge success">‚úÖ ${successCount}</span> `;
            if (errorCount > 0) statusHtml += `<span class="status-badge error">‚ùå ${errorCount}</span>`;

            // Screenshots preview
            const screenshotCount = group.screenshots.length;
            let screenshotHtml = '<span style="color: #a0aec0;">Ch∆∞a c√≥</span>';
            if (screenshotCount > 0) {
                screenshotHtml = `
                    <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                        <div class="screenshot-preview" onclick="openScreenshotsModal('${key}')" title="Xem screenshots" style="position: relative;">
                            <span class="screenshot-preview-icon">üì∑</span>
                            <span style="position: absolute; top: -4px; right: -4px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: 700; min-width: 18px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${screenshotCount}</span>
                        </div>
                    </div>
                `;
            }

            // Format time
            const time = new Date(group.lastTimestamp).toLocaleString('vi-VN');

            // Run number
            const runNumber = group.runNumber || 1;

            row.innerHTML = `
                <td style="text-align: center;">
                    <input type="checkbox" class="row-checkbox" data-key="${key}" 
                           style="cursor: pointer; width: 18px; height: 18px;">
                </td>
                <td>${group.profileName || 'Unknown'}</td>
                <td><strong>${group.username}</strong></td>
                <td><span class="check-times-badge">L·∫ßn ${runNumber}</span></td>
                <td>${statusHtml}</td>
                <td>${screenshotHtml}</td>
                <td>${time}</td>
                <td style="text-align: center;">
                    <button class="btn btn-sm" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600;">
                        üì± SMS Check
                    </button>
                </td>
            `;

            tbody.appendChild(row);
        });

        // Show pagination
        document.getElementById('paginationControls').style.display = 'flex';
    }

    // Update pagination UI
    function updatePaginationUI(startIndex, endIndex, totalPages) {
        document.getElementById('pageStart').textContent = startIndex + 1;
        document.getElementById('pageEnd').textContent = endIndex;
        document.getElementById('totalResults').textContent = totalResults;
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;

        // Update button states
        document.getElementById('btnFirst').disabled = currentPage === 1;
        document.getElementById('btnPrev').disabled = currentPage === 1;
        document.getElementById('btnNext').disabled = currentPage === totalPages;
        document.getElementById('btnLast').disabled = currentPage === totalPages;
    }

    // Pagination functions
    function goToFirstPage() {
        currentPage = 1;
        refreshResultsTable();
    }

    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            refreshResultsTable();
        }
    }

    function goToNextPage() {
        const totalPages = Math.ceil(totalResults / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            refreshResultsTable();
        }
    }

    function goToLastPage() {
        const totalPages = Math.ceil(totalResults / pageSize);
        currentPage = totalPages;
        refreshResultsTable();
    }

    // Open screenshots modal
    function openScreenshotsModal(key) {
        const group = resultsData[key];
        if (!group || group.screenshots.length === 0) return;

        const modal = document.getElementById('screenshotsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalGrid = document.getElementById('modalScreenshotsGrid');

        modalTitle.textContent = `üì∑ Screenshots - ${group.username} (${group.screenshots.length} ·∫£nh)`;

        modalGrid.innerHTML = '';

        group.screenshots.forEach((screenshot, index) => {
            const item = document.createElement('div');
            item.className = 'screenshot-item';
            item.innerHTML = `
                <img src="${screenshot.url}" alt="Screenshot ${index + 1}" loading="lazy">
                <div class="screenshot-overlay">
                    <div class="screenshot-info">
                        <div class="screenshot-site">${screenshot.site}</div>
                        <div class="screenshot-time">${new Date(screenshot.timestamp).toLocaleString('vi-VN')}</div>
                    </div>
                </div>
            `;
            modalGrid.appendChild(item);
        });

        modal.style.display = 'flex';
    }

    function closeScreenshotsModal() {
        document.getElementById('screenshotsModal').style.display = 'none';
    }

    // Toggle select all checkboxes
    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    // ============================================
    // AUTO-REFRESH FUNCTION FOR TOOL SWITCHING
    // ============================================

    // Global function to refresh all data when tool is loaded
    window.refreshAllData = function () {
        // Check if this is the correct tool to prevent cross-contamination
        if (window.currentTool && window.currentTool.id !== 'tool-sms') {
            console.log('‚ö†Ô∏è Skipping SMS refresh - different tool active:', window.currentTool.id);
            return;
        }

        console.log('üîÑ Refreshing all data for SMS Tool...');

        // Set tool identifier for API calls
        window.currentToolId = 'tool-sms';

        // Refresh results
        if (window.refreshResults) {
            window.refreshResults();
        }

        // Refresh profiles carousel
        if (typeof loadProfilesCarousel === 'function') {
            loadProfilesCarousel();
        }

        // Refresh automation statuses
        if (typeof loadAutomationStatuses === 'function') {
            loadAutomationStatuses();
        }

        console.log('‚úÖ All data refreshed for SMS Tool');
    };

    console.log('‚úÖ SMS Auto Tool JavaScript loaded');
</script>

<!-- Site Configuration Modal -->
<div id="siteConfigModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; max-height: 85vh; overflow: hidden;">
        <div class="modal-header">
            <h3>‚öôÔ∏è Qu·∫£n L√Ω Links Sites - SMS Tool</h3>
            <span class="close" onclick="closeSiteConfigModal()">&times;</span>
        </div>

        <div class="modal-body" style="padding: 0; overflow: hidden;">
            <!-- Info Banner -->
            <div
                style="padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin: 0 0 5px 0; color: #1e40af; font-size: 16px;">üìã Qu·∫£n l√Ω Links Sites</h4>
                        <p style="margin: 0; color: #1e40af; font-size: 13px;">
                            C·∫•u h√¨nh 2 links cho m·ªói site: <strong>ƒêƒÉng k√Ω</strong>, <strong>Check</strong>
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportSiteConfigs()" class="btn"
                            style="background: #10b981; color: white; font-size: 12px; padding: 8px 16px;">
                            üì§ Export
                        </button>
                        <button onclick="importSiteConfigs()" class="btn"
                            style="background: #f59e0b; color: white; font-size: 12px; padding: 8px 16px;">
                            üì• Import
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filter and Search -->
            <div style="padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="flex: 1;">
                        <input type="text" id="siteSearchInput" placeholder="üîç T√¨m ki·∫øm site..."
                            onkeyup="filterSiteTable()"
                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                    </div>
                    <div>
                        <select id="categoryFilter" onchange="filterSiteTable()"
                            style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                            <option value="">T·∫•t c·∫£ categories</option>
                            <option value="OKVIP">üé∞ OKVIP</option>
                            <option value="ABCVIP">üé≤ ABCVIP</option>
                            <option value="KJC">üÉè KJC</option>
                            <option value="78WIN">üéØ 78WIN</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sites Table -->
            <div style="overflow-y: auto; max-height: 400px;">
                <table id="siteConfigTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead
                        style="background: linear-gradient(135deg, #374151, #1f2937); color: white; position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th
                                style="padding: 12px 15px; text-align: left; font-weight: 600; border-right: 1px solid #4b5563;">
                                Site</th>
                            <th
                                style="padding: 12px 15px; text-align: left; font-weight: 600; border-right: 1px solid #4b5563;">
                                Category</th>
                            <th
                                style="padding: 12px 15px; text-align: left; font-weight: 600; border-right: 1px solid #4b5563; min-width: 250px;">
                                üîó Link ƒêƒÉng K√Ω</th>
                            <th style="padding: 12px 15px; text-align: left; font-weight: 600; min-width: 200px;">‚úÖ Link
                                Check</th>
                        </tr>
                    </thead>
                    <tbody id="siteConfigTableBody">
                        <!-- Table rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal-footer" style="padding: 15px 20px; background: #f8fafc;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #6b7280; font-size: 12px;">
                    <span id="siteCount">0</span> sites ƒë∆∞·ª£c hi·ªÉn th·ªã
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="resetSiteConfigs()" class="btn"
                        style="background: #ef4444; color: white; font-size: 13px; padding: 10px 20px;">
                        üîÑ Reset m·∫∑c ƒë·ªãnh
                    </button>
                    <button onclick="saveSiteConfigs()" class="save-btn" style="font-size: 13px; padding: 10px 20px;">
                        üíæ L∆∞u c·∫•u h√¨nh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>üì• Import C·∫•u H√¨nh Sites</h3>
            <span class="close" onclick="closeImportModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 15px; color: #374151;">Paste JSON c·∫•u h√¨nh sites v√†o ƒë√¢y:</p>
            <textarea id="importTextarea" placeholder='{"SHBET": {"registerUrl": "...", "checkUrl": "..."}, ...}'
                style="width: 100%; height: 200px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
        </div>
        <div class="modal-footer">
            <button onclick="closeImportModal()" class="btn"
                style="background: #6b7280; color: white; margin-right: 10px;">
                H·ªßy
            </button>
            <button onclick="processImport()" class="save-btn">
                üì• Import
            </button>
        </div>
    </div>
</div>

<script>
    // Site Configuration Modal Functions
    function openSiteConfigModal() {
        document.getElementById('siteConfigModal').style.display = 'flex';
        populateSiteConfigTable();
    }

    function closeSiteConfigModal() {
        document.getElementById('siteConfigModal').style.display = 'none';
    }

    function populateSiteConfigTable() {
        const tableBody = document.getElementById('siteConfigTableBody');
        tableBody.innerHTML = '';

        // Group sites by category
        const categories = {
            'OKVIP': ['SHBET', 'F8BET', 'NEW88', 'HI88', '789BET', 'MB66'],
            'ABCVIP': ['J88', 'U888', 'ABC8', '88CLB'],
            'KJC': ['QQ88', 'RR88', 'XX88', 'MM88', 'X88'],
            '78WIN': ['JUN88', '78WIN']
        };

        // Category icons
        const categoryIcons = {
            'OKVIP': 'üé∞',
            'ABCVIP': 'üé≤',
            'KJC': 'üÉè',
            '78WIN': 'üéØ'
        };

        Object.entries(categories).forEach(([categoryName, sites]) => {
            sites.forEach(siteName => {
                const config = getSiteDataFromCheckbox(siteName);
                const row = document.createElement('tr');
                row.className = 'site-row';
                row.setAttribute('data-site', siteName.toLowerCase());
                row.setAttribute('data-category', categoryName);

                row.style.cssText = 'border-bottom: 1px solid #f3f4f6; transition: background-color 0.2s;';
                row.onmouseover = () => row.style.backgroundColor = '#f8fafc';
                row.onmouseout = () => row.style.backgroundColor = '';

                row.innerHTML = `
                    <td style="padding: 12px 15px; font-weight: 600; color: #1f2937; border-right: 1px solid #f3f4f6;">
                        ${siteName}
                    </td>
                    <td style="padding: 12px 15px; color: #6b7280; border-right: 1px solid #f3f4f6;">
                        ${categoryIcons[categoryName]} ${categoryName}
                    </td>
                    <td style="padding: 8px 12px; border-right: 1px solid #f3f4f6;">
                        <input type="url" id="register_${siteName}" value="${config.registerUrl}" 
                               style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;"
                               onchange="markAsModified('${siteName}')">
                    </td>
                    <td style="padding: 8px 12px;">
                        <input type="url" id="check_${siteName}" value="${config.checkUrl}" 
                               style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;"
                               onchange="markAsModified('${siteName}')">
                    </td>
                `;

                tableBody.appendChild(row);
            });
        });

        updateSiteCount();
    }

    // Filter and search functions
    function filterSiteTable() {
        const searchTerm = document.getElementById('siteSearchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const rows = document.querySelectorAll('.site-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const siteName = row.getAttribute('data-site');
            const category = row.getAttribute('data-category');

            const matchesSearch = siteName.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;

            if (matchesSearch && matchesCategory) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('siteCount').textContent = visibleCount;
    }

    function updateSiteCount() {
        const visibleRows = document.querySelectorAll('.site-row:not([style*="display: none"])').length;
        document.getElementById('siteCount').textContent = visibleRows;
    }

    function markAsModified(siteName) {
        // Visual feedback for modified sites
        const row = document.querySelector(`[data-site="${siteName.toLowerCase()}"]`);
        if (row) {
            row.style.backgroundColor = '#fef3cd';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 1000);
        }
    }

    function saveSiteConfigs() {
        const categories = {
            'OKVIP': ['SHBET', 'F8BET', 'NEW88', 'HI88', '789BET', 'MB66'],
            'ABCVIP': ['J88', 'U888', 'ABC8', '88CLB'],
            'KJC': ['QQ88', 'RR88', 'XX88', 'MM88', 'X88'],
            '78WIN': ['JUN88', '78WIN']
        };

        let updatedCount = 0;
        let errorCount = 0;

        Object.values(categories).flat().forEach(siteName => {
            const registerInput = document.getElementById(`register_${siteName}`);
            const checkInput = document.getElementById(`check_${siteName}`);

            if (registerInput && checkInput) {
                const registerUrl = registerInput.value.trim();
                const checkUrl = checkInput.value.trim();

                // Basic URL validation
                if (!registerUrl || !checkUrl) {
                    errorCount++;
                    markRowAsError(siteName);
                    return;
                }

                // Update checkbox attributes
                const siteCheckbox = document.querySelector(`.site-check[data-name="${siteName}"]`);
                if (siteCheckbox) {
                    siteCheckbox.setAttribute('data-register', registerUrl);
                    // Auto-generate login and withdraw URLs
                    const loginUrl = registerUrl.replace('/Account/Register', '/?app=1');
                    const withdrawUrl = registerUrl.replace('/Account/Register', '/Financial') + '?type=withdraw';
                    siteCheckbox.setAttribute('data-login', loginUrl);
                    siteCheckbox.setAttribute('data-withdraw', withdrawUrl);
                }
                updatedCount++;
                markRowAsSuccess(siteName);
            }
        });

        // Save to localStorage for persistence
        try {
            localStorage.setItem('sms_tool_site_configs', JSON.stringify(siteConfigs));

            if (errorCount > 0) {
                showToast('warning', 'L∆∞u m·ªôt ph·∫ßn', `C·∫≠p nh·∫≠t ${updatedCount} sites th√†nh c√¥ng, ${errorCount} sites c√≥ l·ªói (URL tr·ªëng)`);
            } else {
                showToast('success', 'ƒê√£ l∆∞u', `C·∫≠p nh·∫≠t ${updatedCount} sites th√†nh c√¥ng!`);
                setTimeout(() => closeSiteConfigModal(), 1500);
            }
        } catch (error) {
            showToast('error', 'L·ªói l∆∞u', 'Kh√¥ng th·ªÉ l∆∞u c·∫•u h√¨nh: ' + error.message);
        }
    }

    function markRowAsSuccess(siteName) {
        const row = document.querySelector(`[data-site="${siteName.toLowerCase()}"]`);
        if (row) {
            row.style.backgroundColor = '#dcfce7';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }
    }

    function markRowAsError(siteName) {
        const row = document.querySelector(`[data-site="${siteName.toLowerCase()}"]`);
        if (row) {
            row.style.backgroundColor = '#fee2e2';
            row.style.border = '1px solid #ef4444';
            setTimeout(() => {
                row.style.backgroundColor = '';
                row.style.border = '';
            }, 3000);
        }
    }

    // Export/Import functions
    function exportSiteConfigs() {
        try {
            const configJson = JSON.stringify(siteConfigs, null, 2);
            const blob = new Blob([configJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `sms-tool-site-configs-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('success', 'Export th√†nh c√¥ng', 'File c·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng');
        } catch (error) {
            showToast('error', 'L·ªói export', error.message);
        }
    }

    function importSiteConfigs() {
        document.getElementById('importModal').style.display = 'flex';
    }

    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
        document.getElementById('importTextarea').value = '';
    }

    function processImport() {
        try {
            const jsonText = document.getElementById('importTextarea').value.trim();
            if (!jsonText) {
                showToast('warning', 'Thi·∫øu d·ªØ li·ªáu', 'Vui l√≤ng paste JSON c·∫•u h√¨nh v√†o textarea');
                return;
            }

            const importedConfigs = JSON.parse(jsonText);
            let importCount = 0;

            // Validate and merge configs
            Object.entries(importedConfigs).forEach(([siteName, config]) => {
                if (config.registerUrl && config.checkUrl) {
                    siteConfigs[siteName] = {
                        registerUrl: config.registerUrl,
                        checkUrl: config.checkUrl
                    };
                    importCount++;
                }
            });

            if (importCount > 0) {
                // Save to localStorage
                localStorage.setItem('sms_tool_site_configs', JSON.stringify(siteConfigs));

                // Refresh table
                populateSiteConfigTable();

                showToast('success', 'Import th√†nh c√¥ng', `ƒê√£ import ${importCount} sites`);
                closeImportModal();
            } else {
                showToast('error', 'Import th·∫•t b·∫°i', 'Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh h·ª£p l·ªá trong JSON');
            }
        } catch (error) {
            showToast('error', 'L·ªói JSON', 'Format JSON kh√¥ng h·ª£p l·ªá: ' + error.message);
        }
    }

    function resetSiteConfigs() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset t·∫•t c·∫£ c·∫•u h√¨nh v·ªÅ m·∫∑c ƒë·ªãnh?')) {
            // Clear localStorage
            localStorage.removeItem('sms_tool_site_configs');

            // Reset to default configs (will be reloaded)
            location.reload();
        }
    }

    // Load saved configs from localStorage on page load
    function loadSavedSiteConfigs() {
        try {
            const saved = localStorage.getItem('sms_tool_site_configs');
            if (saved) {
                const savedConfigs = JSON.parse(saved);
                Object.assign(siteConfigs, savedConfigs);
                console.log('‚úÖ Loaded saved site configs from localStorage');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Could not load saved site configs:', error);
        }
    }

    // Load saved configs when page loads
    loadSavedSiteConfigs();
</script>