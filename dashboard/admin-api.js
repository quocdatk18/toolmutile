/**
 * Admin API - Build and manage customer packages
 * FIXED VERSION - Actually builds packages
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');
const os = require('os');

// Only require archiver if available
let archiver;
try {
    archiver = require('archiver');
} catch (err) {
    console.log('âš ï¸  archiver not installed. Run: npm install archiver');
}

class AdminAPI {
    constructor() {
        this.packagesDir = path.join(__dirname, '..', 'customer-packages');
    }

    /**
     * Build customer package - REAL IMPLEMENTATION
     */
    async buildPackage(options) {
        const { customerName, licenseType, machineBinding, obfuscate } = options;

        try {
            // Validate
            if (!customerName || !customerName.match(/^[a-zA-Z0-9_-]+$/)) {
                return { success: false, message: 'TÃªn khÃ¡ch hÃ ng khÃ´ng há»£p lá»‡' };
            }

            // Check if package already exists
            const packagePath = path.join(this.packagesDir, customerName);
            if (fs.existsSync(packagePath)) {
                return { success: false, message: 'Package Ä‘Ã£ tá»“n táº¡i! Vui lÃ²ng xÃ³a hoáº·c Ä‘á»•i tÃªn.' };
            }

            // Create packages directory
            if (!fs.existsSync(this.packagesDir)) {
                fs.mkdirSync(this.packagesDir, { recursive: true });
            }

            // Create output folder
            fs.mkdirSync(packagePath, { recursive: true });

            // Copy files
            console.log('ðŸ“‹ Copying files...');
            const itemsToCopy = ['core', 'dashboard', 'config', 'tools', 'package.json', 'package-lock.json', '.env', '.license'];
            itemsToCopy.forEach(item => {
                const srcPath = path.join(__dirname, '..', item);
                const destPath = path.join(packagePath, item);
                if (fs.existsSync(srcPath)) {
                    this.copyRecursive(srcPath, destPath);
                    console.log(`âœ… Copied: ${item}`);
                } else {
                    console.log(`âš ï¸  Not found: ${item}`);
                }
            });

            // Generate unique secret key
            const secretKey = `SECRET_${customerName}_${Math.floor(Math.random() * 100000)}_${Math.floor(Math.random() * 100000)}`;
            console.log(`ðŸ” Secret key: ${secretKey}`);

            // Update secret key in license-manager.js
            const licenseManagerPath = path.join(packagePath, 'core', 'license-manager.js');
            if (fs.existsSync(licenseManagerPath)) {
                let content = fs.readFileSync(licenseManagerPath, 'utf8');
                content = content.replace(/HIDEMIUM_TOOL_SECRET_2024/g, secretKey);
                fs.writeFileSync(licenseManagerPath, content, 'utf8');
            }

            // Create customer version marker
            fs.writeFileSync(path.join(packagePath, '.customer'), customerName, 'utf8');
            console.log('âœ… Created customer version marker');

            // Create simple version info file
            const versionInfo = {
                customer: customerName,
                version: '3.0.0',
                createdAt: new Date().toISOString(),
                buildType: 'customer-package'
            };
            fs.writeFileSync(
                path.join(packagePath, '.version-info.json'),
                JSON.stringify(versionInfo, null, 2),
                'utf8'
            );
            console.log('âœ… Created version info');

            // Save license key placeholder (actual key will be generated by admin)
            const licenseKeyContent = `
License Key Instructions
========================
Package: ${customerName}
Created: ${new Date().toLocaleString('vi-VN')}
License Type: ${licenseType === -1 ? 'Lifetime' : licenseType >= 1 ? licenseType + ' days' : (licenseType * 24 * 60).toFixed(0) + ' minutes'}
Machine Binding: ${machineBinding ? 'YES' : 'NO'}

HÆ¯á»šNG DáºªN KÃCH HOáº T:
====================

BÆ¯á»šC 1: CÃ i Ä‘áº·t vÃ  cháº¡y tool
   - Cháº¡y INSTALL.bat Ä‘á»ƒ cÃ i Ä‘áº·t
   - Cháº¡y START.bat Ä‘á»ƒ khá»Ÿi Ä‘á»™ng dashboard
   - Má»Ÿ trÃ¬nh duyá»‡t: http://localhost:3000

BÆ¯á»šC 2: Láº¥y Machine ID
   - Trong dashboard, vÃ o tab "License Info"
   - Copy Machine ID (16 kÃ½ tá»±)
   - Gá»­i Machine ID cho admin

BÆ¯á»šC 3: Nháº­n license key
   - Admin sáº½ táº¡o license key dá»±a trÃªn Machine ID cá»§a báº¡n
   - Nháº­n license key qua email/chat

BÆ¯á»šC 4: KÃ­ch hoáº¡t
   - Trong dashboard, click "KÃ­ch Hoáº¡t Báº£n Quyá»n"
   - DÃ¡n license key vÃ o
   - Click "KÃ­ch Hoáº¡t"

âš ï¸  LÆ¯U Ã:
   - License key chá»‰ hoáº¡t Ä‘á»™ng trÃªn mÃ¡y cÃ³ Machine ID tÆ°Æ¡ng á»©ng
   - KhÃ´ng thá»ƒ sá»­ dá»¥ng trÃªn mÃ¡y khÃ¡c
   - KhÃ´ng chia sáº» license key cho ngÆ°á»i khÃ¡c

========================================
License key sáº½ Ä‘Æ°á»£c cáº­p nháº­t vÃ o file nÃ y sau khi admin táº¡o.
`;
            fs.writeFileSync(path.join(packagePath, 'LICENSE_KEY.txt'), licenseKeyContent, 'utf8');

            // Clean sensitive data
            console.log('ðŸ§¹ Cleaning sensitive data...');
            this.cleanSensitiveData(packagePath);

            // Create README
            const readme = `========================================
HIDEMIUM MULTI-TOOL
========================================

Customer: ${customerName}
License: ${licenseType === -1 ? 'VÄ©nh viá»…n' : licenseType >= 1 ? licenseType + ' ngÃ y' : (licenseType * 24 * 60).toFixed(0) + ' phÃºt'}

CÃ€I Äáº¶T & CHáº Y:
  
  BÆ¯á»šC 1 - CÃ€I Äáº¶T (chá»‰ cáº§n lÃ m 1 láº§n):
  âœ… Double-click file: INSTALL.bat
     (Náº¿u chÆ°a cÃ³ Node.js, táº£i táº¡i: https://nodejs.org)
  
  BÆ¯á»šC 2 - KHá»žI Äá»˜NG:
  âœ… Double-click file: START.bat
  
  CÃCH MANUAL (náº¿u cáº§n):
  1. CÃ i Node.js (náº¿u chÆ°a cÃ³)
  2. Má»Ÿ CMD táº¡i thÆ° má»¥c nÃ y
  3. Cháº¡y: npm install
  4. Cháº¡y: npm run dashboard

KÃCH HOáº T:
  1. Má»Ÿ dashboard: http://localhost:3000
  2. VÃ o tab "License Info" â†’ Copy Machine ID
  3. Gá»­i Machine ID cho admin
  4. Nháº­n license key tá»« admin
  5. Click "KÃ­ch Hoáº¡t Báº£n Quyá»n" â†’ DÃ¡n license key
  6. Click "KÃ­ch Hoáº¡t"

âš ï¸  LÆ¯U Ã Báº¢O Máº¬T:
  - License key chá»‰ hoáº¡t Ä‘á»™ng trÃªn mÃ¡y nÃ y (Machine ID cá»‘ Ä‘á»‹nh)
  - KhÃ´ng thá»ƒ sá»­ dá»¥ng trÃªn mÃ¡y khÃ¡c
  - KhÃ´ng chia sáº» license key cho ngÆ°á»i khÃ¡c

========================================
`;
            fs.writeFileSync(path.join(packagePath, 'README.txt'), readme, 'utf8');

            // Create INSTALL.bat
            const installBat = `@echo off
chcp 65001 >nul 2>&1
cd /d "%~dp0"
cls
echo ========================================
echo    HIDEMIUM MULTI-TOOL - INSTALLATION
echo ========================================
echo.
echo Customer: ${customerName}
echo.

REM Check if Node.js is installed
where node >nul 2>nul
if errorlevel 1 (
    echo [ERROR] Node.js is not installed!
    echo.
    echo Please install Node.js from:
    echo    https://nodejs.org
    echo.
    echo    Download LTS version (recommended)
    echo.
    pause
    exit /b 1
)

echo [OK] Node.js installed:
node --version
echo.

REM Check npm
where npm >nul 2>nul
if errorlevel 1 (
    echo [ERROR] npm not found!
    echo.
    echo Please reinstall Node.js
    echo.
    pause
    exit /b 1
)

echo [OK] npm installed:
npm --version
echo.

REM Check if already installed
if exist "node_modules" (
    echo [WARNING] Dependencies already installed
    echo.
    set /p REINSTALL="Do you want to reinstall? (y/n): "
    if /i not "%REINSTALL%"=="y" (
        echo.
        echo [OK] Skipping installation
        echo.
        echo Run START.bat to start dashboard
        pause
        exit /b 0
    )
    echo.
    echo Removing old node_modules...
    rmdir /s /q node_modules 2>nul
    if exist "package-lock.json" (
        del /f /q package-lock.json 2>nul
    )
)

echo Installing dependencies...
echo This may take a few minutes...
echo.
echo Running: npm install
echo.

REM Run npm install
npm install --no-optional --loglevel=error

if errorlevel 1 (
    echo.
    echo [ERROR] Installation failed!
    echo.
    echo Please try:
    echo    1. Check internet connection
    echo    2. Run CMD as Administrator
    echo    3. Run command: npm install
    echo    4. Contact support
    echo.
    echo Debug info:
    echo    - Node version: 
    node --version
    echo    - npm version: 
    npm --version
    echo    - Current dir: %CD%
    echo.
    pause
    exit /b 1
)

REM Verify installation
if not exist "node_modules" (
    echo.
    echo [ERROR] node_modules was not created!
    echo.
    echo Please run manually:
    echo    npm install
    echo.
    pause
    exit /b 1
)

echo.
echo ========================================
echo    INSTALLATION COMPLETED!
echo ========================================
echo.
echo Next steps:
echo    1. Run START.bat to start dashboard
echo    2. Open browser: http://localhost:3000
echo    3. Activate license from LICENSE_KEY.txt
echo.
pause
`;
            fs.writeFileSync(path.join(packagePath, 'INSTALL.bat'), installBat, 'utf8');

            // Create customer guide
            const customerGuide = `========================================
ðŸ“– HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG - HIDEMIUM MULTI-TOOL
========================================

ðŸŽ¯ DÃ€NH CHO KHÃCH HÃ€NG KHÃ”NG BIáº¾T CODE

========================================
BÆ¯á»šC 1: CÃ€I Äáº¶T NODE.JS (náº¿u chÆ°a cÃ³)
========================================

1. Má»Ÿ trÃ¬nh duyá»‡t, vÃ o: https://nodejs.org
2. Táº£i báº£n "LTS" (khuyáº¿n nghá»‹) - nÃºt mÃ u xanh lÃ¡
3. Cháº¡y file .msi vá»«a táº£i vá»
4. Click "Next" â†’ "Next" â†’ "Install" â†’ "Finish"
5. Khá»Ÿi Ä‘á»™ng láº¡i mÃ¡y tÃ­nh (quan trá»ng!)

âœ… Xong! Node.js Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t.

========================================
BÆ¯á»šC 2: CÃ€I Äáº¶T TOOL (chá»‰ lÃ m 1 láº§n)
========================================

1. Giáº£i nÃ©n file ZIP báº¡n nháº­n Ä‘Æ°á»£c
2. VÃ o thÆ° má»¥c vá»«a giáº£i nÃ©n
3. TÃ¬m file: INSTALL.bat
4. Double-click vÃ o INSTALL.bat
5. Äá»£i cÃ i Ä‘áº·t xong (cÃ³ thá»ƒ máº¥t 2-5 phÃºt)
6. Tháº¥y "CÃ€I Äáº¶T HOÃ€N Táº¤T!" â†’ Nháº¥n phÃ­m báº¥t ká»³ Ä‘á»ƒ Ä‘Ã³ng

âœ… Xong! Tool Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t.

========================================
BÆ¯á»šC 3: KHá»žI Äá»˜NG TOOL
========================================

1. TÃ¬m file: START.bat (trong cÃ¹ng thÆ° má»¥c)
2. Double-click vÃ o START.bat
3. Äá»£i 5-10 giÃ¢y
4. TrÃ¬nh duyá»‡t sáº½ tá»± Ä‘á»™ng má»Ÿ trang: http://localhost:3000

âœ… Xong! Dashboard Ä‘Ã£ khá»Ÿi Ä‘á»™ng.

========================================
BÆ¯á»šC 4: KÃCH HOáº T LICENSE
========================================

1. Trong dashboard, click nÃºt "ðŸ” KÃ­ch Hoáº¡t Báº£n Quyá»n"
2. Má»Ÿ file LICENSE_KEY.txt (trong thÆ° má»¥c tool)
3. Copy toÃ n bá»™ license key (dÃ²ng dÃ i)
4. Paste vÃ o Ã´ "License Key" trong dashboard
5. Click "KÃ­ch Hoáº¡t"
6. Tháº¥y "âœ… License activated successfully" â†’ ThÃ nh cÃ´ng!

âœ… Xong! Tool Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t.

========================================
BÆ¯á»šC 5: Sá»¬ Dá»¤NG TOOL
========================================

1. Chá»n tool báº¡n muá»‘n dÃ¹ng (NOHU, HAI2VIP, v.v.)
2. Äiá»n thÃ´ng tin cáº§n thiáº¿t
3. Click "Start Automation"
4. Xem káº¿t quáº£ trong tab "Results"

âœ… Xong! Báº¡n Ä‘Ã£ biáº¿t cÃ¡ch dÃ¹ng tool.

========================================
â“ CÃ‚U Há»ŽI THÆ¯á»œNG Gáº¶P
========================================

Q: LÃ m sao biáº¿t Node.js Ä‘Ã£ cÃ i Ä‘áº·t?
A: Má»Ÿ CMD, gÃµ: node --version
   Náº¿u hiá»‡n sá»‘ phiÃªn báº£n â†’ ÄÃ£ cÃ i Ä‘áº·t
   Náº¿u bÃ¡o lá»—i â†’ ChÆ°a cÃ i Ä‘áº·t

Q: INSTALL.bat bÃ¡o lá»—i?
A: - Kiá»ƒm tra káº¿t ná»‘i internet
   - Cháº¡y láº¡i INSTALL.bat
   - Khá»Ÿi Ä‘á»™ng láº¡i mÃ¡y tÃ­nh
   - LiÃªn há»‡ há»— trá»£

Q: START.bat khÃ´ng cháº¡y?
A: - Cháº¡y INSTALL.bat trÆ°á»›c
   - Kiá»ƒm tra port 3000 cÃ³ bá»‹ chiáº¿m khÃ´ng
   - ÄÃ³ng táº¥t cáº£ CMD Ä‘ang má»Ÿ
   - Cháº¡y láº¡i START.bat

Q: License khÃ´ng kÃ­ch hoáº¡t Ä‘Æ°á»£c?
A: - Kiá»ƒm tra copy Ä‘Ãºng toÃ n bá»™ license key
   - KhÃ´ng cÃ³ khoáº£ng tráº¯ng thá»«a
   - License chÆ°a háº¿t háº¡n
   - LiÃªn há»‡ há»— trá»£

Q: LÃ m sao dá»«ng tool?
A: - ÄÃ³ng cá»­a sá»• CMD mÃ u Ä‘en
   - Hoáº·c nháº¥n Ctrl+C trong CMD

Q: CÃ³ thá»ƒ cháº¡y nhiá»u tool cÃ¹ng lÃºc?
A: KhÃ´ng, chá»‰ cháº¡y Ä‘Æ°á»£c 1 instance táº¡i 1 thá»i Ä‘iá»ƒm
   (vÃ¬ cÃ¹ng dÃ¹ng port 3000)

========================================
ðŸ“ž Há»– TRá»¢
========================================

Náº¿u gáº·p váº¥n Ä‘á», liÃªn há»‡ ngÆ°á»i bÃ¡n vá»›i thÃ´ng tin:

1. áº¢nh chá»¥p mÃ n hÃ¬nh lá»—i
2. Ná»™i dung file LICENSE_KEY.txt
3. PhiÃªn báº£n Node.js (cháº¡y: node --version)
4. Há»‡ Ä‘iá»u hÃ nh (Windows 10/11)

========================================
âš ï¸ LÆ¯U Ã QUAN TRá»ŒNG
========================================

âœ… ÄÆ¯á»¢C PHÃ‰P:
- Sá»­ dá»¥ng tool cho má»¥c Ä‘Ã­ch cÃ¡ nhÃ¢n
- CÃ i Ä‘áº·t trÃªn 1 mÃ¡y tÃ­nh (náº¿u license bind machine)
- YÃªu cáº§u há»— trá»£ khi gáº·p lá»—i

âŒ KHÃ”NG ÄÆ¯á»¢C PHÃ‰P:
- Chia sáº» license key cho ngÆ°á»i khÃ¡c
- CÃ i Ä‘áº·t trÃªn nhiá»u mÃ¡y (náº¿u license bind machine)
- Sá»­a Ä‘á»•i code cá»§a tool
- BÃ¡n láº¡i hoáº·c phÃ¢n phá»‘i tool

========================================
ðŸŽ‰ CHÃšC Báº N Sá»¬ Dá»¤NG TOOL HIá»†U QUáº¢!
========================================
`;
            fs.writeFileSync(path.join(packagePath, 'HUONG_DAN_KHACH_HANG.txt'), customerGuide, 'utf8');

            // Create screenshots folder (for automation results)
            const screenshotsDir = path.join(packagePath, 'screenshots');
            if (!fs.existsSync(screenshotsDir)) {
                fs.mkdirSync(screenshotsDir, { recursive: true });
                console.log('   ðŸ“ Created screenshots directory');
            }

            // Create .gitkeep to preserve folder
            fs.writeFileSync(path.join(screenshotsDir, '.gitkeep'), '', 'utf8');

            // Create START.bat
            const startBat = `@echo off
chcp 65001 >nul 2>&1
cd /d "%~dp0"
cls
echo ========================================
echo    HIDEMIUM MULTI-TOOL
echo ========================================
echo.
echo Customer: ${customerName}
echo License: ${licenseType === -1 ? 'Lifetime' : licenseType >= 1 ? licenseType + ' days' : (licenseType * 24 * 60).toFixed(0) + ' minutes'}
echo.

REM Check if Node.js is installed
where node >nul 2>nul
if errorlevel 1 (
    echo [ERROR] Node.js is not installed!
    echo.
    echo Please install Node.js from: https://nodejs.org
    echo.
    pause
    exit /b 1
)

REM Check if node_modules exists
if not exist "node_modules" (
    echo [WARNING] Dependencies not installed!
    echo.
    echo Please run INSTALL.bat first
    echo.
    echo Or press any key to install now...
    pause >nul
    echo.
    echo Installing dependencies...
    echo Please wait...
    echo.
    npm install --no-optional --loglevel=error
    if errorlevel 1 (
        echo.
        echo [ERROR] Installation failed!
        echo.
        echo Please try:
        echo    1. Run INSTALL.bat
        echo    2. Or run: npm install
        echo.
        pause
        exit /b 1
    )
    echo.
    echo Installation completed!
    echo.
)

REM Check if package.json exists
if not exist "package.json" (
    echo [ERROR] package.json not found!
    echo.
    echo Please run from tool root directory
    echo.
    pause
    exit /b 1
)

echo Starting dashboard...
echo Dashboard will open at: http://localhost:3000
echo.
echo License key: See LICENSE_KEY.txt
echo.
echo To stop server: Press Ctrl+C
echo.
echo ========================================
echo.

REM Start dashboard
npm run dashboard

REM If npm run dashboard fails
if errorlevel 1 (
    echo.
    echo [ERROR] Cannot start dashboard!
    echo.
    echo Try running manually:
    echo    node dashboard/server.js
    echo.
    pause
    exit /b 1
)
`;
            fs.writeFileSync(path.join(packagePath, 'START.bat'), startBat, 'utf8');

            // Create auto-delete zip script (runs after successful activation)
            const deleteZipScript = `const fs = require('fs');
const path = require('path');

// This script runs after successful license activation
// It deletes the original ZIP file to prevent reuse

function deleteOriginalZip() {
    try {
        // Look for ZIP files in parent directory
        const parentDir = path.join(__dirname, '..');
        
        if (!fs.existsSync(parentDir)) {
            console.log('âš ï¸  Parent directory not found');
            return;
        }

        const files = fs.readdirSync(parentDir);
        const zipFiles = files.filter(f => f.toLowerCase().endsWith('.zip'));

        if (zipFiles.length === 0) {
            console.log('â„¹ï¸  No ZIP files found to delete');
            return;
        }

        // Delete each ZIP file
        zipFiles.forEach(zipFile => {
            const zipPath = path.join(parentDir, zipFile);
            try {
                fs.unlinkSync(zipPath);
                console.log('ðŸ—‘ï¸  Deleted original ZIP:', zipFile);
            } catch (err) {
                console.warn('âš ï¸  Could not delete ZIP:', zipFile, err.message);
            }
        });

        console.log('âœ… Original ZIP files deleted successfully');
        console.log('ðŸ’¡ This prevents license key reuse on other machines');
        
    } catch (error) {
        console.warn('âš ï¸  Auto-delete ZIP failed:', error.message);
    }
}

// Export for use in license activation
module.exports = { deleteOriginalZip };

// Can also run standalone
if (require.main === module) {
    deleteOriginalZip();
}
`;
            fs.writeFileSync(path.join(packagePath, 'core', 'delete-zip.js'), deleteZipScript, 'utf8');

            // Save secret key info
            const secretKeyInfo = `PACKAGE INFO
=============
Customer: ${customerName}
Secret Key: ${secretKey}
License Type: ${licenseType === -1 ? 'Lifetime' : licenseType >= 1 ? licenseType + ' days' : (licenseType * 24 * 60).toFixed(0) + ' minutes'}
Created: ${new Date().toLocaleString('vi-VN')}
Machine Binding: ${machineBinding ? 'Yes' : 'No'}
Machine ID: Will be provided by customer
`;
            fs.writeFileSync(path.join(this.packagesDir, `${customerName}_SECRET_KEY.txt`), secretKeyInfo, 'utf8');

            console.log('âœ… Package created successfully!');

            return {
                success: true,
                packagePath: `customer-packages/${customerName}`,
                secretKey: secretKey,
                message: 'Package created successfully'
            };

        } catch (error) {
            console.error('âŒ Build error:', error);
            return {
                success: false,
                message: error.message
            };
        }
    }

    /**
     * Copy files recursively
     */
    copyRecursive(src, dest) {
        const exists = fs.existsSync(src);
        const stats = exists && fs.statSync(src);
        const isDirectory = exists && stats.isDirectory();

        if (isDirectory) {
            if (!fs.existsSync(dest)) {
                fs.mkdirSync(dest, { recursive: true });
            }
            fs.readdirSync(src).forEach(childItemName => {
                this.copyRecursive(
                    path.join(src, childItemName),
                    path.join(dest, childItemName)
                );
            });
        } else {
            fs.copyFileSync(src, dest);
        }
    }

    /**
     * Get machine ID (hardware fingerprint)
     * Based on MAC addresses and hostname
     */
    getMachineId() {
        const networkInterfaces = os.networkInterfaces();
        const macs = [];

        for (const name of Object.keys(networkInterfaces)) {
            for (const iface of networkInterfaces[name]) {
                if (iface.mac && iface.mac !== '00:00:00:00:00:00') {
                    macs.push(iface.mac);
                }
            }
        }

        const combined = macs.join('-') + os.hostname();
        return crypto.createHash('sha256').update(combined).digest('hex').substring(0, 16);
    }

    /**
     * Clean sensitive data from package
     */
    cleanSensitiveData(packagePath) {
        // Remove sensitive files
        const filesToRemove = [
            'tools/generate-license.js',
            'tools/obfuscate-license.js',
            'tools/obfuscate-all.js',
            'tools/activate-license.js',
            'license-records',
            'customer-packages',
            'backups',
            // 'screenshots' - Keep this folder for customer
            // '.license' - KEEP this file for customer license
            '.git',
            '.gitignore',
            'dashboard/admin.html',      // â† Remove admin page
            'dashboard/admin-api.js'     // â† Remove admin API
        ];

        filesToRemove.forEach(item => {
            const itemPath = path.join(packagePath, item);
            if (fs.existsSync(itemPath)) {
                try {
                    fs.rmSync(itemPath, { recursive: true, force: true });
                    console.log(`   ðŸ—‘ï¸  Removed: ${item}`);
                } catch (err) { }
            }
        });

        // Clean screenshots folder but keep the folder itself
        const screenshotsPath = path.join(packagePath, 'screenshots');
        if (fs.existsSync(screenshotsPath)) {
            try {
                const files = fs.readdirSync(screenshotsPath);
                files.forEach(file => {
                    const filePath = path.join(screenshotsPath, file);
                    try {
                        fs.rmSync(filePath, { recursive: true, force: true });
                    } catch (err) { }
                });
                console.log('   ðŸ—‘ï¸  Cleaned screenshots folder');
            } catch (err) { }
        }

        // Remove all .bat and .md files
        try {
            const allFiles = fs.readdirSync(packagePath);
            allFiles.forEach(file => {
                if (file.endsWith('.bat') || file.endsWith('.md')) {
                    try {
                        fs.unlinkSync(path.join(packagePath, file));
                    } catch (err) { }
                }
            });
        } catch (err) { }

        // Clean config files
        const settingsPath = path.join(packagePath, 'config', 'settings.json');
        if (fs.existsSync(settingsPath)) {
            try {
                const settings = JSON.parse(fs.readFileSync(settingsPath, 'utf8'));
                if (settings.apiKey) {
                    settings.apiKey.key = '';
                    settings.apiKey.balance = 0;
                }
                if (settings.extensions) {
                    Object.keys(settings.extensions).forEach(key => {
                        settings.extensions[key] = '';
                    });
                }
                fs.writeFileSync(settingsPath, JSON.stringify(settings, null, 2), 'utf8');
            } catch (err) { }
        }

        // Clean .env
        const envPath = path.join(packagePath, '.env');
        if (fs.existsSync(envPath)) {
            const cleanEnv = `# Environment Configuration
# KhÃ¡ch hÃ ng cáº§n cáº¥u hÃ¬nh cÃ¡c biáº¿n mÃ´i trÆ°á»ng táº¡i Ä‘Ã¢y
`;
            fs.writeFileSync(envPath, cleanEnv, 'utf8');
        }
    }

    /**
     * List all packages
     */
    async listPackages() {
        try {
            if (!fs.existsSync(this.packagesDir)) {
                return { success: true, packages: [] };
            }

            const items = fs.readdirSync(this.packagesDir);
            const packages = [];

            for (const item of items) {
                const itemPath = path.join(this.packagesDir, item);

                try {
                    const stat = fs.statSync(itemPath);

                    if (stat.isDirectory()) {
                        const size = this.getDirectorySize(itemPath);
                        const created = stat.birthtime.toLocaleString('vi-VN');

                        packages.push({
                            name: item,
                            created: created,
                            size: this.formatBytes(size)
                        });
                    }
                } catch (err) {
                    // Skip if error
                }
            }

            return { success: true, packages };

        } catch (error) {
            return { success: false, message: error.message };
        }
    }

    /**
     * Generate new license key for existing package
     */
    async generateNewKey(options) {
        const { packageName, licenseType, machineBinding, machineId } = options;

        try {
            // Check if package exists
            const packagePath = path.join(this.packagesDir, packageName);
            if (!fs.existsSync(packagePath)) {
                return { success: false, message: 'Package khÃ´ng tá»“n táº¡i' };
            }

            // Read secret key from file
            const secretKeyFile = path.join(this.packagesDir, `${packageName}_SECRET_KEY.txt`);
            if (!fs.existsSync(secretKeyFile)) {
                return { success: false, message: 'KhÃ´ng tÃ¬m tháº¥y secret key file' };
            }

            const secretKeyContent = fs.readFileSync(secretKeyFile, 'utf8');
            const secretKeyMatch = secretKeyContent.match(/Secret Key: (.+)/);
            if (!secretKeyMatch) {
                return { success: false, message: 'KhÃ´ng thá»ƒ Ä‘á»c secret key' };
            }

            const secretKey = secretKeyMatch[1].trim();

            // Generate new license key
            // Machine ID should be provided by customer (from their dashboard)
            const finalMachineId = machineBinding ? machineId : null;
            const days = licenseType;
            const now = Date.now();
            const expiry = days === -1 ? -1 : now + (days * 24 * 60 * 60 * 1000);

            const licenseData = {
                username: packageName,
                machineId: finalMachineId,
                expiry: expiry,
                created: now
            };

            const dataString = JSON.stringify(licenseData);
            const signature = crypto.createHmac('sha256', secretKey).update(dataString).digest('hex');
            const licenseKey = Buffer.from(dataString).toString('base64') + '.' + signature;

            // Save new license key to package
            const licenseKeyContent = `
License Key Record
==================
Generated: ${new Date().toLocaleString('vi-VN')}
Username: ${packageName}
Type: ${licenseType === -1 ? 'Lifetime' : licenseType >= 1 ? licenseType + ' days' : (licenseType * 24 * 60).toFixed(0) + ' minutes'}
Machine Binding: ${machineBinding ? 'YES' : 'NO'}
Machine ID: ${machineBinding ? finalMachineId : 'N/A'}

License Key:
${licenseKey}
`;
            fs.writeFileSync(path.join(packagePath, 'LICENSE_KEY.txt'), licenseKeyContent, 'utf8');

            console.log(`âœ… Generated new license key for ${packageName}`);

            return {
                success: true,
                licenseKey: licenseKey,
                message: 'License key created successfully'
            };

        } catch (error) {
            console.error('âŒ Generate key error:', error);
            return {
                success: false,
                message: error.message
            };
        }
    }

    /**
     * Delete package
     */
    async deletePackage(packageName) {
        try {
            const packagePath = path.join(this.packagesDir, packageName);

            if (!fs.existsSync(packagePath)) {
                return { success: false, message: 'Package khÃ´ng tá»“n táº¡i' };
            }

            fs.rmSync(packagePath, { recursive: true, force: true });

            // Also delete secret key file
            const secretKeyFile = path.join(this.packagesDir, `${packageName}_SECRET_KEY.txt`);
            if (fs.existsSync(secretKeyFile)) {
                fs.unlinkSync(secretKeyFile);
            }

            return { success: true, message: 'ÄÃ£ xÃ³a package' };

        } catch (error) {
            return { success: false, message: error.message };
        }
    }

    /**
     * Create ZIP archive of package
     */
    async createZip(packageName, outputPath) {
        if (!archiver) {
            throw new Error('archiver not installed. Run: npm install archiver');
        }

        return new Promise((resolve, reject) => {
            const packagePath = path.join(this.packagesDir, packageName);

            if (!fs.existsSync(packagePath)) {
                reject(new Error('Package khÃ´ng tá»“n táº¡i'));
                return;
            }

            const output = fs.createWriteStream(outputPath);
            const archive = archiver('zip', { zlib: { level: 9 } });

            output.on('close', () => {
                resolve(outputPath);
            });

            archive.on('error', (err) => {
                reject(err);
            });

            archive.pipe(output);
            archive.directory(packagePath, packageName);
            archive.finalize();
        });
    }

    /**
     * Get directory size
     */
    getDirectorySize(dirPath) {
        let size = 0;

        try {
            const items = fs.readdirSync(dirPath);
            for (const item of items) {
                const itemPath = path.join(dirPath, item);
                try {
                    const stat = fs.statSync(itemPath);

                    if (stat.isDirectory()) {
                        size += this.getDirectorySize(itemPath);
                    } else {
                        size += stat.size;
                    }
                } catch (err) {
                    // Skip if error
                }
            }
        } catch (err) {
            // Skip if error
        }

        return size;
    }

    /**
     * Format bytes to human readable
     */
    formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';

        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
}

module.exports = new AdminAPI();
