/**
 * Generate license key cho customer package
 * Usage: node generate-customer-license.js <customerName> <machineId> <days>
 */

const fs = require('fs');
const path = require('path');

// Get parameters
const customerName = process.argv[2];
const machineId = process.argv[3];
const days = parseInt(process.argv[4]) || 30;

if (!customerName || !machineId) {
    process.exit(1);
}

// Load customer's license manager
const customerPath = path.join(__dirname, 'customer-packages', customerName);
const customerLicenseManagerPath = path.join(customerPath, 'core', 'license-manager.js');

if (!fs.existsSync(customerLicenseManagerPath)) {
    process.exit(1);
}

try {
    // Clear require cache to ensure we load the customer's version
    delete require.cache[require.resolve(customerLicenseManagerPath)];

    // Load customer's license manager (with their secret key)
    const LicenseManager = require(customerLicenseManagerPath);
    const licenseManager = new LicenseManager();

    // Generate license key
    const licenseKey = licenseManager.generateKey({
        expiryDays: days,
        machineId: machineId,
        username: customerName
    });

    // Save to customer's LICENSE_KEY.txt file
    const licenseKeyFile = path.join(customerPath, 'LICENSE_KEY.txt');
    let content = fs.readFileSync(licenseKeyFile, 'utf8');

    // Append the actual license key
    content += '\n\n' + '='.repeat(50);
    content += '\nACTUAL LICENSE KEY (Generated by Admin):';
    content += '\n' + '='.repeat(50);
    content += '\n' + licenseKey;
    content += '\n\nCopy the license key above and paste it in the dashboard activation form.';

    fs.writeFileSync(licenseKeyFile, content, 'utf8');

    // Test validation
    const validation = licenseManager.validateKey(licenseKey);

    if (validation.valid) {
    }

} catch (error) {
    console.log(`‚ùå Error: ${error.message}`);
    console.log(error.stack);
}