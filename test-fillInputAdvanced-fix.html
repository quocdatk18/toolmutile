<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test fillInputAdvanced Fix</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }

        .container {
            background-color: #2d2d30;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        h1 {
            color: #569cd6;
            text-align: center;
        }

        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #3c3c3c;
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-radius: 4px;
            font-size: 14px;
        }

        .test-controls {
            margin: 20px 0;
        }

        button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #1177bb;
        }

        .console-output {
            background-color: #0c0c0c;
            border: 1px solid #3c3c3c;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .status.ready {
            background-color: #1a472a;
            color: #4caf50;
        }

        .status.running {
            background-color: #3d3d00;
            color: #ffeb3b;
        }

        .status.completed {
            background-color: #1a472a;
            color: #4caf50;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Test fillInputAdvanced Fix</h1>
        <p><strong>V·∫•n ƒë·ªÅ:</strong> Khi user x√≥a input, proxy v·∫´n gi·ªØ gi√° tr·ªã c≈©</p>
        <p><strong>Fix:</strong> Clear input tr∆∞·ªõc khi set gi√° tr·ªã m·ªõi ƒë·ªÉ reset proxy state</p>

        <div class="status ready" id="status">
            ‚úÖ S·∫µn s√†ng ch·∫°y test
        </div>

        <div class="test-controls">
            <button onclick="runAutomaticTests()">üöÄ Ch·∫°y Test T·ª± ƒê·ªông</button>
            <button onclick="runManualTest()">üñ±Ô∏è Test Th·ªß C√¥ng</button>
            <button onclick="clearConsole()">üßπ X√≥a Console</button>
        </div>

        <div>
            <h3>Test Input (ƒë·ªÉ test th·ªß c√¥ng):</h3>
            <input type="text" id="manualTestInput" class="test-input" placeholder="Nh·∫≠p g√¨ ƒë√≥ r·ªìi click Test Th·ªß C√¥ng">
        </div>

        <div>
            <h3>Console Output:</h3>
            <div id="console" class="console-output"></div>
        </div>
    </div>

    <script>
        // Override console.log to display in our custom console
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        const consoleDiv = document.getElementById('console');
        const statusDiv = document.getElementById('status');

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'warn' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '';
            consoleDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function (...args) {
            originalConsoleLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.warn = function (...args) {
            originalConsoleWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        console.error = function (...args) {
            originalConsoleError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        function clearConsole() {
            consoleDiv.textContent = '';
        }

        function updateStatus(message, className) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${className}`;
        }

        async function runManualTest() {
            const input = document.getElementById('manualTestInput');
            const currentValue = input.value;

            console.log('üñ±Ô∏è Manual Test Started');
            console.log('Current input value:', currentValue);

            updateStatus('üîÑ ƒêang ch·∫°y test th·ªß c√¥ng...', 'running');

            // Test filling with new value
            const newValue = 'TEST_' + Date.now();
            console.log('Filling with new value:', newValue);

            const success = await fillInputAdvanced(input, newValue);

            console.log('Test result:', success ? '‚úÖ SUCCESS' : '‚ùå FAILED');
            console.log('Final input value:', input.value);
            console.log('Expected value:', newValue);
            console.log('Values match:', input.value === newValue ? '‚úÖ YES' : '‚ùå NO');

            updateStatus('‚úÖ Test th·ªß c√¥ng ho√†n th√†nh', 'completed');
        }

        async function runAutomaticTests() {
            updateStatus('üîÑ ƒêang ch·∫°y test t·ª± ƒë·ªông...', 'running');

            console.log('üß™ Testing fillInputAdvanced fix...\n');

            // Create test input element
            const testInput = document.createElement('input');
            testInput.type = 'text';
            testInput.placeholder = 'Test Input';
            testInput.name = 'testInput';
            testInput.style.display = 'none'; // Hide it
            document.body.appendChild(testInput);

            let passedTests = 0;
            let totalTests = 5;

            // Test 1: Normal fill
            console.log('üìã Test 1: Normal fill');
            testInput.value = '';
            await fillInputAdvanced(testInput, 'test123');
            const test1Pass = testInput.value === 'test123';
            console.log('Result:', test1Pass ? '‚úÖ PASS' : '‚ùå FAIL');
            if (test1Pass) passedTests++;
            console.log('');

            // Test 2: Fill when input already has value
            console.log('üìã Test 2: Fill when input has existing value');
            testInput.value = 'oldvalue';
            await fillInputAdvanced(testInput, 'newvalue');
            const test2Pass = testInput.value === 'newvalue';
            console.log('Result:', test2Pass ? '‚úÖ PASS' : '‚ùå FAIL');
            if (test2Pass) passedTests++;
            console.log('');

            // Test 3: Fill empty string
            console.log('üìã Test 3: Fill empty string');
            testInput.value = 'somevalue';
            await fillInputAdvanced(testInput, '');
            const test3Pass = testInput.value === '';
            console.log('Result:', test3Pass ? '‚úÖ PASS' : '‚ùå FAIL');
            if (test3Pass) passedTests++;
            console.log('');

            // Test 4: Fill with same value (should skip)
            console.log('üìã Test 4: Fill with same value (should skip)');
            testInput.value = 'samevalue';
            const result = await fillInputAdvanced(testInput, 'samevalue');
            const test4Pass = result === true && testInput.value === 'samevalue';
            console.log('Result:', test4Pass ? '‚úÖ PASS' : '‚ùå FAIL');
            if (test4Pass) passedTests++;
            console.log('');

            // Test 5: Simulate proxy issue scenario
            console.log('üìã Test 5: Simulate proxy issue scenario');

            let proxyValue = 'oldProxyValue';
            const proxyInput = new Proxy(testInput, {
                get(target, prop) {
                    if (prop === 'value') {
                        console.log('   üîç Proxy getter called, returning:', proxyValue);
                        return proxyValue;
                    }
                    return target[prop];
                },
                set(target, prop, value) {
                    if (prop === 'value') {
                        console.log('   üìù Proxy setter called with:', value);
                        proxyValue = value;
                        target.value = value;
                    } else {
                        target[prop] = value;
                    }
                    return true;
                }
            });

            console.log('   Initial proxy value:', proxyInput.value);
            await fillInputAdvanced(proxyInput, 'newProxyValue');
            console.log('   Final proxy value:', proxyInput.value);
            const test5Pass = proxyInput.value === 'newProxyValue';
            console.log('Result:', test5Pass ? '‚úÖ PASS' : '‚ùå FAIL');
            if (test5Pass) passedTests++;
            console.log('');

            // Cleanup
            document.body.removeChild(testInput);

            console.log('üèÅ All tests completed!');
            console.log(`üìä Results: ${passedTests}/${totalTests} tests passed`);

            if (passedTests === totalTests) {
                console.log('üéâ ALL TESTS PASSED! Fix is working correctly.');
                updateStatus('üéâ T·∫•t c·∫£ test ƒë·ªÅu PASS! Fix ho·∫°t ƒë·ªông t·ªët.', 'completed');
            } else {
                console.log('‚ö†Ô∏è Some tests failed. Please check the implementation.');
                updateStatus('‚ö†Ô∏è M·ªôt s·ªë test b·ªã fail. C·∫ßn ki·ªÉm tra l·∫°i.', 'running');
            }
        }
    </script>

    <script src="test-fillInputAdvanced-fix.js"></script>
</body>

</html>